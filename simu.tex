%Remove the word tuning
%Explain how the simulation is working → how to simulate cluster, describe how it is done
%Present what is the situation
%Description of width not so great
%Not put too much emphasis on the other tests
%Tehn found xtalk is responsible
%Cross talk measurement → 
%Limitations
%Then xtalk from MC + ePerADC

\clearpage

\setcounter{secnumdepth}{4}
\chapterwithnum{Silicon strip tracker simulation}
\setcounter{secnumdepth}{5}


\section{CMS simulation}

The simulated samples are vital part of many analyses. For the physics analyses purposes they are used to copmare the theoretical signal and background with the measured data.  Further, the simulations are also important in development and understaning of specific analysis methods and in derivation and valiadation of calibrations, efficiencies and resolutions.

The CMS simulation workflow~\cite{Banerjee:2007zz, Hildreth:2017vpw, Hildreth:2015kps, website:simuBasics } is divided into several steps. At the beginning of the simulation chain the physics events are generated and then the generated final state particles are sent through the simulated detector. Following step is the simulation of response of electron electronics to particle traversing the detector. The otput of this producedure are RAW data, which can be later reconstructed and slimmed for the purposes of physics analyses. The overview of the simulation steps, which will be described in larger detail in following subsections, can be seen in Fig.~\ref{fig:figures/SimulationFlow}~\cite{website:simuBasics}. The production of the simulated samples is handled centrally~\cite{Boudoul:2015bkp} by the CMS collaboration.

    \insertFigure{figures/SimulationFlow} % Filename = label
                 {0.99}       % Width, in fraction of the whole page width
                 { A diagram of simulation workflow. The four-vectors of generated particles together with the detector description enter to the Geant4 simulation which output are simulated hits in the detector volume. Optionally the simulated hits from pile-up interactions can be added on top of the simulated hist from physics and the mixture of these hits are digitized in the electronics simulation. In this step the description of the electronics, for eaxample the noise and detector conditions, for example the temperature, is added. The output of digitization are RAW data~\cite{website:simuBasics}. }

%TODO more about OOT - loopers + electronics

\section{Monte Carlo event generators}

The Monte Carlo~(MC) generators are basic tool designed to produce physics events according to a physics model. In the majority of cases three kinds of generators are used in CMS~\cite{website:generation, website:generationIntro}. 

\textbf{General-purpose generators}
These are for example Pythia8~\cite{Sjostrand:2014zea} or Herwig++~\cite{Bahr:2008pv}. The provide the best possible description of the result of the proton collision. To generate outgoing particles originating from the interaction of colliding particles, many theoretical models and aspects has to be plugged in the generation process, such as the description of soft and hard interactions~(in leading order), parton distribution functions~(PDFs), initial and final state radiation~(ISR and FSR), multiple parton interactions, hadronization of partons and decay of particles~\ref{}.

\textbf{Matrix Element calculators}
The generators such as Powheg~\cite{Oleari:2010nx} or MadGraph5\_aMCatNLO~\cite{Alwall:2014hca} were developed to provide next-to-leading order~(NLO) claculations. These calculators give the final state description on the parton level which needs to be plugged into one of the general-purpos generators to proceed with  the full hadronization.

\textbf{Specific generators}
These genrators are used to generate specific kind of events e.g. diffractive or cosmic events.


\section{Detector simulation}

To be able to compare the data and simulations, the generated particles need  to be propagated through the volume of detector. This is achieved via GEANT4~\cite{Agostinelli:2002hh ,Lefebure:1999wja} toolkit into which detailed description of the CMS detector, its active and dead material dimensions, hierarchy and properties, is plugged. The GEANT4 sends the generated particles through the detector and simulates the interactions with material and modells the physics processes which happen during the passage of the particles through detector. The output of this procedure are simulated hits left by particles interacting with the active volumes of the subdetectors. The simulated hits can originate from primary particles generated by the MC generator, or from the secondary particles which are result of the GEANT4 simulation process.

The simulation of the pile-up events is done separately from the simulation of the events of interests. The input to  the GEANT4 simulation of in-time and out-of-time pile-up is pool of Minimum Bias single interaction events.

This full simulation~(FullSim) is very time intensive and thus it is not suitable to simulate samples for which huge number of events is needed. For this purposes the fast simulation~(FastSim)~\cite{Sekmen:2017hzs, CMS:2010spa, Giammanco:2014bza} was developed as an alternative to the FullSim. The FastSim uses simplified detector geometry and interactions with material, what speeds the simulation by factor of around 100. The comparison of physics objects of FullSim and FastSim shows that FastSim is reliable alternative that reproduces the FullSim with around 10\% accuracy~\cite{Abdullin:2011zz, Sekmen:2017hzs} The FastSim is widely used to produce for example Supersymmetry samples, where large scans with different parameter values are needed. 

\section{Simulation of the detector response to the particle signal}

To obtain clusters, the signal from the GEANT4 and the response of the readout electronics to this signal. This step is called a digitization and its input is merged collection of physics events of interest and pile-up events. There are three domains providing digitization of given siubdetectors, which are SimTracker, SimCalorimetry and SimMuon~\cite{iwebsite:simdigi}. The digitized saples are in the RAW format and can be further reconstrcuted in a similar way as data.

\section{Simulation of the silicon strip tracker to the particle signal}

In order to be able to use the simulated samples for the physics analyses puroposes and to be able to rely on them, the simulated samples have to describe the data as well as possible. In case of tracker, the output of the standard simulation are Zero Suppressed data, which are further reconstructed into clusters during the reconstruction step. These clusters are used for tracking and physics objects reconstruction, therefore best possible description of data by simulated samples at clusters level is vital.

In following figures, data and simulation comparison of several important clustaer quantities is shown. For the comparison, the zero bias data sample is from run 305064 and fill 6298, is used. The produced simulated sample is minimum biasi produced in FullSim configuration. Both data and simulaten were produced in deconvolution mode. To avoid fake clusters and clusters originating from pile-up, only clusters associated with tracks are used to create plots in whole chapter.
 
The cluster charge collected by one module divided by length of track in sensor, further referred as cluster charge, is shown in Fig.~\ref{fig:figures/clusterchargeRescaledalll0to0}. The data to simulation ratio fluctuates around one within around $\pm 10\%$ in the bulk of  the cluster charge distribution, but the description worsens for very small and very large cluster charges.

    \insertFigure{figures/clusterchargeRescaledalll0to0} % Filename = label
                 {0.5}       % Width, in fraction of the whole page width
                 { (top) Data and simulation  comparison of cluster charge. The simulated distribution is rescaled to number of clusters in data. (bottom) Data to simulation ratio of cluster charge distributions. }

The cluster width depends on the sensor geometry and therefore has to be shown separately for different geometries. The possible geometries and their location can be found in Tab.~\ref{tab:trackerGeometries}. The data to simualtion comparison for inner and ouer barrel geomtries is shown in Figs.~\ref{fig:figures/widthTOB}~and~\ref{fig:figures/widthTIB}. In all cases there is very poor description of cluster width in data by the simulation. The mentioned dependency of cluster width on the geometry can be seen when comparing cluster width between IB1 and IB2 in Fig.~\ref{figures/widthTIB}. The IB1 sensors have smaller pitch with respect to IB2 and therefore the IB1 clusters arei in average wider. The sensors of IB2 and OB1 have similar pitch, but OB1 sensors are thicker which leads to larger cluster width than in case of IB2, because the particle path in a sensor is longer. Morover the cross talk is larger for OB1 than IB2, leading to larger enhancement in OB1 cluster width compared to IB2.

    \insertTwoFigures{figures/widthTOB} % Filename = label
                 {figures/clusterwidthTOBl1to4}
                 {figures/clusterwidthTOBl5to6} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {(left top) Data and simulation  comparison of cluster width for OB2 geometry. The simulated distribution is rescaled to number of clusters in data. (left bottom) Data to simulation ratio of cluster width distributions for OB2 geometry. (right top) Data and simulation  comparison of cluster width for OB1 geometry. The simulated distribution is rescaled to number of clusters in data. (right bottom) Data to simulation ratio of cluster width distributions for OB1 geometry. }

    \insertTwoFigures{figures/widthTIB} % Filename = label
                 {figures/clusterwidthTIBl1to2}
                 {figures/clusterwidthTIBl3to4} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {(left top) Data and simulation  comparison of cluster width for IB2 geometry. The simulated distribution is rescaled to number of clusters in data. (left bottom) Data to simulation ratio of cluster width distributions for IB2 geometry. (right top) Data and simulation  comparison of cluster width for IB2 geometry. The simulated distribution is rescaled to number of clusters in data. (right bottom) Data to simulation ratio of cluster width distributions for IB2 geometry. }

%TODO seed charge

Thus in general, the simulation tend to overestimate the cluster width, but on the other hand underestimate the charge of the seed strip. Overall the simulation of cluster charge agree with data within $\pm$10\% over a wide range of cluster charges.

To understand how the clusters are simulated and what part of simulation can lead to incorrecti cluster simulation, first the simulation flow has to be described. To simulate clusters in the tracker, first the GEANT4 energy deposits have to be converted to charge carriers and then propagated through the sensor to the strips. To achieve good data and simulation agreement, the propagation has to be corrected for effects which happen physcially in the sensor, for example a diffusion. Other set of factors is applied on top of the simulated signal to mimic effects of electronics on the signal acquired during the data-taking. Signal with all corrections applied, is digitized. In the following subsections these steps are described in detail, and later, potential issues in the simulation approach are indentified and discussed.


\subsection{Simulation (digitization) steps}

\subsubsection{GEANT4 output}

A simulated hit in the tracker produced by GEANT4 is stored in class called CMSTrackerHit~\cite{Lefebure:1364020}. The CMSTrackerHit is created for each particle entering tracker and for each sensitive detector unit. In case of silicon strip tracker one sensitive detector unit is one side of sensors of one module. The CMSTrackerHit stores information about particle entry and exit point in the reference system of the detector unit, the energy of an particle at an entrance point, total amount of energy deposited in the detector unit, the time for which particle existed before it entered detector unit and the identification of detector unit and the track. A sketch of a detector unit and information stored by GEANT4 is shown in Fig.~\ref{fig:figures/geantDeposit}. In later text, the detector unit will be reffered as module.

    \insertFigure{figures/geantDeposit} % Filename = label
                 {0.5}       % Width, in fraction of the whole page width
                 { The sketch of information saved for each simulated hit by GEANT4. The hits are stored per detector unit~(DetID) and track~(trackID) and besides DetID and trackID they contain entry energy~($E_{ent}$), total energy deposited~($E_{loss}$), the time paricle has been alive before enetering the unit~(TOF) and the entry and exit point of the particle in the local frame~($(x_{i},y_{i},z_{i})$). REMARK: ADD CITATION HERE?}
%~\cite{website:simuBasics}. }

\subsubsection{Divide energy deposit}

The GEANT4 hit stores the point-like total energy deposited in one module. Depending on the arrival time of particle to the module, different fraction of the charge will be read. Later the particle arrives, smaller fraction of charge is collected. To determine the delay of particle with respect of particle going at speed-of-light, time of filight of particle to given module is compared with time-of-fligt of photon to that module. According to delay between particle and photon it is determined, how far from the maximum of the  peak or deconvolution puls shape the particle signal is read and consequently the charge deposited is reduced between the puls shape value at maximum and reading time. The shchema of this time response to the signal can be seen in Fig.~\ref{fig:figures/timeResponse}.


    \insertFigure{figures/timeResponse} % Filename = label
                 {0.5}       % Width, in fraction of the whole page width
                 { }

In the real data-taking the energy deposition is not point-like, but the track looses its energy continuously as it traverses the module. To mimic this, the track is divided to a certain number of equdistand segments. Currently the number of sectors is evaluated as a fixed factor multiplied by expected number of strips reading a signal. The rescaled total charge is then divided to the track segments and for each segment is fluctuated according Landau function. The fluctuated charge per segment is then nomrlized to keep the sum of the segment energies equal to the intial energy loss. The local corrdinates of the track segment together with the fluctuated normalized energy deposit is saved in energy deposit unit.


%TODO draw diagram at the end
%puls shape figure
%ISSUES
%puls shape problems - puls shape same for all strips (actually reveighted at once), does not have any undershoot, is pretty outdated from here CMS NOTE 2007/027
%charge division itself, eloss does not have to be linear
%delta rays are missing (maybe): delta cutoff in MeV, has to be same as in Geant (0.120425 MeV corresponding to 100um range for electrons)
%are not puls shapes difefrent for thick and thin sensors??

\subsubsection{Charge drift}

%TODO holes propagates to strips
A particle passing through the module is depositing its energy via ionization of the silicon volume. The created charge carriers then drift to the electrodes. Therefore to describe the reality, in simulation, the energy deposits, repectively charge, have to be propagated separately from each track segment to the strips. As in the barrel regions the electric field is perpendicular to the magnetic field, the drift of the charge carriers is deflected from the direction of electric field, respectively local z-axis, by the Lorentz angle. Therefore the drift direction of the charges towards the surface of sensor must be corrected accordingly to the Lorentz angle and the local magnetic field. Morover the change carriers undergo diffusion in the silicon volume during the drift and therefore a charge from each point like segment will be at the surface collcted smeared due to diffucssion effects. To estimate the difussion, first the a drift time from the track segment to the sensor surface is comupted. This drift time depends on:

\begin{itemize}
\item Sensor thickness: the drift time is longer for thicker sensors
\item Depletion and applied voltage: influence how fast the charge carriers drift
\item Charge mobility: influence how fast the charge carriers drift, for example mobility of holes is lower than electrons
\item Coordinates of the track segment: used to determine distance charge has to drift through
\item Charge distribution RMS: no idea %TODO ask
\end{itemize}

The width of cahrge distribution is then computed from the knowledge of the drift time and a difussion constant. The diffusion constant depends on the type of material the charge drifts through and the temperature of the environment. The enrgy units after applying the drift and diffusion procedure are stroed as signal points, with information about its coordinates at the surface, the energy and its spread.

%TODO finish this
%charge is induced also by electrons
%charge is beiing induced - no cross talk due to induction.
%point-like track segment - spread i  charge should be already there...
%temperature changes with time
%lorentz angle changes as well because of different voltage
%ultimately the voltage itself play a large role

\subsubsection{Induce charge on the strips}

Once the energy deposits in form of charge are collected on the surface, it must be simulated how much of charge is read by given strip. The charge cannot be divided between strip purely based on the geometrical critearia, due to the the capacitive coupling between strips. The capacitive coupling causes that, in the case of deconvolution mode, the charge collected by one strip is partially shared with its first and second neighbouring strip on both sides. In the peak mode, only sharing between the first neighboring strip on eeach side is observed.   

%more about xtalk, picture

The signal point at surface is associated to the closest strip. The charge converted from energy to number of electrons, is then divided between the neighboring strips acording the charge spread orifinating from diffusion. This is done dor all signal points and after this and in case that to one strip obtains signal from more signal points, these deposits are summed. Now each strip has its assigned charged, on which the cross talk effect has to be applied. The simulation interates over all strips from left to right, and shares the charge of a given strip in between neighbors.

\subsubsection{Final digitization}

To finilaze the event few more efects must be considered. First, in the detector, several strips are dead. The information about dead channels is stored i  the databe, read by the simulation, and simulated charge on these channels is set to zero. Secondly, to mimic real conditions, the realistic noise has to be added to each strip. The noise per each strip is determined with use of data [TODO how], stored in database, and for needs of simulation read from there. The noise is storead in ADC, therefore it has to be converted to the electrons. Morover because of differences between modules in detector, the noise has to be rescaled by gains of given modules. The summed signal and noise on the strips in electrons is then converted to ADC and scaled by gain to mimic output from the detector. The simulated data in ADC and then Zero Supperssed and stroed in form as digis. 
 
%TODO G1, G2, Gsim
%TODO all the hits are accumulated for each evet!
%TODO write something about database
%TODO say that the procuder can be amd emore difficult by adding pile up
 
%in reallity not like this at all, the carriers drift and induce charge
%association to the closest strip - well if the center is close to middle, this is dangerous
%cross talk not correct on the edges, first and last strips
%no dynamics, sequential cross talk

\subsubsection{Other features of simulation}
-PU
-VR

\subsection{Potential problems}
A) Geant 4:~\cite{Lefebure:1364020}
CMSTrackerHit
One CMSTrackerHit object is created
for each new particle entering a Tracker-like component (delta-rays are considered as new particles)
for each sensitive detector unit
The information provided by the CMSTrackerHit class is:
1) the entry and exit point of the particle in the local reference frame of the detector unit,
2) the energy of the particle when it enters the detector unit,
3) the identification of the track and of the detector unit,
4) the time that the particle has been alive until it enters the detector,
5) the total amount of energy deposited by the particle along its trajectory in the detector.
-> only the total charge is recorded  (though energy deposited on subsections is simulated)

    \insertFigure{figures/geantDeposit} % Filename = label
                 {0.5}       % Width, in fraction of the whole page width
                 { ~\cite{website:simuBasics}. }


B) charge collection (CR2009\_338)
- track in sensitive volume is divided into small segments of the same size (compared to the sensor thickness)
-the energy is divided between these segments and for each segment the energy depesition is fluctuated by a GEANT4 routine (Sample fluctuations), the fluctuated charge is normalized to give the original total charge
-this is done to take into account the landau fluctuations
-the charge(energy) from each track segment is drifted towards strips/backplane
- there is a diffusion of the charge in the perpendicular(ask?) plane
- the drift is not straight but as mg. field is present, the charge carriers are deflected -> injected knowledge about the lorentz angle
- the collected charge is multiplied by gains and converted to the ADCs
- inject interstrip cross-talk to change the resolution of clusters and tracks - charge collected by neighbors (ask before or after ePerADC?)
-then zero-suppression

C)Flow(from Nuttens slides)
- signal from GEANT4
-divide charge deposit (SiLinearcChargeDivider.cc)
	-hypotheses
	-particle goes straight (ask? meaning the track goes straight?)
	-linear division -> dE/dx constant
	-peak of collected charge is same for all strips colelcting charge
	-secondaries, deltra rays not modelled
        -different width for pions and protons, not simukated? (ask?)
-diffusion
	-gaussian smearing of the drifted charge (and an arrival surface)
	-small compared to the pitch size -> unlikely that it is large source of discrepancies
	-electric field depends linearly on z
	- no radiation damage (no traps)
	-both charge carriers not considered (holes and electrons) - both should induce charge right?!
-Cross-talk (SiTrivialInduceCahrgeOnStrip.cc)
-Remove dead channels <-database (SiStripDigitizerAlgorithm.cc, write something about condition databasei and global tag)
-APV killer for HIP (SiStripDigitizerAlgorithm.cc, VR only)
-baseline shift (VR only, SIGaussianiTailNoiseAdder.cc)
-baseline tilt (VR only)
-Noise <- database (SiGaussianNoiseAdder.cc)
-Gain at APV level <- database (SITRivialDigitalConverter.cc)
-CMN (VR only, SiGaussianiTailNoiseAdder.cc)
-Pedestal <- database (VR only, SIGaussianiTailNoiseAdder.cc)
-Digitization - in zero suppression mode adding a noise pers strip (including saturation SiStripDigitizerAlgorithm, SiStripDigitizer)
-to be reconstructed

-parameters in simulation picture, + highligt the ones which can chhange with time
-several changes in the detector

a) temperature
- used in difussion constant evaluation -> this constant is used to compute the drift time of the charge carriers in the sensor
-charge drift is one of the forst steps
-temperature of detector changed several times (in 2015 to -20, in to 2018 to ask?)
(-more parameters used in simu are probably temperature dependent!)

b)depletion and applied voltage
SiHitDigitizer.cc
double timeNormalisation = (moduleThickness*moduleThickness)/(2.*depletionVoltage*chargeMobility);
SiLinearChargeCollectionDrifter.cc (drift time in the sensor)
double driftTime = -timeNormalisation*log(1.-2*depletionVoltage*thicknessFraction/(depletionVoltage+appliedVoltage))+chargeDistributionRMS; 
-> the drift time is dependent on dpeletion and applied voltage!!!
SignalPoint drift (EnergyDepositUnit edu, Localvector drift, moduleThickness, timeNormalisation)

c) noise
Noise in ZeroSuppression inputs:
void addNoise(std::vector<double> &in,size\_t& minChannel, size\_t& maxChannel, int numStrips, float noiseRMS)
where noiseRMS used in: noiseRMS*theElectronPerADC/gainValue; gain and noiseRMS from database, describe what are the Gain values (G1, G2, GSim) -> in here it looks like it is gsim
genNoise->generate(numStrips, threshold, noiseRMS, generatedNoise); genNoise(new GaussianTailNoiseGenerator(rndEngine)); <- is it there, what does it do?

d) gains
-used when adding noise
-used when converting to ADC
DigitalVecType convert(const std::vector<double>& analogSignal, edm::ESHandle<SiStripGain> \&gainHandle, unsigned int detid)
-again changes with time

e) coupling (cross talk)
- can differ beacuse of aging of detector?
double chargeDeposited(size\_t strip,size\_t Nstrips,double amplitude,double chargeSpread,double chargePosition)
Determine integral and fraction of signal
-integralUpToStrip = (strip == 0) ? 0. : (normal\_cdf( strip, chargeSpread, chargePosition) );
-integralUpToNext = (strip+1 == Nstrips) ? 1. : ( normal\_cdf( strip+1, chargeSpread, chargePosition) );
-percentOfSignal = integralUpToNext - integralUpToStrip;
-return percentOfSignal * amplitude / geVperElectron
charge spread depends on applied and depletion voltage

void induce(collection\_type collection\_points,StripGeomDetUnit det,localAmplitudes,size\_t recordMinAffectedStrip, size\_t recordMaxAffectedStrip,TrackerTopology *tTopo)
-loop over all signal points 
-for each signal point define chargePosition(from signalpoint); first and until strip (chargePоsition±Nsigma*chargeSpread )
-the loop over strips 
-compute charge depositied on strip =chargeDeposited( strip, Nstrips, signalpoint->amplitude(), chargeSpread, chargePosition)
-Strip range affected by deposit (affectedFromStrip, affectedUntilStrip) -> loop over affected strips to apply induce charge
	-affectedStrip(localAmplitude)  += chargeDepositedOnStrip * coupling.at(abs( affectedStrip - strip ))


f) pulse and deco shapes are hardcoded (timing)
-rescale  the signal by looking to the puls shape response (TkPulsShape.h & parametrization.C)
-not updated after change of APV settings (VFP)
-no convolution with input signal
-1/2 ns delay in maxima of puls shape between neighboring strips

g)lorentz angle
-drift direction compu


%magnetic field setting

%in detector dir
%TS2018_001_2 -> MC generators, detector simulatios
%CERN-THESIS-2017-300 - Event simulation
%TS2017_028_2 - simulation super short
