%Remove the word tuning
%Explain how the simulation is working → how to simulate cluster, describe how it is done
%Present what is the situation
%Description of width not so great
%Not put too much emphasis on the other tests
%Tehn found xtalk is responsible
%Cross talk measurement → 
%Limitations
%Then xtalk from MC + ePerADC

\clearpage

\setcounter{secnumdepth}{4}
\chapterwithnum{Silicon strip tracker simulation}
\setcounter{secnumdepth}{5}


\section{CMS simulation}

The simulated samples are vital part of many analyses. For the physics analyses purposes they are used to copmare the theoretical signal and background with the measured data.  Further, the simulations are also important in development and understaning of specific analysis methods and in derivation and valiadation of calibrations, efficiencies and resolutions.

The CMS simulation workflow~\cite{Banerjee:2007zz, Hildreth:2017vpw, Hildreth:2015kps, website:simuBasics } is divided into several steps. At the beginning of the simulation chain the physics events are generated and then the generated final state particles are sent through the simulated detector. Following step is the simulation of response of electron electronics to particle traversing the detector. The otput of this producedure are RAW data, which can be later reconstructed and slimmed for the purposes of physics analyses. The overview of the simulation steps, which will be described in larger detail in following subsections, can be seen in Fig.~\ref{fig:figures/SimulationFlow}~\cite{website:simuBasics}. The production of the simulated samples is handled centrally~\cite{Boudoul:2015bkp} by the CMS collaboration.

    \insertFigure{figures/SimulationFlow} % Filename = label
                 {0.99}       % Width, in fraction of the whole page width
                 { A diagram of simulation workflow. The four-vectors of generated particles together with the detector description enter to the Geant4 simulation which output are simulated hits in the detector volume. Optionally the simulated hits from pile-up interactions can be added on top of the simulated hist from physics and the mixture of these hits are digitized in the electronics simulation. In this step the description of the electronics, for eaxample the noise and detector conditions, for example the temperature, is added. The output of digitization are RAW data~\cite{website:simuBasics}. }

%TODO more about OOT - loopers + electronics

\subsection{Monte Carlo event generators}

The Monte Carlo~(MC) generators are basic tool designed to produce physics events according to a physics model. In the majority of cases three kinds of generators are used in CMS~\cite{website:generation, website:generationIntro}. 

\textbf{General-purpose generators}
These are for example Pythia8~\cite{Sjostrand:2014zea} or Herwig++~\cite{Bahr:2008pv}. The provide the best possible description of the result of the proton collision. To generate outgoing particles originating from the interaction of colliding particles, many theoretical models and aspects has to be plugged in the generation process, such as the description of soft and hard interactions~(in leading order), parton distribution functions~(PDFs), initial and final state radiation~(ISR and FSR), multiple parton interactions, hadronization of partons and decay of particles~\ref{}.

\textbf{Matrix Element calculators}
The generators such as Powheg~\cite{Oleari:2010nx} or MadGraph5\_aMCatNLO~\cite{Alwall:2014hca} were developed to provide next-to-leading order~(NLO) claculations. These calculators give the final state description on the parton level which needs to be plugged into one of the general-purpos generators to proceed with  the full hadronization.

\textbf{Specific generators}
These genrators are used to generate specific kind of events e.g. diffractive or cosmic events.


\subsection{Detector simulation}

To be able to compare the data and simulations, the generated particles need  to be propagated through the volume of detector. This is achieved via GEANT4~\cite{Agostinelli:2002hh ,Lefebure:1999wja} toolkit into which detailed description of the CMS detector, its active and dead material dimensions, hierarchy and properties, is plugged. The GEANT4 sends the generated particles through the detector and simulates the interactions with material and modells the physics processes which happen during the passage of the particles through detector. The output of this procedure are simulated hits left by particles interacting with the active volumes of the subdetectors. The simulated hits can originate from primary particles generated by the MC generator, or from the secondary particles which are result of the GEANT4 simulation process.

The simulation of the pile-up events is done separately from the simulation of the events of interests. The input to  the GEANT4 simulation of in-time and out-of-time pile-up is pool of Minimum Bias single interaction events.

This full simulation~(FullSim) is very time intensive and thus it is not suitable to simulate samples for which huge number of events is needed. For this purposes the fast simulation~(FastSim)~\cite{Sekmen:2017hzs, CMS:2010spa, Giammanco:2014bza} was developed as an alternative to the FullSim. The FastSim uses simplified detector geometry and interactions with material, what speeds the simulation by factor of around 100. The comparison of physics objects of FullSim and FastSim shows that FastSim is reliable alternative that reproduces the FullSim with around 10\% accuracy~\cite{Abdullin:2011zz, Sekmen:2017hzs} The FastSim is widely used to produce for example Supersymmetry samples, where large scans with different parameter values are needed. 

\subsection{Simulation of the detector response to the particle signal}

To obtain clusters, the signal from the GEANT4 and the response of the readout electronics to this signal. This step is called a digitization and its input is merged collection of physics events of interest and pile-up events. There are three domains providing digitization of given siubdetectors, which are SimTracker, SimCalorimetry and SimMuon~\cite{iwebsite:simdigi}. The digitized saples are in the RAW format and can be further reconstrcuted in a similar way as data.

\newpage

\section{Simulation of the silicon strip tracker response to the particle signal}

In order to be able to use the simulated samples for the physics analyses puroposes and to be able to rely on them, the simulated samples have to describe the data as well as possible. In case of tracker, the output of the standard simulation are Zero Suppressed data, which are further reconstructed into clusters during the reconstruction step. These clusters are used for tracking and physics objects reconstruction, therefore best possible description of data by simulated samples at clusters level is vital.

In following figures, data and simulation comparison of several important clustaer quantities is shown. For the comparison, the zero bias data sample is from run 305064 and fill 6298, is used. The produced simulated sample is minimum biasi produced in FullSim configuration. Both data and simulaten were produced in deconvolution mode. To avoid fake clusters and clusters originating from pile-up, only clusters associated with tracks are used to create plots in whole chapter.
 
The cluster charge collected by one module divided by length of track in sensor, further referred as cluster charge, is shown in Fig.~\ref{fig:figures/clusterchargeRescaledalll0to0}. The data to simulation ratio fluctuates around one within around $\pm 10\%$ in the bulk of  the cluster charge distribution, but the description worsens for very small and very large cluster charges. Overall the cluster charge distribution is more narrow than in data. 

    \insertFigure{figures/clusterchargeRescaledalll0to0} % Filename = label
                 {0.5}       % Width, in fraction of the whole page width
                 { (top) Data and simulation  comparison of cluster charge. The simulated distribution is rescaled to number of clusters in data. (bottom) Data to simulation ratio of cluster charge distributions. }

The cluster width depends on the sensor geometry and therefore has to be shown separately for different geometries. The possible geometries and their location can be found in Tab.~\ref{tab:trackerGeometries}. The data to simualtion comparison for inner and ouer barrel geomtries is shown in Figs.~\ref{fig:figures/widthTOB}~and~\ref{fig:figures/widthTIB}. In all cases there is very poor description of cluster width in data by the simulation. The mentioned dependency of cluster width on the geometry can be seen when comparing cluster width between IB1 and IB2 in Fig.~\ref{figures/widthTIB}. The IB1 sensors have smaller pitch with respect to IB2 and therefore the IB1 clusters are in average wider, as in case of IB1 larger number of strips would collect charge from the same track. The sensors of IB2 and OB1 have similar pitch, but OB1 sensors are thicker which leads to larger cluster width than in case of IB2, because the particle path in a sensor is longer. Morover the cross talk is larger for OB1 than IB2, leading to larger enhancement in OB1 cluster width compared to IB2.

    \insertTwoFigures{figures/widthTOB} % Filename = label
                 {figures/clusterwidthTOBl1to4}
                 {figures/clusterwidthTOBl5to6} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {(left top) Data and simulation  comparison of cluster width for OB2 geometry. The simulated distribution is rescaled to number of clusters in data. (left bottom) Data to simulation ratio of cluster width distributions for OB2 geometry. (right top) Data and simulation  comparison of cluster width for OB1 geometry. The simulated distribution is rescaled to number of clusters in data. (right bottom) Data to simulation ratio of cluster width distributions for OB1 geometry. }

    \insertTwoFigures{figures/widthTIB} % Filename = label
                 {figures/clusterwidthTIBl1to2}
                 {figures/clusterwidthTIBl3to4} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {(left top) Data and simulation  comparison of cluster width for IB2 geometry. The simulated distribution is rescaled to number of clusters in data. (left bottom) Data to simulation ratio of cluster width distributions for IB2 geometry. (right top) Data and simulation  comparison of cluster width for IB2 geometry. The simulated distribution is rescaled to number of clusters in data. (right bottom) Data to simulation ratio of cluster width distributions for IB2 geometry. }

The other important quantity describing cluster, is charge of the strip reading the most of the charge from all strips in cluster rescaled to track path in sensor, which is later reffered as cluster seed charge.The cluster seed chargei in Figs.~\ref{seedTOB}~and~\ref{seedTIB} is again dependent on the module geometry and therefore is shown for four different geometries. In the plots it can be seen that in all cases the simulation in average predicts lower cluster seed charge and there is a clean trend in data to simulation ratio. It can be als observed thato with larger pitch, the seed charge increases as the charge from larger part of sensitive volume is read by one strip. Moreover difference for IB2 and OB1 are observed. These two ahve simillar pitch size, but the cross talk is larger for OB2, leading to smaller seed charge.

    \insertTwoFigures{figures/seedTOB} % Filename = label %TDO continue here
                 {figures/clusterseedchargeRescaledTOBl1to4}
                 {figures/clusterseedchargeRescaledTOBl5to6} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {(left top) Data and simulation  comparison of cluster seed charge for OB2 geometry. The simulated distribution is rescaled to number of clusters in data. (left bottom) Data to simulation ratio of cluster seed charge distributions for OB2 geometry. (right top) Data and simulation  comparison of cluster seed charge for OB1 geometry. The simulated distribution is rescaled to number of clusters in data. (right bottom) Data to simulation ratio of cluster seed charge distributions for OB1 geometry. }

    \insertTwoFigures{figures/seedTIB} % Filename = label %TDO continue here
                 {figures/clusterseedchargeRescaledTIBl1to2}
                 {figures/clusterseedchargeRescaledTIBl3to4} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {(left top) Data and simulation  comparison of cluster seed charge for OB2 geometry. The simulated distribution is rescaled to number of clusters in data. (left bottom) Data to simulation ratio of cluster seed charge distributions for OB2 geometry. (right top) Data and simulation  comparison of cluster seed charge for OB1 geometry. The simulated distribution is rescaled to number of clusters in data. (right bottom) Data to simulation ratio of cluster seed charge distributions for OB1 geometry. }

To summarize, in general the simulation tend to overestimate the cluster width, but on the other hand underestimate the charge of the seed strip. Overall the simulation of cluster charge agree with data within $\pm$10\% over a wide range of cluster charges.  

To understand how the clusters are simulated and what part of simulation can lead to incorrecti cluster simulation, first the simulation flow has to be described. To simulate clusters in the tracker, first the GEANT4 energy deposits have to be converted to charge carriers and then propagated through the sensor and collected by the strips. To achieve good data and simulation agreement, the propagation has to be corrected for effects which happen physcially in the sensor, for example a diffusion. Other set of factors is applied on top of the simulated signal to mimic effects of electronics on the signal acquired during the data-taking. Signal with all corrections applied, is digitized. The flow of the simulation steps is shown in Fig.~\ref{fig:trackerSimulationFlow}. In the following subsections these steps are described in detail, and later, potential issues in the simulation approach are indentified and discussed. Later, for simplicity, in majority of cases the cluster seed and with distributions are shown only for OB2. As the standard data-taking mode is Zero Supperssion with APVs operating in deconvolution mode, the simualtion steps are described in these conditions. Other possibiltites will be shortly discussed as well.

    \insertFigure{figures/trackerSimulationFlow} % Filename = label
                 {0.99}       % Width, in fraction of the whole page width
                 { A diagram of the of te simulation steps in the CMS tracker. The energy deposited produced by GEANT4 is divided into track segments and drifted towards the strips. Then the charge is induces on strips and the dead channels are removed. On top of the signal the noise is added. The resulting signal is converted to digis and zero suppressed. }

\subsection{Signal simulation steps}

%TODO naming convention! digitization or simulation?

\subsubsection{GEANT4 output}

A simulated hit in the tracker produced by GEANT4 is stored in class called CMSTrackerHit~\cite{Lefebure:1364020}. The CMSTrackerHit is created for each particle entering tracker and for each sensitive detector unit. In case of silicon strip tracker one sensitive detector unit is one side of sensors of one module. The CMSTrackerHit stores information about particle entry and exit point in the reference system of the detector unit, the energy of an particle at an entrance point, total amount of energy deposited in the detector unit, the time for which particle existed before it entered detector unit and the identification of detector unit and the track. A sketch of a detector unit and information stored by GEANT4 is shown in Fig.~\ref{fig:figures/geantDeposit}. In later text, the detector unit will be reffered as module.

    \insertFigure{figures/geantDeposit} % Filename = label
                 {0.5}       % Width, in fraction of the whole page width
                 { The sketch of information saved for each simulated hit by GEANT4. The hits are stored per detector unit~(DetID) and track~(trackID) and besides DetID and trackID they contain entry energy~($E_{ent}$), total energy deposited~($E_{loss}$), the time paricle has been alive before enetering the unit~(TOF) and the entry and exit point of the particle in the local frame~($(x_{i},y_{i},z_{i})$). REMARK: ADD CITATION HERE?}
%~\cite{website:simuBasics}. }

\subsubsection{Divide energy deposit}

The GEANT4 hit stores the point-like total energy deposited in one module. Depending on the arrival time of particle to the module, different fraction of the charge will be read. Later the particle arrives, smaller fraction of charge is collected. To determine the delay of particle with respect of particle going at speed-of-light, time of filight of particle to given module is compared with time-of-fligt of photon to that module. According to delay between particle and photon it is determined, how far from the maximum of the  peak or deconvolution puls shape the particle signal is read and consequently the charge deposited is reduced between the puls shape value at maximum and reading time. The shchema of this time response to the signal can be seen in Fig.~\ref{fig:figures/timeResponse}.


    \insertFigure{figures/timeResponse} % Filename = label
                 {0.5}       % Width, in fraction of the whole page width
                 { The puls shape plugged into the simulation. The 0~ns correspond to the reference time, when all charge is collected.  }

In the real data-taking the energy deposition is not point-like, but the track looses its energy continuously as it traverses the module. To mimic this, the track is divided to a certain number of equdistand segments. Currently the number of sectors is evaluated as a fixed factor multiplied by expected number of strips reading a signal. The rescaled total charge is then divided to the track segments and for each segment is fluctuated according Landau function. The fluctuated charge per segment is then nomrlized to keep the sum of the segment energies equal to the intial energy loss. The local corrdinates of the track segment together with the fluctuated normalized energy deposit is saved in energy deposit unit.

In this procedure there are several simplification which can lead to discrepancies in properties of simulated and generated clusters. The GEANT4 provides only the total charge deposited, therefore the charge has to be divided between the discreet and equidistant tracks segments, what is still not corresponding to reallity. Moreover it is assumed that the energy loss is constant along the track, but in reality there is an evolution of the energy loss with the particle momentum.

The charge of each track segment is being fluctuated by GEANT4 routine. This routine is initiazed with a parameter specifing a cutoff on the delta ray production. The delta rays are already part of previous GEANT4 output and therefore this cutoff has to be the same one as the one in the previous step in order to avoid mismatch. The dependency of cluster charge, cluster seed charge and cluster width on the deltra ray cutoff, which was varied up to $\pm 20\%$ around its default value of 0.120425, is shown in Figs.~\ref{fig:figures/clusterchargeRescaledalll0to0DeltaProdCut}~and~\ref{fig:figures/seedwidthTOBDeltaProdCut}. From the figures it can be concluded that in the given range of the cutoff variation, the change of distributions of the cluster properties is almost neglilible. 

    \insertFigure{figures/clusterchargeRescaledalll0to0DeltaProdCut} % Filename = label
                 {0.5}       % Width, in fraction of the whole page width
                 { (top) Data and simulation comparisons of cluster charge. The default simulation (in red) was modified by injecting four different values of the delta ray production cutoff. All the simulated distribution are rescaled to number of clusters in data. (bottom) Data to simulation ratios of cluster charge distributions. }

    \insertTwoFigures{figures/seedwidthTOBDeltaProdCut} % Filename = label %TDO continue here
                 {figures/clusterwidthTOBl1to4DeltaProdCut}
                 {figures/clusterseedchargeRescaledTOBl1to4DeltaProdCut} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {(left top) Data and simulation  comparisons of cluster width for OB2 geometry. The default simulation (in red) was modified by injecting four different values of the delta ray production cutoff. All simulated distributions are rescaled to number of clusters in data. (left bottom) Data to simulation ratios of cluster width distributions for OB2 geometry. (right top) Data and simulation  comparisons of cluster seed charge for OB2 geometry. The default simulation (in red) was modified by injecting four different values of the delta ray production cutoff. All simulated distributions are rescaled to number of clusters in data. (right bottom) Data to simulation ratios of cluster seed charge distributions for OB2 geometry. }


The deconvolution puls shape used in simulation, presented in Fig.~\ref{fig:figures/timeResponse}, was determined by parametrization of results obtained in~\cite{Delaere:1061284}. These results were obtained from laster tests of the TOB modules. Fig.~\ref{fig:figures/timeResponseReal} presents the results, when single srip was hit by the laser. In this plot the resulting puls shape from the hit strip and two neighbors on each side is shown. The neigboring strips have non-zero charge purely due to the cross talk effect. As mentioned in pervious chapter, there are two main sources of cross talk. First is caused by the fact, that when charge carriers are moving inside the sensor, they are inducing charge on more strips, not only the hit one. The second source is electronis cross talk which is result of coupling strips via inter-strip capacitance as shown in Fig.~\ref{fig:figures/capacitanceNetwork}. 

%By default, cross talk in this chapter means capacitive coupling between strips.

It can be noticed that there are eveveral differences between the puls shapes. First, the maxima of puls shapes are not same for the hit strip and for its neighbor. This fact is ommited from the simulation. Secondly, the puls shape can have negative values in reallityt, while it is not a case for simulation. Thirdly a puls shape does not take into account the charge trapping in the sensors induced by radiation or any other aging efects of the modules of the CMS tracker. Moreover in 2016 the VFP parameter changed in order to avoid saturation of electronics, which resulted in a change of the puls shape~\cite{website:vfp}. This change did not propagate into the simulation.

Furthemore there is a large part of dynamics which modifies the puls shaped not modelled in the simulation. The cross talk originating from movement of the charge carriers is not considered. On top of that the only charge carriers which are present in the simalution are holes which drift to the strips, but presence of electrons is ommited.

In 2009 a discrepancies between cluster position in the peak and deconvolution were observed~\cite{website:backplane}.It was found out, that the disagreement is worse for thick sensors and soon the problem was identified as an issue with charge collection from whole sensor. In the deconvolution mode the charge carriers which are created close to backplane are not read as efficiently as those produced close to strips. Effectively, the material close to backplane is dead and the cluster position is shifted with respect to the peak data, where such problem is not present. To correct the cluster position betveen peak and deconvolution data, a correction called ``backplane correction'' is applied on top of deconvolution data during the reconstruction step. As in the deconvolution mode effectively the strip sensor is thinner and therefore the track shorter, this effect does not only have an effect on cluster position, but also on cluster charge and cluster width. Again, this effect is not considered in simulation.

% TODO are not puls shapes difefrent for thick and thin sensors??
%TODO draw diagram at the end of teh steps
%ISSUES
%puls shape problems - puls shape same for all strips (actually reveighted at once), does not have any undershoot, is pretty outdated from here CMS NOTE 2007/027
%charge division itself, eloss does not have to be linear
%delta rays are missing (maybe): delta cutoff in MeV, has to be same as in Geant (0.120425 MeV corresponding to 100um range for electrons)
%puls shape -> must take into account the drift time of holes
% Automatically generated using parametrizePulse::generateCode(low=-30, high=35, step=0.1)
% That pulse shapes correspond to the ones described in CMS NOTE 2007/027
% with tau=50ns and delta=20ns


%TODO lines from eqation, dots from measurements
    \insertFigure{figures/timeResponseReal} % Filename = label
                 {0.5}       % Width, in fraction of the whole page width
                 { The deconvolution puls shape obtained from focusing a laser on one strip of TOB module. The induced on first and second neigboring strips on both sides are shown as well.  The largest signal is collected by the hit strip, a lower fraction by the first and lowest fraction by second neighboring strip. The lines correspond to the theoretical fits, while the dots are masured data~\cite{Delaere:1061284}.  }


\subsubsection{Charge drift}

%TODO holes propagates to strips
A particle passing through the module is depositing its energy via ionization of the silicon volume. The created charge carriers then drift to the electrodes. Therefore to describe the reality, in simulation, the energy deposits, repectively charge, have to be propagated separately from each track segment to the strips. As in the barrel regions the electric field is perpendicular to the magnetic field, the drift of the charge carriers is deflected from the direction of electric field, respectively local z-axis, by the Lorentz angle. Therefore the drift direction of the charges towards the surface of sensor must be corrected accordingly to the Lorentz angle and the local magnetic field. Morover the change carriers undergo diffusion in the silicon volume during the drift and therefore a charge from each point like segment will be at the surface collcted smeared due to diffucssion effects. To estimate the difussion, first the a drift time from the track segment to the sensor surface is comupted. This drift time depends on:

\begin{itemize}
\item Sensor thickness: the drift time is longer for thicker sensors
\item Depletion and applied voltage: influence how fast the charge carriers drift
\item Charge mobility: is dependent on environment and influences how fast the charge carriers drift, for example mobility of holes is lower than electrons
\item Coordinates of the track segment: used to determine distance charge has to drift through
\item Charge distribution RMS: no idea %TODO ask
\end{itemize}

The width of cahrge distribution is then computed from the knowledge of the drift time and a difussion constant. The diffusion constant depends on the type of material the charge drifts through and the temperature of the environment. The energy units after applying the drift and diffusion procedure are stroed as signal points, with information about its coordinates at the surface, the energy and its spread.

The diffusion is dependent on the drift time which depends on the applied and depletion voltages. These voltages can (did) chane during the operation of treacker, but were not updated in simulation. The dependecy of cluster charge, seed charge and width on depetion and applied volage is shown in Figs.~\ref{fig:clusterchargeRescaledalll0to0AV}~\ref{fig:seedwidthTOBAV}~\ref{fig:clusterchargeRescaledalll0to0DV}~and~\ref{fig:seedwidthTOBDV}. Data, the default simulation and simulations with variations of up to $\pm 20\%$ of the depletion and applied voltage are present in these figures from which can be concluded, that withing this range of values of the depletion and applied voltage the change of cluster properties is negligible.

    \insertFigure{figures/clusterchargeRescaledalll0to0AV} % Filename = label
                 {0.5}       % Width, in fraction of the whole page width
                 { (top) Data and simulation comparisons of cluster charge. The default simulation (in red) was modified by injecting four different values of the applied voltage. All the simulated distribution are rescaled to number of clusters in data. (bottom) Data to simulation ratios of cluster charge distributions. }

    \insertTwoFigures{figures/seedwidthTOBAV} % Filename = label %TDO continue here
                 {figures/clusterwidthTOBl1to4AV}
                 {figures/clusterseedchargeRescaledTOBl1to4AV} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {(left top) Data and simulation  comparisons of cluster width for OB2 geometry. The default simulation (in red) was modified by injecting four different values of the applied voltage. All simulated distributions are rescaled to number of clusters in data. (left bottom) Data to simulation ratios of cluster width distributions for OB2 geometry. (right top) Data and simulation  comparisons of cluster seed charge for OB2 geometry. The default simulation (in red) was modified by injecting four different values of applied voltage. All simulated distributions are rescaled to number of clusters in data. (right bottom) Data to simulation ratios of cluster seed charge distributions for OB2 geometry. }


    \insertFigure{figures/clusterchargeRescaledalll0to0DV} % Filename = label
                 {0.5}       % Width, in fraction of the whole page width
                 { (top) Data and simulation comparisons of cluster charge. The default simulation (in red) was modified by injecting four different values of the depletion voltage. All the simulated distribution are rescaled to number of clusters in data. (bottom) Data to simulation ratios of cluster charge distributions. }

    \insertTwoFigures{figures/seedwidthTOBDV} % Filename = label %TDO continue here
                 {figures/clusterwidthTOBl1to4DV}
                 {figures/clusterseedchargeRescaledTOBl1to4DV} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {(left top) Data and simulation  comparisons of cluster width for OB2 geometry. The default simulation (in red) was modified by injecting four different values of the depletion voltage. All simulated distributions are rescaled to number of clusters in data. (left bottom) Data to simulation ratios of cluster width distributions for OB2 geometry. (right top) Data and simulation  comparisons of cluster seed charge for OB2 geometry. The default simulation (in red) was modified by injecting four different values of depletion voltage. All simulated distributions are rescaled to number of clusters in data. (right bottom) Data to simulation ratios of cluster seed charge distributions for OB2 geometry. }

The diffusion constant $D$ can be expressed as

\eq{driftEquation}
{
   D=  \frac{\mu k_{B} T}{q},
}

where $\mu$ is the charge mobility, $k_{B}$ the Boltzman constant, $T$ the absolute temperature and $q$ the electrical charge of particle. Between 2017 and 2108 the temperature of the tracker was changed from -15$^{\circ}$C to -20$^{\circ}$, but this change was not propagated into simulation, therefore it is important to evaluate its effect. The cluster charge, width and seed charge are shown in Figs.~\ref{fig:figures/clusterchargeRescaledalll0to0Temperature}~and~\ref{fig:figures/seedwidthTOBTemperature}. The plots of default simulation together with variations up to $\pm 20\%$ of the temperature are showing that the dependency of cluster charge, width and seed charge on temperature is negligible. The charge mobility is intrinsically also dependent on the temperature and should be also adjusted in the simulation. Figs.~\ref{fig:figures/clusterchargeRescaledalll0to0ChargeMob}~and~\ref{fig:figures/seedwidthTOBChargeMob} are revealing a change of cluster charge, width and seed charge when altering the charge mobility by up to $\pm 20\%$. This change is again negligible. In summary there is almost no change in cluster properties due to diffusion beacuse the magnitude of diffusion is much smaller than the picth size.


    \insertFigure{figures/clusterchargeRescaledalll0to0Temperature} % Filename = label
                 {0.5}       % Width, in fraction of the whole page width
                 { (top) Data and simulation comparisons of cluster charge. The default simulation (in red) was modified by injecting four different values of the temperature. All the simulated distribution are rescaled to number of clusters in data. (bottom) Data to simulation ratios of cluster charge distributions. }

    \insertTwoFigures{figures/seedwidthTOBTemperature} % Filename = label %TDO continue here
                 {figures/clusterwidthTOBl1to4Temperature}
                 {figures/clusterseedchargeRescaledTOBl1to4Temperature} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {(left top) Data and simulation  comparisons of cluster width for OB2 geometry. The default simulation (in red) was modified by injecting four different values of the temperature. All simulated distributions are rescaled to number of clusters in data. (left bottom) Data to simulation ratios of cluster width distributions for OB2 geometry. (right top) Data and simulation  comparisons of cluster seed charge for OB2 geometry. The default simulation (in red) was modified by injecting four different values of temperature. All simulated distributions are rescaled to number of clusters in data. (right bottom) Data to simulation ratios of cluster seed charge distributions for OB2 geometry. }

    \insertFigure{figures/clusterchargeRescaledalll0to0ChargeMob} % Filename = label
                 {0.5}       % Width, in fraction of the whole page width
                 { (top) Data and simulation comparisons of cluster charge. The default simulation (in red) was modified by injecting four different values of the charge mobility. All the simulated distribution are rescaled to number of clusters in data. (bottom) Data to simulation ratios of cluster charge distributions. }

    \insertTwoFigures{figures/seedwidthTOBChargeMob} % Filename = label %TDO continue here
                 {figures/clusterwidthTOBl1to4ChargeMob}
                 {figures/clusterseedchargeRescaledTOBl1to4ChargeMob} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {(left top) Data and simulation  comparisons of cluster width for OB2 geometry. The default simulation (in red) was modified by injecting four different values of the charge mobility. All simulated distributions are rescaled to number of clusters in data. (left bottom) Data to simulation ratios of cluster width distributions for OB2 geometry. (right top) Data and simulation  comparisons of cluster seed charge for OB2 geometry. The default simulation (in red) was modified by injecting four different values of charge mobility. All simulated distributions are rescaled to number of clusters in data. (right bottom) Data to simulation ratios of cluster seed charge distributions for OB2 geometry. }

The Lorentz angle used in simulation is dependent on the electric field and therefore with change of voltage the Lorentz angle should be updated. The effect of the Lorentz Angle on the simulated cluster charge, width and seed charge is shown in Fig.~\ref{fig:figures/clusterchargeRescaledalll0to0LA}~and~\ref{fig:figures/seedwidthTOBLA}. In theLorentz angle injected in simulation is specific for each module and iot is read from the consition database. The distribution of OB2 Lorentz angles per cluster was fitted by Gaussian distrinution to obtain its mean value and standard deviation. Then the mean was alterned by up to $\pm 2 \times$ standard deviation and injected into simuation to obtained the varied simulated samples. It can be concluded that within the range of injected Lorent angle values thereis small but visible effect on the description of cluster properties. Therefore within a tracker local reconstruction group there are intents to remeasure and update Lorentz angle values.


    \insertFigure{figures/clusterchargeRescaledalll0to0LA} % Filename = label
                 {0.5}       % Width, in fraction of the whole page width
                 { (top) Data and simulation comparisons of cluster charge. The default simulation (in red) was modified by injecting four different values of the Lorentz angle. All the simulated distribution are rescaled to number of clusters in data. (bottom) Data to simulation ratios of cluster charge distributions. }

    \insertTwoFigures{figures/seedwidthTOBLA} % Filename = label %TDO continue here
                 {figures/clusterwidthTOBl1to4LA}
                 {figures/clusterseedchargeRescaledTOBl1to4LA} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {(left top) Data and simulation  comparisons of cluster width for OB2 geometry. The default simulation (in red) was modified by injecting four different values of the Lorentz angle. All simulated distributions are rescaled to number of clusters in data. (left bottom) Data to simulation ratios of cluster width distributions for OB2 geometry. (right top) Data and simulation  comparisons of cluster seed charge for OB2 geometry. The default simulation (in red) was modified by injecting four different values of Lorentz angle. All simulated distributions are rescaled to number of clusters in data. (right bottom) Data to simulation ratios of cluster seed charge distributions for OB2 geometry. }

Overall the description of the drift is simplified in the simulation. It does not take into account any radiation damages of the silicon or non-unifomities of the electric filed.
%ISSUES
%charge is induced also by electrons
% charge is beiing induced - no cross talk due to induction.
%point-like track segment - spread i  charge should be already there...
%temperature changes with time
%lorentz angle changes as well because of different voltage
%ultimately the voltage itself play a large role
%charge mobility

\subsubsection{Induce charge on the strips~\label{sec:induce}}

Once the energy deposits in form of charge are collected on the surface, it must be simulated how much of charge is read by given strip. The charge cannot be divided between strip purely based on the geometrical critearia, due to the the capacitive coupling between strips. The capacitive coupling causes that, in the case of deconvolution mode, the charge collected by one strip is partially shared with its first and second neighbouring strip on both sides. In the peak mode, only sharing between the first neighboring strip on eeach side is observed.   

The signal point at surface is associated to the closest strip. The charge converted from energy to number of electrons, is then divided between the neighboring strips acording the charge spread orifinating from diffusion. This is done dor all signal points and after this and in case that to one strip obtains signal from more signal points, these deposits are summed. Now each strip has its assigned charged, on which the cross talk effect has to be applied. The simulation interates over all strips from left to right, and shares the charge of a given strip in between neighbors.

In the reallity, the charge is being induced on the strips already once the electrons and holes start to drift to backplane and strips, respectively, and at that time both kind of cross talks start to play their roles. The simulation decomposes these steps, first only holes towards the strips are drifted, second the charge on the strips is collected and then the cross talk caused by capacitive coupling is applied. Moreover, the cross talk could change in time due to radation damages of moules and is in principle dependent also on volatge [TODO ask]. To evaluate, what would be an impact of not corect description od cross talk, the Figs.~\ref{fig:figures/clusterchargeRescaledalll0to0coupling}~and~\ref{fig:figures/seedwidthTOBcouplig} show cluster charge, width and seed charge for seevral different cross talk configuration. In these plots we see that the cluster width and seed charge, whcih are poorly described in simulation, are strongly dependent on cross talk. The clutser charge dependence on cross talk is much weaker. To evalutae if there is a cross talk parametrization which could be injected into simulation to describe data, the matrix of simulated samples was produced. The cluster width of each sample was compared to data, based on $\chi^{2}$ test. The sample with the ebast $\chi^{2}$ is shown in light blue in Figs.~\ref{fig:figures/clusterchargeRescaledalll0to0coupling}~and~\ref{fig:figures/seedwidthTOBcouplig}. After this procedure the the data and simulation agreement in cluster width and seed charge is vastly improved, but is still not perfect as the parameters and conditions which cause minor source of disrepancies have to be updated as well. The remining non-descriptions could be then cused by simiplification of the cluster simulation. More details about the cross talk and its evaluation is given in section~\ref{figures/seedwidthTOBGeVPerElectron}. [TODO should I give more details about cross talk tuining in here and the meaning of parameters, or I will keep that to corss talk section and this general idea is enough?]


    \insertFigure{figures/clusterchargeRescaledalll0to0coupling} % Filename = label
                 {0.5}       % Width, in fraction of the whole page width
                 { (top) Data and simulation comparisons of cluster charge. The default simulation (in red) was modified by injecting five different combinations of capacitive coupling parameters. All simulated distributions are rescaled to number of clusters in data. (bottom) Data to simulation ratios of cluster charge distributions. }

    \insertTwoFigures{figures/seedwidthTOBcoupling} % Filename = label %TDO continue here
                 {figures/clusterwidthTOBl1to4coupling}
                 {figures/clusterseedchargeRescaledTOBl1to4coupling} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {(left top) Data and simulation comparisons of cluster width for OB2 geometry. The default simulation (in red) was modified by injecting five different combinations of capacitive coupling parameters. All simulated distributions are rescaled to number of clusters in data. (left bottom) Data to simulation ratios of cluster width distributions for OB2 geometry. (right top) Data and simulation  comparisons of cluster seed charge for OB2 geometry. The default simulation (in red) was modified by injecting five different combinations of capacitive coupling parameters. All simulated distributions are rescaled to number of clusters in data. (right bottom) Data to simulation ratios of cluster seed charge distributions for OB2 geometry. }

%TODO xtalk
%large effect on the width -> only parameter on which the width is really very sensitive
%tuned on cluster width (chi2) -> better description of width and seed charge
%cluster charge not changing much - could be adjusted with convertion parameters, which will be emntioned later

With aging of the silicon sensors the conversion between energy and electrons can evolve. The data and simulations comparisons of cluster charge, width and seed charge are shown in Figs.~\ref{fig:figures/clusterchargeRescaledalll0to0GeVPerElectron}~and~\ref{fig:figures/seedwidthTOBGeVPerElectron}. Again set of simulations produced by changing the conversion factor up to $\pm 20\%$ is plotted as well. In the figures it can be noticed that change of conversion factor between deposited energy and electrons in the given range leads to significant changes in  But from the plots it can be concluded that only a change of this conversion factor would not be able to provide good data and simulation agreement in all these three quantities.

    \insertFigure{figures/clusterchargeRescaledalll0to0GeVPerElectron} % Filename = label
                 {0.5}       % Width, in fraction of the whole page width
                 { (top) Data and simulation comparisons of cluster charge. The default simulation (in red) was modified by injecting four different values of the conversion factor between deposited energy and electrons. All the simulated distribution are rescaled to number of clusters in data. (bottom) Data to simulation ratios of cluster charge distributions. }

    \insertTwoFigures{figures/seedwidthTOBGeVPerElectron} % Filename = label %TDO continue here
                 {figures/clusterwidthTOBl1to4GeVPerElectron}
                 {figures/clusterseedchargeRescaledTOBl1to4GeVPerElectron} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {(left top) Data and simulation  comparisons of cluster width for OB2 geometry. The default simulation (in red) was modified by injecting four different values of the conversion factor between deposited energy and electrons. All simulated distributions are rescaled to number of clusters in data. (left bottom) Data to simulation ratios of cluster width distributions for OB2 geometry. (right top) Data and simulation  comparisons of cluster seed charge for OB2 geometry. The default simulation (in red) was modified by injecting four different values of conversion factor between deposited energy and electrons. All simulated distributions are rescaled to number of clusters in data. (right bottom) Data to simulation ratios of cluster seed charge distributions for OB2 geometry. }

%TODO more about xtalk
%in reallity not like this at all, the carriers drift and induce charge
%association to the closest strip - well if the center is close to middle, this is dangerous
%cross talk not correct on the edges, first and last strips
%no dynamics, sequential cross talk
%maximal cluster charge and seed charge at different time because of the puls shapes
%the emasurements of cross talk  are done in a way that not only capacitive coupling is inside

\subsubsection{Remove dead channels, add noise and convert signal to digis}

To finilaze the event few more efects must be considered. First, in the detector, several strips are dead. The information about dead channels is stored in the database, read by the simulation, and simulated charge on these channels is set to zero. Secondly, to mimic real conditions, the realistic noise has to be added to each strip. The noise per each strip is determined from the the fluctiuation of the strip charge after pedestal and CMN subtraction in data runs when no collision was present, is stored in database, and for needs of simulation read from there. The noise is storead in ADC, therefore it has to be converted to the electrons by ePerADC conversion factor. Morover because of differences between modules in detector, the noise has to be rescaled by gains of given modules to correct for module differences. The gain~(Gsim) used in simulation is determined from G1 and G2 gains measured in data, which are described in Sec.~\ref{sec:localreco}. The current choice computation of Gsim, takes G1 from data and smears G1 by random smearing to take into account differences on the sensor level.

 The summed signal and noise on the strips in electrons is then converted to ADC by ePerADC factor and scaled by Gsim to mimic output from the detector. During the reconstruction step, both data and simulation are corrected by 1/(G1$\times$G2) to eliminate module differences. Therefore it would be possible not to apply any gain on the simulated data as simulation itself no differences between same modules are intorduced. For the first simulations, indeed, no gains were applied, but later it was decided to apply gains to be able to simulate stauration effects. In FED, the charge in ADC is truncated into 8-bit range, therefore the GSim is applied to mimic the realistic output of given APV. The simulated data in ADC and then Zero Supperssed and stroed as digis.
 

The gains and noise are strongly dependent on tracker operating temperature and radiation damage and therefore they are mesured several times per year and updated regularly for needs of data reconstruction. These values are not propagated to the simulation, using values from different database, which are updated whith much smaller frequency. The difference of noise and gain between data and simulation can lead to the different zero suppresion results. If the noise is larger in one case than other, it can appear that a strip with a given charge can fail the S/N threshold criterium in one case and pass in other. This effect can lead to discrepancy in cluster width and charge between data and simulation. To evaluate current status, the cluster seed noise rescaled by Gsim, further called only seed noise, is shown in Fig.~\ref{clusterseednoiseTOB2}. From the plots it is obvious, that the difference in the seed noise between data and simulation is huge. This finding triggered the update of these conditions by the responsibles of the tracker local reconstruction group. The updated [TODO lets wait for Marco] 

Similarly as the conversion factor between energy and electrons, the conversion factor betveen electorns and ADC is sensitive to the aging of modules. The comparisons of data, default simulation and simulations with chaged eperADC factor within up to  $\pm 20\%$ from original value in the cluster charge, width and seed charge are shown in Figs.~\ref{fig:figures/clusterchargeRescaledalll0to0ElectronPerADC}~and~\ref{fig:figures/seedwidthTOBElectronPerADC}. By its nature the impact on th cluster quantities is very similar as of the previous conversion factor, but again the conversion factor alone is not responsible for non-description of data by simulation.  


    \insertFigure{figures/clusterchargeRescaledalll0to0ElectronPerADC} % Filename = label
                 {0.5}       % Width, in fraction of the whole page width
                 { (top) Data and simulation comparisons of cluster charge. The default simulation (in red) was modified by injecting four different values of the conversion factor between electrons and ADC. All the simulated distribution are rescaled to number of clusters in data. (bottom) Data to simulation ratios of cluster charge distributions. }

    \insertTwoFigures{figures/seedwidthTOBElectronPerADC} % Filename = label %TDO continue here
                 {figures/clusterwidthTOBl1to4ElectronPerADC}
                 {figures/clusterseedchargeRescaledTOBl1to4ElectronPerADC} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {(left top) Data and simulation  comparisons of cluster width for OB2 geometry. The default simulation (in red) was modified by injecting four different values of the conversion factor between electrons and ADC. All simulated distributions are rescaled to number of clusters in data. (left bottom) Data to simulation ratios of cluster width distributions for OB2 geometry. (right top) Data and simulation  comparisons of cluster seed charge for OB2 geometry. The default simulation (in red) was modified by injecting four different values of conversion factor between electrons and ADC. All simulated distributions are rescaled to number of clusters in data. (right bottom) Data to simulation ratios of cluster seed charge distributions for OB2 geometry. }

    \insertFigure{figures/clusterseednoiseTOB2} % Filename = label
                 {0.5}       % Width, in fraction of the whole page width
                 { (top) Data and simulation comparisons of cluster seed noise. The simulated distribution is rescaled to number of clusters in data. (bottom) Data to simulation ratio of cluster seed noise distributions. }

%TODO plot seed noise
%TODO plot e per ADC
%TODO G1, G2, Gsim
%TODO all the hits are accumulated for each evet!
%TODO write something about database
 
\subsubsection{Virgin raw simulation}

Except of standard zero supperessed simulation, the tracker digitizion step brings a possiblility to simulate virgin raw data. To similate VR data, several steps needs to be added in between of the simulation steps described above. After inducing charge on strips, the APV saturation due to HIP effect can be simulated. This option is by default switched off. Then the APV baseline accordingly to the charge collected by the APV i and number of channels reading it. Then the realisitc strip noises, CMNs and pedestals are added and the results is stored.

%TODO the baseline shift is not correct according to me 
%TODO - there is a diffusion of the charge in the perpendicular(ask?) plane
% TODO	-particle goes straight (ask? meaning the track goes straight?)
% TODO charge spread depends on applied and depletion voltage ???

\newpage

\section{Improvement of the simualtion}

As identified in above sections the tuning of cross talk parameters could lead to better description of data by simulation. There are two ways how to obtain new cross talk parameters. First idea was already indtroduced in subsection~\ref{sec:induce} and it was to produce matrix of with changed cross talk parameters by step and then based on $\chi^{2}$ test evluate which simulated cluster width distribution fits the one of data. Before such tuning of cross talk it is needed to perform update of the bad channels, noise and gainsi in the simulation.

The second option is to measure cross talk parameters from data. In following, the results on the cross talk meaurement will be given and then compared with the results from the tuning of cross talk in data to simulations comaprisons.

%The first step how to imporve the description of data is update of the conditions
%-first nose gains and bad channels need to be updated
%-then plug in cross talk
%- then if neeeded tune one fo the conversion factors
%-In the previous sections several limitiations and simplifications in simulation process vere identified. In further steps the simulation could be improved to mimic more realistically hoe the clusters are created inCMS detector.


\subsection{Cross talk  measurement~\label{sec:xtalk}}

%after seeing what effect could cross talk tuning did, we decided to remeasure the cross talk which was measured last in ...?
%actually the calue of cross talk we inject into MC can compensate for other effects and therefore does not have to agree with simualtions.
%TODO more about xtalk, picture


\subsubsection{Cross talk tuning}


