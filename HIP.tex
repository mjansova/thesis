%\chapter{Study of the highly ionizing particles in the silicon strip tracker}

\clearpage

\setcounter{secnumdepth}{4}
\chapterwithnum{Study of the highly ionizing particles in the silicon strip tracker}
\setcounter{secnumdepth}{4}


\section{The tracking inefficiencies at the beginning of Run~II~\label{sec:hitIneff}}

\subsection{Observed inefficiencies in track reconstruction}
%TODO track must be known

At the start of the Run~II 2015D era, the time between collisions was shortened from 50~ns to 25~ns. During this era, with more data collected, the CMS collaboration started to observe large discrepancies between predicted and measured numbers of tracks: data showed less tracks and also shorter tracks than simulations. Such situation appeared because of the cluster inefficiency, the loss of hits translated into a loss of tracks. This kind of inefficiencies has already been observed at the end of Run~I, especially in lead collisions, but with much smaller impact. 

Observed inefficiencies were shown to depend on the distance to the interaction point~(IP) and also scale with the instantaneous luminosity~\cite{website:hitEff}. Left Fig.~\ref{fig:figures/effAsLayerAndLumi} shows the hit efficiency, computed as the ratio of the number of hits associated to reconstructed tracks to the number of expected hits for the different layers of the barrels, the disks, and the endcaps. Right Fig.~\ref{fig:figures/effAsLayerAndLumi} is depicting the hit efficiency  as a function of the instantaneous luminosity. In these plots, the reduced hit efficiency seen in 2015/2016 runs, is shown in red empty circles. For comparison, the red full circles stand for hit efficiency of the runs taken at the end of 2016, once the source of the largest hit inefficiency was eliminated, what will be discussed in later sections.


    \insertTwoFigures{figures/effAsLayerAndLumi} % Filename = label
                 {figures/effAsLayer}
                 {figures/effAsLumi} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {(left) Hit efficiency for the different layers of the barrels, the disks and the endcaps. The empty circles represent hit efficiency measurement for the old front-end electronics~(APV) settings while full circles depict hit efficiency measurement after the APV settings change. The instantenous luminosity for both runs is indicated in the legend. (right) Hit efficiency as a function of the instantenous luminosity. The measurement is shown only for first layer of TOB for both old~(empty circles) and new~(full circles) APV settings~\cite{website:hitEff} (TODO pdf and latest version) } % Caption


%-less tracks
%-25ns/high lumi runs - fewer associated hits
%-correlation with increased instantenous luminosity
%-correlated with HIP effect
%-efficiency improves at first bx of train

%findings:
%-lower cluster charge
%-lower S/N
%-lower hit efficiency
%-shorter tracks
%-lower track efficiency

%https://twiki.cern.ch/twiki/bin/viewauth/CMS/SiStripHitEffLoss
%https://indico.cern.ch/event/560224/contributions/2265347/attachments/1320462/1980048/WGM_HIP_Boudoul.pdf
%https://indico.cern.ch/event/560226/contributions/2277448/attachments/1324704/1988050/wgm_vfp_change_ebutz.pdf
%https://twiki.cern.ch/twiki/bin/view/CMS/StripsOfflinePlots2016


%The inefficiencies were later linked with the limitations and configuration of the read-out electronics. TODO do I need to use it?

\subsection{Investigating the highly ionizing particles}

Among the various possible explanations of the observed hit efficiencies, the hypothesis of Highly Inoizing Particles~(HIP) was considered. To understand the effect of the HIP on the hit efficiency, first the the energy loss mechanism for charged particles in silicon must be discussed. The main energy loss mechanism for charged particles in tracker silicon sensors is via the electromagnetic interaction, mainly via ionization described by the Bethe-Bloch formula~\cite{Groom:2000sm}. Beyond the electromagnetic interaction, the traversing particle can deposit energy in sensors via elastic and inelastic nuclear interactions with the silicon nucleus. These two interactions result in a nuclear recoil for the elastic case and a nuclear recoil and fragmentation in case of inelastic interaction. A sufficiently energetic recoiled nucleus can also induce displacement of the other nuclei in its proximity. All affected nuclei as well as the nuclear fragments undergo energy loss by ionization, resulting in large and very localized energy depositions in the silicon volume. By simulation of these interactions in the silicon, it has been shown that elastic interactions do not lead to high energy depositions, while inelastic interactions can induce energy deposits up to $\sim$100~MeV in 500~$\mathrm{\mu m}$ thick tracker sensors, which represents an energy deposit $\sim$1000 times larger than by ionization only~\cite{Huhtinen:2002yda}. The Most Probable Value~(MPV) of the energy deposition in these sensors, originating from the inelastic interaction has been found to be around 10~MeV, corresponding to 100~MIPs~\cite{Adam:2005pz}. The readout electronics of the tracker modules is not designed for such large energy deposits resulting in saturation of the electronics, dead-time in charge collection and thus hit inefficiency. In summary an HIP event is an event in which typically inelastic interaction of incoming particle with the silicon is a source of highly ionizing particles. These particles ionize the volume of the silicon sensor by far more than the MIP particles and thus they can saturate the readout electronics. The saturated electronics becomes inefficient and insensitive to the further incoming particles, resulting in inability to reconstruct clusters and thus loss of hits which could explain the observed hit inefficiency.


\section{Strip tracker readout system}

As the saturation of the readout electornics by the HIP event was found to be plausible explaination of the observed inefficiencies, the tracker readout chain is introduced in this section to understand behavior of the electronics under such conditions.

%The inefficiencies were later linked with the limitations of the read-out electronics. 

\subsection{Overview}

    \insertFigure{figures/dataFlow} % Filename = label
                 {0.4}       % Width, in fraction of the whole page width
                 {Overview of the tracker readout chain~\cite{Bainbridge:2004jc}. Charge induced the silicon strips is read by the on-detector APV chips. Output of 2 APV chips is multiplexed and converted to the optical signal wich is sent via optical links to the off-detector FEDs for further signal processing. } % Caption

The charge carriers originating from the ionization of the silicon volume by the traversing particle drift toward electrodes and induce current on the silicon strips, which is read by an front-end chip called APV25~\cite{French:2001xb} chips glued to the tracker module and bond to the tracker sensor. The analog signal from these chips is sent via optical links to the back-end electronic cards cards called Front-End Drivers~(FED)~\cite{Baird:2002wg} located in the control room. In standard data-taking configuration, the data are digitized and processed in the FEDs. The graphical overview of this data flow is shown in Fig.~\ref{fig:figures/dataFlow}.

\subsection{The silicon strip modules}


The sensitive volume of the CMS tracker modules consists of the silicon strip sensors. Schematic sketch of a silicon strip sensor is shown in Fig.~\ref{fig:figure/siliconSensor} Each silicon sensor is formed by a n-type bulk, which has on one side an uniform n+ implant while p+ strip implants are located on the other side. The implants are connected to a reverse bias voltage to completely deplete the bulk of the sensors. The thickness of both p+ and n+ implants is small and negligible compared to the bulk, thus almost whole volume of the sensor is depleted. Every strip is connected by a wire bond to a read-out electronics. The distance between strips is called the pitch. Depending on the type, tracker modules have 512 or 768 p+ strips, each 128 strips are connected to one front-end chip. The larger part of the modules has one layer of sensors~(mono modules), while the remaining part holds two layers of sensors  mechanically attached back to back and with a strip inclination of $5.7^{\circ}$ against each other~(stereo modules). With two tilted sensor layers, stereo modules are able to provide 3-D information in global coordinates about the hit position, where the particle has hit the module. The mono modules give only 2-D hit measurement as the third dimension depends on the strip lenght which is orders of magnitude larger than the strip length and thickness. The modules also differ by the pitch between each strip, which can vary from approximately 80 $\mu$m up to 205 $\mu$m depending on the tracker layer and partition.

    \insertFigure{figures/siliconSensor} % Filename = label
                 {0.4}       % Width, in fraction of the whole page width
                 {A schematic sketch of the silicon sensor with n-type silicon bulk, p+ strips and n+ backplane. The directions of an electric field, an incoming particle from the interaction point, and a movement of charge carriers are also indicated. } % Caption

When a charged particle is crossing the silicon sensor, electron-hole pairs are produced along the path of the particle. The energy loss in the material can be described by the Bethe-Bloch formula~\cite{Groom:2000sm} as a function of $\beta\gamma = p/Mc$, where $\beta$ is the ratio of the interacting particle velocity to the speed of light, $gamma$ is the Lorentz factor, $c$ is the speed of light, and $p$ and $M$ are momentum and mass of the interacting particle. The Bethe-Bloch function has a minimum at $\beta\gamma \approx 3$. The majority of charged particles produced in the hard scattering in the CMS detector have in good approximation minimal $\beta\gamma$ values and are thus called be Minimum Ionizing Particles~(MIP).

A signal starts to be induced on strips once electrons and holes begin to drift towards the electrodes. Holes drift to the strips and electrons to the back-plane~(n+ implant). The charge induced at the electrodes can be calculated using the Shockley Ramo theorem~\cite{doi:10.1063/1.1710367,Ramo:1939vr}. In the framework of this theorem, it can be shown~\cite{Bloch:2007zza} that charge carriers drifting toward one strip induce as well charge on the neighboring strips. The total induced charge on neighboring strips integrated over time is zero in case that at the end all charge carriers are collected at one strip and are not trapped by the neighboring strips.

The number of strips collecting the charge carriers created by ionization depends on the charge sharing and the electronics cross-talk among the strips. The charge sharing is strongly dependent on the position where charge carriers were created and can be caused by diffusion, trajectory inclination or effects of the magnetic field on charge carriers. On the contrary, the electronics cross-talk is independent of the initial charge carriers position and comes from the strip coupling via inter-strip capacitance.  

The charge sharing between more strips can come from the inclination of the trajectory. In that case, the charge carriers from the different parts of the trajectory are drifting towards different strips. In addition if no magnetic field is present, the created charge carriers, electrons and holes, would drift directly towards electrodes. In the case of barrels, a perpendicular magnetic field is applied, the charge carrier $q$ is therefore deflected from the direction of the electric field due to the Lorentz force $\vec{F}$ defined by equation

\eq{LorentzEquation}
{
   \vec{F}=  q(\vec{E}+\vec{v} \times \vec{B}),
}

where $\vec{E}$ is the electric field, $\vec{v}$ is the velocity of charge carriers and $\vec{B}$ is the magnetic field. The angle between the electric field lines and the drift direction of the charge carriers in the magnetic field is called Lorentz angle. This angle is independent of the track inclination and can be compensated by tilting the tracker modules.

Finally, the diffusion of the charge carriers during the drift to the electrodes can also modify the path of the charge carriers from the straight line. However the spread of the charge carriers due to diffusion is two orders of magnitudes lower than the pitch and thus it can result only in a small amount of charge collected by neighboring strips just in case the particle has passed close to the middle of the pitch~\cite{Bloch:2007zza}.


The electronics cross-talk arises from the readout capacitive network. Strips are coupled to back-plane via a capacitance and to neighboring strips via an inter-strip capacitance. The capacitive network of silicon strip sensor and its electronics is shown in Fig.~\ref{fig:figure/capacitanceNetwork}. Due to the inter-strip capacitance, the charge collected by one channel~(strip) is shared between the neighboring channels. The coupling of neighboring strips depend strongly on the sampling time~\cite{Bloch:2007zza} which can be fifferent for different tracker readout modes. This effect can be studied numerically via the description of the capacitive network by the SPICE simulations~\cite{Barberis:1993ph}.


    \insertFigure{figure/capacitanceNetwork} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {A schematic view of a generic capacitive network of a silicon strip sensor and respective readout electronics. The strips are inter-connected via the inter-strip capacitance $C_{int}$. On top of this connection, second neighboring strips are directly coupled by capacitance $C_{s}$. Each strip is connected to backplane via capacitance $C_{sub}$. The strips are connected to amplifiers located at the top part of the schema~\cite{Lutz:1987wd}.}


%Chare sharing can be measured from eta function (response function) -eta function R/(L+R), two separate peaks at 0 and 1 if no charge sharing. Shoft because of electronic coupling. Width of the peak determined by the noise. Almost linear charge sharing outside of the peak (plateau) - amount of charge collected by a strip is inversly proportional to the distance of the impact point from that strip (linear charge sharing) - for perpendicular tracks negligible.


\subsection{The APV25 readout chip \label{sec:APV}}


    \insertFigure{figures/APVreadout} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {The schema of the APV25 chip taken from~\cite{Friedl:2001kra}.} % Caption

The charge collected by 128 channels is read out by one APV25~\cite{French:2001xb} chip. The APV is a front-end chip providing amplification and shaping of the signal recived from the channels. To achieve this, all APV chips are equipped by a preamplifier, an inverter, a CR-RC shaper, an analog pipeline and a deconvolution filter for each of its 128 channels. The block diagram of the APV chip is shown in Fig.~\ref{fig:figures/APVreadout}.

The amplified signal is sent to the inverter which is coping with the signal polarity and then to the CR-RC shaper to convert the strip signal into voltage pulse with peaking time of 50~ns. The output of the shaper is sampled with the frequency of 40~MHz and saved to the anolog pipeline. The APV can work in the ``peak mode'', when only a single value of the puls shape is used. This value corresponds to the maximum of the puls shape for the given bunch crossing. In the ``deconvolution mode'' the weighted sum of the shaper sampled output from three consecutive bunch crossing is calculated instead. The computed non-sampled APV output in the peak~(black) and deconvolution~(grey) mode can be seen in Fig.~\ref{fig:figures/PeakDeco}. In the real situation the peak curve in black is sampled at its maximum to obtain peak mode output or by three steps of 25~ns to be able to compute the deconvoultion mode output. The illustration of the sampling points for peak~(circle) and deconvolution~(rectangles) modes is also presented in Fig.~\ref{fig:figures/PeakDeco}. Because in the deconvolution mode the puls shape is shorter as shown in Fig.~\ref{fig:figures/PeakDeco}, the APV is usually operating in this mode to reduce the out-of-time pile-up and improve separation of signals from two consecutive bunch crossings. To have a possibility to optimize the pulse shape, the feedback resistors of bothi the preamplifier and the shaper as well as the  bias current and the voltage are fully programmable. For the calibration and test of the chip, an internal calibration circuit is present. This circuit enables to inject charge to each channel separately to the stage prior to the preamplifier one.


    \insertFigure{figures/PeakDeco} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {Calculated APV output in the peak~(black) and deconvolution~(grey) mode. Actually, the shaper output is sampled in the APV to obtain only maxima of the two curves. An example of the sampling points for the deconvolution mode is shown in green rectangles, the sampling point for the peak mode is represented by a blue circle~\cite{Friedl:2001kra}.} % Caption


The peak or deconvolution output value and the bunch crossing information for all 128 channels of one APV are extracted at the end of the analog pipeline upon the request of the trigger. The average signal level from the 128 channels can be adjusted within the dynamic range of the APV, in order to reduce the signals exceeding the APV range. The signals from two APV chips are multiplexed by APVMUX chip~\cite{Ball:2007zza} into a single line and converted by laser from an electrical to analog optical signal, which is sent via an optical fiber to the control room. At the control room, the optical signal is then received by a pin diode which is a part of the FED.

%-tickmarck sent every 70 clock cycles when no data are qued for output -  used for synchronization betwwen frontend and backend electronics.

\subsection{The Front End Driver}


The FED~\cite{Baird:2002wg} is receiving data from 96 optical fibers, each sending information from 2 APVs. The data in form of optical signals are converted to electrical signals, which are then reordered and synchronized. For each APV input, the signals per channel are extracted and digitized into 10-bit range Analog Digital counts~(ADC). The output signal for a given channel is referred as ``digi'', which can be seen in Fig.~\ref{fig:figures/event2layer4}. 

In FED two kinds of noises can be subtracted. The first is reffered as pedestal and is computed as the mean strip activity for a given strip when no particle is present, it is evaluated from special ``pedestal runs'' taken several times per year. After pedestal subtraction the Common Mode Noise~(CMN or baseline) is the remaining noise due to e.g. electronics or power supplies origins, which is common to all channels of one APV and calculated on an  event by event basis as the median over the 128 strips. The data after pedestal subtraction and the CMN are also shown in Fig.~\ref{fig:figures/event2layer4}. After both subtractions of the pedestals and the CMN, the channels with ADC values lower than zero are truncated to zero. For all channels, the signal-to-noise ratio~(S/N) is checked separately. If S/N of the channel is larger than two or S/N or the S/N of group of neighboring channels exceeds certain threshold, the ADC values of these channels are kept and the remaining channels are set to zero. Moreover the ADC range is truncated to 8 bits in a way that no change is applied for channels with charges lower than 254 ADC, charges between 254 ADC and 1022 ADC included are set to 254 ADC, and charges exceeding 1022 ADC are stored as 255 ADC. Later only information about strips with non-zero ADC values are sent to the CMS Data Acquisition System~(DAQ).  This procedure of pedestal and CMN subtraction, evaluation of the channels based on the S/N and suppression of channels with zero ADC value is called ``Zero Suppression''~(ZS).In the standard operation mode, the zero zuppression mode is used for data-taking. By ZS procedure, the available data are reduced by a factor $\sim$60 and allows not to overload the CMS DAQ system.

For testing purposes the FED is able to operate in other modes than the ZS mode. In case of the ``Virgin Raw''~(VR) data taking mode, no subtraction or suppression is applied. This mode is thus suitable for clean studies of the APV output, for example.

%In the ideal case, when a constant current is injected into the sensor, the output signal from the electronics should be constant. In reality it is not the case because of the random fluctuations called electronics noise. The silicon strip sensors have two sources of electronics noise, which are voltage or current sources. These two sources can be induced by either variations of the velocity (thermal noise) or by fluctuating number of charge carriers (shot noise)~\cite{website:noise}. Usually the largest noise comes from the amplification of the signal. 

The noise can be correlated between channels, like in case of the CMN, but also due to the electronics capacitive coupling. Anti-correlation of noise between neighboring channels originating from the inter-strip capacitance has been observed~\cite{Lutz:1987wd}. As the total charge on all channels must be conserved, in case of upward fluctuation on one strip, the downward fluctuation must occur on neighboring strips leading to anti-correlation of noise between neighboring channels.

\subsection{The offline data treatment}


The data collected by the FED are then treated offline. A clustering procedure is applied on the ZS data. The default clustering algorithm is called ``Three threshold algorithm'', posing thresholds on the seed strip~(strip with the largest signal), on the neighboring strips and on the cluster charge in terms of signal-to-noise ratio. The seed must pass the requirement of S/N>3, adjacent strips can be added if their S/N is larger than two. On top of these requirements, the total cluster charge~(the sum of the charges of all channels) must be five times larger than the total cluster noise $\sigma_{cluster}$ which is defined as


\eq{noiseEquation}
{
    \sigma_{cluster} = \sqrt{\sum_{i} \sigma_{i}^{2}},
}

where $\sigma_{i}$ is the noise of channel $i$. In addition to its charge and noise, each cluster can be quantified by a cluster width, corresponding to the number of channels in the reconstructed cluster. The example of clusters obtained at the end of the clustering procedure is shown in Fig.~\ref{fig:figures/event2layer4}.

    \insertFigure{figures/event2layer4} % Filename = label
                 {0.6}       % Width, in fraction of the whole page width
                 {Example of data from one tracker module undergoing zero suppression and clustering. The raw digis are shown in pink. From raw digis the pedestals are subtracted and the resulting digis are shown in blue. From these digis the baselines shown in red are comuped and subtracted. The final clusters are shown in green.} % Caption

%-gains %https://github.com/cms-sw/cmssw/blob/09c3fce6626f70fd04223e7dacebf0b485f73f54/RecoLocalTracker/SiStripClusterizer/src/ThreeThresholdAlgorithm.cc
During clustering, the strip charge is corrected by two calibrations: the tick-mark gain~(G1) and the particle gain~(G2). First, thhe tick-mark [TODO: issued by the APV] gain is correcting the signal for the transmission losses, mainly for the lossesi happening during the transmission ofi the signal through the O(100)~m long optical fibers. To estimate this gain, a signal is injected to the calibration circuit. The gain per APV is then computed from the change of height between the readout output and the input. The tick-marks also allow the synchronization of the APVs to the central trigger.

Secondly, particle gain is correcting for the differences at the sensor level. This gain is determined from the ionization of the silicon sensitive volume per unit of length of a particle traversing the sensor. The Most Probable Value of the ionization per unit of length is then used to equalize the response of different sensors to the MIP charge. 

These calibrations need to be determined frequently as they are affected of the aging of the detector or some change of the operating conditions~(e.g. temperature).

The final position of the hit is obtained from charge-weighted positions of the channels in the cluster, corrected for the Lorentz drift in case of TIB and TOB. On top of this an additional correction is applied due to compensate inefficiencies of the collection of charges deposited close to the back-plane. 

The track reconstruction is performed in 4 steps. First the \textit{track seed} is built from two or three 3-D hits. Then during the \textit{track finding} the track is propagated to the neighboring layers of the tracker, testing the compatibility of the hit with the track by a $\chi^{2}$ test. Once the track candidate is complete, the \textit{track fitting} is performed to obtain the best parameters of the track. The last stage is a \textit{track quality selection} based on the $\chi^{2}$ of the final fit, number of layers with hit associated to the track and the probability of the track  to originate from the primary vertex.

The reconstructed hits are therefore used for track reconstruction~\cite{Chatrchyan:2014fea}, using the software referred as the Combinatorial Track Finder~(CTF), based on the combinatorial Kalman filter~\cite{Fruhwirth:1987fm}. The CMS tracking uses an iterative approach -- first the easiest track to find is reconstructed (e.g. the one with the highest $p_{T}$), then after this track is complete its hits are masked in order to reduce combinatorics for further iterations of tracks finding.



-TODO tracking cosmics?
%-how is it with missing hits? -track is only lost if two consecutive hits are missing? Can differ but usually should be 1 missing hit per track maximum -  in note CMS-TRK-11-001

\section{The impact of highly ionizing particles on the APV25 chip}

%energy spectra of heavy fragments produced in silicon are insensitive to energy of incident particle and do not go further than 10MeV, energy loss for such fragments are of order$MeV\mum^{-1}$~thus the fragments can go up to 100 $\mum$ (compare with sensor thickness) - very localized depositions. The light particles from nuclear interactions can travel longer and also contribute significantly to the total energy depositied~\cite{Huhtinen:2000nk}.


\subsection{Studies prior to the LHC data taking~\label{sec:HIPinPast}}

The effect of the highly ionizing particles was studied in the past, before the start of LHC operation, during the beam tests at PSI and CERN X5. In addition, the impact of large energy depositions on the electronics was also studied by charge injection in the calibration circuit of the APV or by laser tests~\cite{Adam:2005pz}. In this section only results of the PSI beam test are described.

\subsubsection{Experimental setup of the PSI beam test}

The M1 beamline at PSI provided a continuous beam of protons and pions. For the APV studies, the beam was tuned to pion momentum of 300~MeV to best mimic conditions of the CMS environment. The tracking system under test at PSI consisted of 12 layers of tracker modules (3$\times$TIB, 3$\times$TEC, 6$\times$TOB), but for the study of HIP events only TOB modules were used. These TOB modules had 500~$\mathrm{\mu m}$ thick sensors with strip pitch of 183~$\mathrm{\mu}$m and were equipped by inverter resistors of either 50, 75 or 100 $\mathrm{\Omega}$. Special trigger burst and APV setting were used to trigger HIP events allowing to provide 29 consecutive events recorded every 25 ns, resulting in data over a 750~ns period. All modules were operated in the peak mode and the output data were equivalent to the CMS VR data format. 


%-measured probability per pion per sensor plane ins lower than 10-3

%-sensors 320 or 500 mum

\subsubsection{Response of the APV25 chip to the HIP events}

As discussed above, the highly ionizing particle leaves very localized large energy depositions up to the equivalent of $\sim$1000 MIPs and thus saturates the APV chips. The affected channels collect a charge beyond the range of the APV which is of order of a few tens of MIPs. The remaining channels from the 128-channel APV are shifted towards the low part of the APV range and even exceed it. This behavior results in the cross-talk effect on the APV chip worsened by the biasing scheme powering inverter and shaper which ensure stable CMN during the normal conditions~\cite{Bainbridge:2004jc}. 

Because of the shift of CMN the HIP events can be easily identified thanks to a requirement on value of the baseline. In this study, an APV chip, which exhibited baseline$\leq$-20~ADC during the period of 750~ns trigger burst, was tagged as containing a  HIP candidate. The response of the APV chip on the HIP event is shown in Fig.~\ref{fig:figures/thesisEvolution}. Each plot of Fig.~\ref{fig:figures/thesisEvolution} presents the data from 6 consecutive TOB modules~(on the y-axis) after pedestal subtraction at a different time. The x-axis depicts all channels of one module and the indivudal y-axes show the ADC values for all these channels. The normally operating module is e.g. top module in bottom-left plot~($T_{event}$ = 525~ns), where all APVs have their baseline around a nominal value. In this module MIP signal can be seen in the second APV. In Fig.~\ref{fig:figures/thesisEvolution} the HIP signal can be also observed. The top-left plot~($T_{event}$ = 300~ns) shows the first evidence of the HIP event. In the second module from bottom, in the second APV, the large signal peak and a small shift of other channels towards low values of the APV range can be observed . After 50~ns~($T_{event}$ = 350~ns) the channels of the affected APV, which are not collecting the HIP signal, are suppressed and thus the signal peak is fully revealed. The suppression of the numerous channels as well as the large signal peak can be still observed at $T_{event}$ = 525~ns. At $T_{event}$ = 575~ns, the channels start to recover to their initial position. It is interesting to note that at $T_{event}$ = 525~ns~(x$\sim$33~mm) and $T_{event}$ = 575~ns~(x$\sim$33~and~50~mm) a MIP passes through all six layers of the modules. The signal is observed in the APVs of all layers except of the one affected by the HIP event. The time period, during which an APV is insensitive to a MIP signal is referred as the dead-time.

    \insertFigure{figures/thesisEvolution} % Filename = label
                 {1}       % Width, in fraction of the whole page width
                 {Example of the time evolution of the APV behavior as a response to a HIP event which can be seen in the second module from bottom. The ADC values of pededestal subtracted data~(y-axis) of six layers of TOB modules~(y-axis direction) in four time-stamps are plotted for all channels of one module~(x-axis)~\cite{Bainbridge:2004jc}.} % Caption

The CMN distribution can be seen in the bottom plot of Fig.~\ref{fig:figures/CMNandRMSrawPast}. The CMN distribution is peaking around 0~ADC during the standard conditions, while a smaller peak around $\sim$-100~ADC comes from suppressed baselines which are result of the HIP events. 

In this analysis the selected HIP event satisfies the selection requesting CMN$\leq$-20 and the HIP cluster seed charge larger than 125~ADC. Therefore in Fig.~\ref{fig:figures/thesisEvolution} the HIP event is associated with the event at $T_{event}$ = 350~ns, but as shown in the example, the signal from the real HIP interaction occurred and was partially observed already 50~ns before the ``selected HIP'' event.

    \insertFigure{figures/CMNandRMSrawPast} % Filename = label
                 {0.6}       % Width, in fraction of the whole page width
                 {(top) The RMS spread of raw data~($\sigma_{raw}$). The large peak around 1.5~ADC corresponds to standard baselines, while the peak $\sim$ is caused by fully suppressed baselines. (bottom) The CMN distribution, in which the nominal baselines are located around zero and fully supressed baselines are peaking around -100~ADC~\cite{Bainbridge:2004jc}.} % Caption


%Fully suppressed baselines remain suppressed for around 250ns

\subsubsection{Dead-time induced by the HIP events}

As seen in the example, the HIP event is suppressing all channels from the affected APV which are not collecting signal. Large HIP signals then result in a full suppression of the channels beyond the lower limit of the APV range. The APV with fully suppressed channels exhibit a very small RMS spread~($\sigma_{raw}$) of the data before pedestal subtraction~(raw data), if excluding the channels reading signal. The RMS spread of raw data is shown in top part of Fig.~\ref{fig:figures/CMNandRMSrawPast}, where the population in the large peak corresponds to the normal operation RMS spread values around $\sim$1.6~ADC, which are reproducing the spread of pedestals. The smaller peak population with an RMS spread lower than 1~ADC is coming from fully suppressed baselines not anymore sensitive to the pedestal spread. The tail of the distribution is populated by data with distorted baselines usually originating from the HIP event, and which results in a non-uniform suppression and recovery of the baseline in response to the HIP event.

Based on these observations two event categories were defined: the ``fully suppressed'' and the ``partially suppressed'' baseline events. Events with ``fully suppressed'' baselines satisfy $\sigma_{raw}< 1~\mathrm{ADC}$. ``Partially suppressed'' baselines are required to to have $\sigma_{raw}\geq$1~ADC and CMN$\leq$-20~ADC.

In the laser simulations of HIP events, during which charge has been induced in tracker sensors by laser, the recovery of baseline and signal in terms of S/N has been studied~\cite{Adam:2005pz}. It was shown in Fig.~\ref{fig:figures/baselineAndSignalRecovery} that the S/N recovers differently and by different velocity than baseline. Thus to estimate the dead-time and hit efficiency induced by an HIP event, the hit and track information was used.

    \insertFigure{figures/baselineAndSignalRecovery} % Filename = label
                 {0.6}       % Width, in fraction of the whole page width
                 {The recovery of the baseline~(circles) and S/N~(triangles) (expressed as a ratio of the measured S/N to the reference S/N) as a function of time. The evolution is shown for an inverter resistor value of $50~\mathrm{\Omega}$ and an energy deposit of 25~MeV~\cite{Adam:2005pz}.} % Caption

The dead-time of the APV is evaluated in terms of hit efficiency~($\epsilon_{hit}$) separately for APVs influenced by the HIP event~($\epsilon_{hit}^{HIP}$) and for efficient APVs which are not influenced by the HIP event~($\epsilon_{hit}^{good}$). The hit efficiency is defined as $\epsilon_{hit} = N_{hit}/N_{tracks}$, where $N_{hit}$ is the number of clusters reconstructed in the APV around the track intercept point, and $N_{tracks}$ is the number of reconstructed tracks traversing the APV. The dead-time is then time interval during which the APV is not fully efficient~($\epsilon_{hit}^{HIP}$ < $\epsilon_{hit}^{good}$). The averaged dead-times for the APVs with the fully suppressed baselines are shown in table~\ref{fig:figures/tableDeadtimes} for both inverter resistor values of 50~$\Omega$ and 100~$\Omega$. The APVs with partially suppressed baselines exhibit much smaller dead-time compared to the previous case, typically in order of a few tens of ns. In table~\ref{fig:figures/tableDeadtimes}, it can be noticed that the reduced resistor value significantly decreases the dead-time. Although, diminishing the resistor value has its disadvantage which is the enhancement of the baseline distortions, leading to the reconstruction of ``fake'' clusters~\cite{Bainbridge:2004jc}.

    \insertFigure{figures/tableDeadtimes} % Filename = label
                 {0.4}       % Width, in fraction of the whole page width
                 {The mean~($\Gamma_{mean}$) and maximum~($\Gamma_{max}$) dead-time of the APV chip induced by HIP events for fully suppressed~($\sigma_{raw}<1~ADC$) baseline events. The dead-times were evaluated for two different module geometries~(TIB or TOB) as well as two inverter resistor values~(100 or 50~$\Omega$)~\cite{Bainbridge:2004jc}.} % Caption


\subsection{Probability of HIP event in the tracker module}

At the PSI beam test, the measurement of the HIP probability was also provided. The HIP probability labelled as~$P_{HIP}(CMN_{HIP}\leq CMN_{threshold})$ is defined as 

\eq{HIPprob}
{
P_{HIP}(CMN_{HIP}\leq CMN_{threshold}) = \frac{N_{HIP}(CMN_{HIP}\leq CMN_{threshold})}{N_{path}},
}

where $N_{HIP}(CMN_{HIP}\leq CMN_{threshold})$ is the number of selected HIP events with a baseline value~($CMN_{HIP}$) lower than the threshold~$CMN_{threshold}$ and $N_{path}$ is the number of tracks traversing the sensor.

The HIP probability measurements were provided with a pion beam of $300~\mathrm{MeV}$ energy, which is the most probable energy value of pions in the CMS tracker. The measured probability for the different modules, using $CMN_{threshold}=-20$, was found out to be of order $10^{-3}$. It was also concluded that the HIP probability does not scale with the beam intensity, but rather with the sensor thickness. The HIP probability is lowered by changing the inverter resistor value from $100~\mathrm{\Omega}$ to  $50~\mathrm{\Omega}$. A similar measurement was provided using a proton beam of  $300~\mathrm{MeV/c}$ momentum, which in this case is not compatible with the CMS conditions.


\section{Studies of the HIP events with the CMS pp collision data}

\subsection{Strategy of the HIP studies}

As explained in the section~\ref{sec:APV} the Zero Suppression mode is used in the standard data-taking . During the ZS procedure, all negative channels after pedestal subtraction are truncated to zero, this mode is thus not suitable to study the HIP events, which are known for causing a drop of the CMN as described in section~\ref{sec:HIPinPast}. The solution is to arrange data-taking in the Virgin Raw mode, what comes with a cost of an increased event size. In the VR data, no subtraction or suppression is applied but the ZS can always be performed offline, providing then the possibility to compute the CMN and proceed with clustering and further data treatment. In the following analyses, the CMN has been computed from all 128 raw digis after pedestal subtraction as a median over these 128 strips. The RMS spread~($\sigma_{raw}$) has been computed from the raw digis of 80\% of the 128 channels having the lowest ADC value, to avoid the clusters in this computation. The ZS and clustering have been performed as in the standard data-taking ( i.e. truncation to zero, truncation of digis to 8 bits) to mimic the standard data-taking output.

The goals pursued in the further presented studies are to select a HIP event and study the influence of such events on the electronics and the clustering. As seen in previous studies in section~\ref{sec:HIPinPast}, the recovery time of the cluster efficiency is of the order of O(100)~ns. Thus to be able to study the evolution of the CMN and the cluster properties, consecutive events in a window of a few hundreds of ns are needed. However the probability to record closely spaced events in time is very low without special trigger configuration. The possibilities for a new trigger configuration are very limited due to the increased size of events during the VR data-taking by factor of O(10) compared to the standard ZS data taking. Moreover in order not to overload the CMS data acquisition system, the following trigger criteria are imposed on the number of triggers in a given number of bunch crossings~(bx)~\cite{website:VRtrigger}:

\begin{itemize}
\item{no more than 1 trigger in 3 bx,}
\item{no more than 2 triggers in 24 bx,}
\item{no more than 3 triggers in 100 bx,}
\item{no more than 4 triggers in 240 bx.}
\end{itemize}

Another protection of the acquisition system, used for the runs analyzed in following sections, was the requirement that triggered events have to be spread over many data streams to ensure that consecutive events are stored in different files. Because of this limitation, the sorting and ordering of the events had to be performed beforehand.

In the following sections of this chapter, for simplicity, are shown only plots for the first layer of TOB, which exhibited the largest drop in the hit efficiency. Although, the fraction of HIP events for a given APV, defined as


\eq{HIPfrac}
{
f_{HIP} = \frac{N_{HIP}}{N_{all}},
}

where $N_{HIP}$ is the the number of selected HIP events per APV and $N_{all}$ is the total number of events per APV, is also computed in average for all layers of the strip tracker in order to complement the study with a more global picture.

%To be able to run the study in reasonable time and with reasonable amount of resources, the reduction of the data was done based on 

\subsection{First study of the HIP events in the CMS detector~\label{sec:firstStudy}}

\subsubsection{Motivation to study HIP effect with the CMS detector}

As introduced in section~\ref{sec:hitIneff} the CMS detector faced an important hit inefficiencies in 2015 and 2016. At that time, the HIP effect was identified to be most probably the source of these tracking inefficiencies. A lot of efforts were therefore put into the studies of the HIP effect from many perspectives. One of the option was to analyze Virgin Raw data, from which the pure output of the APV can be obtained. In the following study, the VR data were used to characterize the HIP effect and evaluate its impact on the electronics and clustering. The presented study provides first results on the HIP effect with the CMS data.

\subsubsection{Experimental setup} 

This study is based on VR data taken on the $12^{th}$ of April 2016: CMS run 273162 during the LHC fill 4915, with only silicon strip tracker included in the run. The run lasted 23 minutes and 33 seconds, with an initial instantaneous luminosity of 1548$\times 10^{30} \mathrm{cm^{-2} sec^{-1}}$ and an end instantaneous luminosity of 1538$\times 10^{30} \mathrm{cm^{-2} sec^{-1}}$. During this run, all APVs were operating in the deconvolution mode. The LHC delivered beams with 601 bunches each, among which 589 pairs of bunches collided at CMS. The average pile-up (interactions per bx) for this fill was 26. The beams were mainly composed of 72 bunches long trains, in which bunches were spaced every 25~ns.

Closely spaced events were enriched in data by using a special trigger configuration, which forced the first bunch crossing in a fixed train to be triggered. After this trigger, two other bunch crossings in the same train were triggered randomly. Then the trigger waited for the same train in next orbit. 

%The final number of triggered events as a function of the bunch crossing is shown in Fig.~\ref{fig:figures/triggerStudyFirst}. The shape of the trigger distribution is given by the trigger rules after the forced trigger on the first bx in the train.

%-trigger rules: %https://indico.cern.ch/event/512685/contributions/2167961/attachments/1273330/1887985/virgin_raw_test_2016_ebutz.pdf

    %\insertFigure{figures/triggerStudyFirst} % Filename = label
    %             {0.6}       % Width, in fraction of the whole page width
    %             {Number of triggered events as a function of bunch crossing.} % Caption


 \subsubsection{Methodology}
 
%HIP in module

In section~\ref{sec:HIPinPast}, it has been observed that HIP event can be identified via a low value of the baseline. Applying this approach to the CMS data allows to select the event shown in Fig.~\ref{fig:figures/peakinmodule}. In this example the expected effect of the HIP event on the chip can be seen: a negative baseline, a large signal on few channels and a low RMS spread of the raw digis. But in many cases the large signal is not observed as shown in Fig.~\ref{fig:figures/nopeakinmodule}, in contradiction to what has been observed in the study of section~\ref{sec:HIPinPast}. This difference can be explained by the different operation mode of the APV: a deconvolution mode was used for studies at CMS while for the HIP studies at PSI it was a peak mode. During studies of the APV chip behavior when large charges were injected to the calibration circuit~\cite{Bainbridge:2002bda}, it has been observed that, the large signals can be observed only for few ns when APVs are operated in the deconvolution mode and then the affected channels are also driven to the low range of the APV. 

%TODO figure module with APV with saturated baseline and peak
    \insertFigure{figures/peakinmodule} % Filename = label
                 {0.6}       % Width, in fraction of the whole page width
                 {Example of distribution of raw digis~(pink), pedestal subtracted digis~(blue), baselines~(red) and clusters~(green) as a function of the strip number in one module. The third APV in the module is showing a behavior induced by a HIP event: low charge variation for the suppressed channels and a large observed signal for few channels. } % Caption
%TODO figure module with APV with saturated baseline and without  peak
    \insertFigure{figures/nopeakinmodule} % Filename = label
                 {0.6}       % Width, in fraction of the whole page width
                 {Example of distribution of raw digis~(pink), pedestal subtracted digis~(blue), baselines~(red) and clusters~(green) as a function of the strip number in one module. The third APV in the module is showing a behavior induced by a HIP event: low charge variation for the suppressed channels, but in this case all channels are driven beyond the low range of APV and thus no large charge deposit is observed. } % Caption

A reliable selection of APVs influenced by HIP events can be designed via the presence of the fully saturated baselines. From the analysis of the correlation of the baseline and $\sigma_{raw}$ values in Fig.~\ref{fig:figures/baselinevsRMSrawFirst}, it is obvious that the standard events with a nominal value of the baseline around 128~ADC have a $\sigma_{raw}$ value of order of a few ADC units. The second largest population has a small value $\sigma_{raw}$ and a fully saturated baseline, which can be connected with large energy deposits in the sensor read by the given APV chip. Based on the correlation between the baseline and $\sigma_{raw}$, the selection of HIP events has been chosen to be 

\eq{selection}
{
CMN<-25~\mathrm{ADC}~\mathrm{and}~\sigma_{raw}<2.5.
}

%TODO figure vs RMS
    \insertFigure{figures/baselinevsRMSrawFirst} % Filename = label
                 {0.6}       % Width, in fraction of the whole page width
                 {2-D distribution of the RMS spread of raw digis versus the baseline for run 273162. On the x-axis there are baseline values in ADC and on the y-axis RMS spread in ADC of the raw digis in the APV. The large yellow bulk is the population of baselines with nominal value andi the RMS spread of few units of ADC. The smaller yellow population are fully saturated baselines, which exhibit low value of baseline and low value of RMS spread. } % Caption

In the Fig.~\ref{fig:figures/baselinevsRMSrawFirst}, there are many events with a negative value of baseline, but a large value of $\sigma_{raw}$. These events can originate from the baseline drop, the baseline recovery or from the large energy deposits, but not large enough to fully saturate the baseline. In order not to mix the different populations, the partially saturated baseline events are not selected as HIP events. 

It has also been observed that the full saturation can last for several bunch crossings as shown in section~\ref{sec:limitationsSelection} and consequently more conecutive events can be selected as a HIP for a given APV. In this case, the first event of the possible events is defined as the selected HIP. As the saturation of baseline is a consequence of the HIP interaction, the HIP event does not have to be selected at the time when the real HIP interaction has occurred in the sensor. 

%Other possibilities how to select HIP event will be discussed in section~\ref{sec:limitationsSelection}.

The analysis of the APVs influenced by the HIP event has been performed statistically. For that purpose, when the HIP event has been selected, the bunch crossing of this event has been redefined to bx=0, the bunch crossings of two remaining events in the same train have been set relatively to the HIP event, e.g. when an other event has been triggered five bx after the selected HIP, its bx has been set to 5. Then the average information per each bx has been plotted. The APV-averaged baseline distribution as a function of bx, is shown in Fig.~\ref{fig:figures/baselineFirst}, which allows to study what happened before and after the selected HIP. When tracking the baseline evolution in time, the baseline shows a stable value around 128~AD long before the HIP occures~(bx$\ll$0). Shortly before the selected HIP the baseline starts to drop as a consequence of the large energy deposition in the sensor. At bx=0, by definition, the baseline is saturated. The baseline recovers to normality in $\sim$15~bx and slightly overshoots for the remaining duration of the train (TODO why overshoot?).

A similar distribution for $\sigma_{raw}$  as a function of bx is shownin Fig.~\ref{fig:figures/rmsFirst}. Long before the HIP event, $\sigma_{raw}$ is stable with a value around 8. Right before the selected HIP, $\sigma_{raw}$ increases due to a non-uniform drop of the baseline and recovers in around 10~bx. Up to this recovery point, the baseline can be fully or partly saturated what explains the low $\sigma_{raw}$ value. This population is however mixed with distorted baselines which on the other hand have large $\sigma_{raw}$ and therefore part of the distribution of bx>0 cannot be straightforwardly interpreted.

%iTODO plot baseline
    \insertFigure{figures/baselineFirst} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {The averaged baseline evolution as a function of the bunch crossing number for run 273162. The bunch crossing of the selected HIP event is translated to the position bx=0. So events before~(after) the selected HIP have bx<0~(bx>0). The drop in the baseline due to the HIP event and following recovery can be observed in this distribution. The error bars are computed as a standard deviation of the baseline distribution in each bin. [TODO: I will probably use only one kind of error bars and do not write this info]  } % Caption
%TODO plot rms
    \insertFigure{figures/rmsFirst} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {The evolution of the averaged RMS spread of the raw digis as a function of the bunch crossing number for run 273162. The bunch crossing of the selected HIP event is translated to the position bx=0. So events before~(after) the selected HIP have bx<0~(bx>0). In the distribution the drop in the RMS spreadi can be observed, which is a sign of fully saturated baseline caused by HIP event. The error bars are computed as a standard deviation of the baseline distribution in each bin.  } % Caption

\subsubsection{Results}

As shown in Fig.~\ref{fig:figures/baselineAndSignalRecovery} the signal recovery, respectively the hit efficiency, and the dead-time  induced by HIP event cannot be estimated from baseline information and thus it is necessary to study clusters.

The distributions per APV of the average cluster multiplicity and the maximal cluster charge~(charge of the cluster with the largest cluster charge) as a function of the bx are shown in Figs.~\ref{fig:figures/avMultiplicityFirst}~and~\ref{fig:figures/maxChargeFirst} respectively. In these distributions, as previously, an average over the APVs is performed as well as the aligment of the selected HIP event with bx=0. The average cluster multiplicity present in Fig.~\ref{fig:figures/avMultiplicityFirst} is stable for events long before the occurrence of the HIP. Around bx=-5, the multiplicity grows as additional cluster(s) originating from the HIP interaction~(recoil or fragments) start to appear. As a consequence of the HIP deposit, the chip becomes inefficient in signal collection and already at bx=0, when the baseline is fully saturated, the cluster multiplicity drops significantly. The cluster multiplicity is recovered in $\sim$10 bunch crossings. The average cluster multiplicity distribution for bx>10 is flat with a constant higher than for bx<-10, in contradiction with expectations. The maximal cluster charge per APV shown in Fig.~\ref{fig:figures/maxChargeFirst} exhibits a stable behavior for bx<-20, followed by an increase in charge (TODO: why so early?). The cluster charges is the highest for the selected HIP as few channels can collect large charge induced by the HIP energy deposits. After bx=0, the cluster charge drops and recovers almost immediately after the selected HIP, but to a slightly lower level than before the HIP event, even though the same level as for bx$\ll$0 is expected. 

%The disagreements between distributions of bx$\ll$0 and bx$gg$0 for average cluster multiplicity and maximal cluster charge will be discussed in details in section~\ref{sec:}.

%TODO average cluster multiplicity

    \insertFigure{figures/avMultiplicityFirst} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {The averaged average cluster multiplicity evolution as a function of the bunch crossing number for run 273162. The bunch crossing of the selected HIP event is translated to the position bx=0. So events before~(after) the selected HIP have bx<0~(bx>0). Shortly before the selected HIP event the cluster multiplicity grows significantly due to the presence of the HIP cluster. The drop in the cluster multiplicity is caused by cluster inefficiencies resulting from the HIP event. The inequity in the y-axis value between bx$\ll$0 and bx$\gg$0 is observed. The error bars are computed as a standard deviation on the mean. } % Caption

%TODO max cluster charge
    \insertFigure{figures/maxChargeFirst} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {The averaged maximal cluster charge evolution as a function of the bunch crossing number for run 273162. The bunch crossing of the selected HIP event is translated to the position bx=0. So events before~(after) the selected HIP have bx<0~(bx>0).  Shortly before the selected HIP event the cluster charge grows significantly due to the presence of the HIP cluster. The inequity in the y-axis value between bx$\ll$0 and bx$\gg$0 is observed. The error bars are computed as a standard deviation on the mean. } % Caption

The mismatch between the cluster properties for bx$\ll$0 and bx$\gg$0, as shown in Fig.s~\ref{fig:figures/avMultiplicityFirst}~and~\ref{fig:figures/maxChargeFirst}, can be, at least partially, understood when analyzing the cluster charge distribution of all clusters of the first event in the train and other events in the train in Fig.~\ref{fig:figures/chargeFirstAndOtherInTrain}. For the first event in the train the cluster charge distribution exhibits a double peak structure of similar peak heights with maxima around 100~ADC and 200~ADC, while for the other events in the train, the height of the peak around 100~ADC is clearly dominant. The enhanced population of clusters around 100~ADC for the other events in the train, is coming from out-of-time pile up, which is not present in the first bunch crossing. In the train there are 3 events triggered, with one of them selected as a HIP event, so only the first or second event can be set to bx<0 and on the other hand only the second or third event can be set as bx>0. In consequence, the regions with bx<0 in Figs.~\ref{fig:figures/avMultiplicityFirst}~and~\ref{fig:figures/maxChargeFirst} are dominated by a population with a lower out-of-time pile-up and also a lower  average cluster multiplicity and higher maximal cluster charge than the regions of the distributions with bx>0. To avoid the mixing of different populations of events, the first event in the train has been removed from the distributions. The average cluster multiplicity without the first bunch crossing in the train is shown in Fig.~\ref{fig:figures/avMultiplicityCleanedFirst} and the maximal charge without first bunch crossing in the train in Fig.~\ref{fig:figures/maxChargeCleanedFirst}. In both distributions, the removal of the first bunch crossing leads to a significant equalization between the levels for the bx$\ll$0 and bx$\gg$0 .

%TODO cluster charge for the first event in train
   \insertTwoFigures{figures/chargeFirstAndOtherInTrain} % Filename = label
                 {figures/chargeFirstInTrain} % Filename = label
                 {figures/chargeOtherInTrain} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {[TODO: will be one overlayed plot] The cluster charge distribution of events from the first~(blue circles) and the other~(red triangles) bunch crossing in the train for run 273162. In both distributions, the two peaks around 100~ADC and 200~ADC correspond to off-track and on-track clusters, respectively. } % Caption
%TODO cluster charge distribution for other eventsin the train


%TODO corrected cluster charge
%TODO corrected cluster multiplicity
    \insertFigure{figures/avMultiplicityCleanedFirst} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {The averaged average cluster multiplicity as a function of the bunch crossing number for run 273162. The bunch crossing of the selected HIP event is translated to the position bx=0. So events before~(after) the selected HIP have bx<0~(bx>0). The events from the first bunch crossing in the train are not included in this distribution. Shortly before the selected HIP event the cluster multiplicity grows significantly due to the presence of the HIP cluster.  The drop in the cluster multiplicity is caused by cluster inefficiencies resulting from the HIP event. The inequity in the y-axis value between bx$\ll$0 and bx$\gg$0 is diminished compared to Fig.~\ref{fig:figures/avMultiplicityFirst}. The error bars are computed as a standard deviation on the mean. } % Caption

%TODO max cluster charge
    \insertFigure{figures/maxChargeCleanedFirst} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {The averaged maximal cluster charge as a function of the bunch crossing number for run 273162. The bunch crossing of the selected HIP event is translated to the position bx=0. So events before~(after) the selected HIP have bx<0~(bx>0). The events from the first bunch crossing in the train are not included in this distribution. Shortly before the selected HIP event the cluster charge grows significantly due to the presence of the HIP cluster. The inequity in the y-axis value between bx$\ll$0 and bx$\gg$0 is diminished compared to Fig.~\ref{fig:figures/maxChargeFirst}. The error bars are computed as a standard deviation on the mean. } % Caption

The average dead-time for the modules of the first layer of the TOB can be estimated from Fig.~\ref{fig:figures/avMultiplicityCleanedFirst}. The dead-time, defined as the time interval between the selected HIP event and the full recovery of the average cluster multiplicity, appears to be $\sim$250~ns~(10~bx). The recovery of the cluster multiplicity does not imply the full recovery of the charge collection, which should be deduced from the recovery of the maximal cluster charge shown in Fig.~\ref{fig:figures/maxChargeCleanedFirst}. However the recovery seems to be almost immediate and no obvious trend is observed. This effect is most probably caused by mixing of real and fake clusters, i.e. clusters associated and not associated with the tracks, respectively. This mixing could be reduced by using on-track clusters only.

The fraction of HIP events averaged per APV in the first layer of the TOB, defined by Eq.~\ref{eq:HIPfrac}, was estimated to be [TODO]...., as shown in Fig.~\ref{fig:figures/HIPfrac} . This fraction is dependent on the run instantaneous luminosity and therefore does not represent the probability of a HIP event as defined in Eq.~\ref{eq:HIPprob}. To estimate the HIP probability, the average number of reconstructed tracks per event per APV must be known. The average fraction of HIP events is biased by the used trigger which forbids to record also the second and third bunch crossings in the train, due to the first trigger rule. The HIP interactions, occurring in the first bx and fully saturating the baseline only in the second and/or third bx of the train, are never selected.
 
%TODO the fraction of HIP low
    \insertFigure{figures/HIPfrac} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {Fraction of HIP events, or probability, per layer, or more layers... lets see... } % Caption

\subsubsection{Limitations of the study~\label{sec:limitationsSelection}}

Several limitations of the presented study have already been discussed in the text above. In summary, among the mentioned limitations belongs the different fraction of out-of-time pile-up in different events, this has been solved by removing the events from the first bunch crossing in the train from the clusters charge and width distributions. Then no tracking is performed, and thus both real and fake clusters are used in this analysis, on top of that the fraction of real and fake clusters can change as a result of the HIP event. There is also an empty window in the triggered events caused by the first trigger rule as seen in Fig.~\ref{fig:figures/triggerStudyFirst}, which leads to the underestimation of the average fraction of HIP events per APV.

%TODO did I miss something from the limitations?

A large limitation of this study comes from the ambiguity in the selection of the HIP events. It can be understood by looking at Fig.~\ref{fig:figures/RMSrawVSbx} showing the $\sigma_{raw}$ per APV as a function of bunch crossing, with bx=0 is selected HIP event. In the bottom-right part of the plot, there is a large population of APVs with $\sigma_{raw}$<2.5 for bx>0, corresponding to very large energy depositions keeping the baseline fully saturated for several bunch crossings. Due to this uncertainty, it is impossible to determine the exact time of the HIP interaction in the sensor and therefore all distributions shown above with the selected HIP aligned to bx=0 are effectively smeared. 

%Also because of the full baseline saturation druning more bx the fraction of HIP events, when using selection on fully saturated beaselines, is lower during the first few events in the train than for the rest of train.

A possible improvement of the HIP selection has been investigated by trying to define selection criteria on the clusters. A first tentative is to select large charge deposits by tagging the saturated clusters with an ADC value of at least one channel inside the cluster larger than 1022. Fig.~\ref{fig:figures/fractionOfSaturatedClusters} shows the fraction of APVs with saturated clusters with respect to all clusters as a function of bx, where bx=0 is the selected HIP by criterion~\ref{eq:selection}. The fraction of saturated clusters is significantly high only for bx=0, which is already a selected HIP event. Moreover as discussed in Fig.~\ref{fig:figures/avMultiplicityCleanedFirst}, the average cluster multiplicity per APV is very low for bx=0, so a requirement on the saturated cluster would only result in a large reduction of statistics. Another approach is to study the maximal cluster width per APV as a function of bx, shown in Fig.~\ref{fig:figures/largestClusterWidth}, but no obvious trend is observed in the distribution. 

%TODO RMS_raw vs BX
    \insertFigure{figures/RMSrawVSbx} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {The 2-D distribution of RMS spread in ADC~(y-axis) as a function of the bunch crossing number~(x-axis) for run 273162. The bunch crossing of the selected HIP event is translated to the position bx=0. So events before~(after) the selected HIP have bx<0~(bx>0). Presence of the population with bx>0 and $\sigma_{RMS}$<2.5 is revealing that the full baseline saturation can last for more buch crossings. The events from the first bunch crossing in the train are not included in this distribution. [TODO wrong plot - I did not want profile] } % Caption
%TODO fractionOfSaturatedClusters
    \insertFigure{figures/fractionOfSaturatedClusters} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {The averaged fraction of saturated clusters with respect to all clusters as a function of the bunch crossing  number for run 273162. The bunch crossing of the selected HIP event is translated to the position bx=0. So events before~(after) the selected HIP have bx<0~(bx>0). The events from the first bunch crossing in the train are not included in this distribution. As expected, the fraction of saturated clusters are significantly high for bx=0. No other striking trend is observed. The error bars are computed as a standard deviation of the baseline distribution in each bin.  (TODO I guess x axis is not really a fraction - needs to be checked) } % Caption
%TODO largest cluster width
    \insertFigure{figures/largestClusterWidth} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {The 2-D distribution of the cluster width versus the bunch crossing number for run 273162. On the x-axis, the bx=0 is bunch crossing of the selected HIP event. Events before~(after) the selected HIP have bx<0~(bx>0). On the y-axis there is average cluster width per APV. No obvious tren is observed in this distribution. } % Caption

%-OOT HIP

\subsubsection{Change of the APV configuration settings}

During the late 2015 and first half of 2016, the HIP interaction in silicon sensors under the CMS conditions was studied from many perspectives. The probability of the HIP effect was found to be too low to explain the magnitude of observed inefficiencies and the CMS collaboration has thus tried to find other causes this hit inefficiency. In August 2016, the major source was found in the setting of the APVs themselves.

For the data taking, the APV's Preamplifier Feedback Voltage Bias~(VFP) was set according to the APV manual to $\sim$30~V to obtain the ideal CR-RC pulse shape. This parameter controls the drain speed of the preamplifier, a lower parameter results in a faster drain speed. Because of the increase of the APV occupancy, due to shortening the bunch spacing and increasing the instantaneous luminosity, the drain speed was not fast enough anymore, leading to the saturation of the preamplifier by semi-large charge deposits~(10-100~MIPs). The APV chip saturated by this effect became inefficient up to its recovery at the end of the train or the run. These findings led to a new setting the VFP parameter to 0~V. Consequently the significant recovery of the hit efficiency as shown in Fig.s~\ref{fig:figures/effAsLayer}~and~\ref{fig:figures/effAsLumi} has been observed.


%TODO  plot of the distribution of largest cluster charge in train (PBXvsCHall) -from my group presentation: /home/mjansova/Downloads/presentations/thesisDirectory/literature_HIP/my_old_presentations/groupPresentation_v2.pdf
\subsection{Study of the HIP events after change of the APV settings}

\subsubsection{Motivation}

After identifying and fixing the main source of APV inefficiencies, a new VR data run was scheduled. This run has provided an opportunity to study a clean HIP effect, not affected by the APV dynamic inefficiency. The goal of the study with this data is to check if the HIP event can still observed and if it manifests in a similar way.

%presenteation of Erik at WGM

\subsubsection{Experimental setup}

A new VR data run 281604 of duration 48 minutes 45 seconds, was taken 25$^{th}$ of September 2016. The subdetectors included in this run were both the silicon pixel and strip tracker, the ECAL, the HCAL and all muon chambers. This run was part of the fill 5330, during which only four isolated bunches per beam were injected into the LHC. The average pile-up of the fill was 48 interactions per bunch crossing. The instantaneous luminosity of the run started at 17.38$\times 10^{30} \mathrm{cm^{-2} s^{-1}}$ and ended at 16.48$\times 10^{30} \mathrm{cm^{-2} s^{-1}}$. During the run, all APVs were taking data in the deconvolution mode. 

In this run the trigger fired on the fixed bx=2306 in each orbit, further referred as ``first event''. After the first trigger, the trigger fired every 75~ns during 450~ns. This means that per one orbit, 7 events spaced by 3~bx were thus triggered, but only the first one really contained bunch collisions. The trigger setup was very special as all trigger rules were violated except the first one.


The character of the run and  the data-taking setup resulted in many differences compared to the study presented in section~\ref{sec:firstStudy}, later referred as the ``previous study''. As bunches collided only during the first triggered event, the particle causing the HIP interaction had to originate from this bunch crossing, so in this sense, the time of the HIP occurrence is fixed. In addition, because of the fill structure with isolated bunches, there is no out-of-time pile-up for the first event.

\subsubsection{Methodology}

In order to design the selection of HIP events dedicated to this run, the correlation of baseline and $\sigma_{raw}$ per APV has been analyzed. The distribution presented in Fig.~\ref{fig:figures/baselineVsRMSSecond} is very similar to the one of the Fig.~\ref{fig:figures/baselinevsRMSrawFirst} for the previous study. This implies that the manifestation of the HIP events has not changed with the change of the APV settings, consequently the same HIP selection, defined in equation~\ref{eq:selection}, can be used.

%TODO plot baseline vs rms
%TODO figure vs RMS
    \insertFigure{figures/baselineVsRMSSecond} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {2-D distribution of the RMS spread of raw digis versus the baseline for run 281604. On the x-axis there are baseline values in ADC and on the y-axis RMS spread in ADC of the raw digis in the APV. The distribution is very similar as the one of Fig.~\ref{fig:figures/baselinevsRMSrawFirst} for run 273162. } % Caption

As the time associated to the creation of the particle causing the HIP event is fixed in this study by bx=2306, no redefinition of the bunch crossing position is needed and hence the properties of the selected HIP event and the other 6 events in the same orbit can be shown as function of the real bunch crossing~(respectively time).

The APV-averaged baseline evolution as a function of the bunch crossing is shown in Fig.~\ref{fig:figures/baselineSecond}. The recovery of baseline occurs in less than 12 bunch crossings, which is a slightly faster recovery than in the previous study. Then here also the baseline overshoots for the remaining events in one orbit, even to a higher level than in the previous study. Note that the baseline decreases between the first and second event, not all baselines are fully saturated yet during the first event. The first occurrence of the fully saturated baseline as a function of the bunch crossing is displayed in Fig.~\ref{fig:figures/saturationSecond}. It can be observed that $\sim 50\%$ of the HIP events lead to a fully saturated baseline already in the first event. In the other events, the saturation (TODO - plot not the best one)....

%TODO baseline evolution
    \insertFigure{figures/baselineSecond} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {The averaged baseline evolution as a function of the bunch crossing number for run 273162. The drop in the baseline due to the HIP event and following recovery can be observed in this distribution. The trend of this distribution is very similar to the one shown Fig.~\ref{fig:figures/baselinevsRMSrawFirst} for run 273162. The error bars are computed as a standard deviation of the baseline distribution in each bin.  } % Caption
%TODO saturation plot vs bunch crossing
    \insertFigure{figures/saturationSecond} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 { The first occurrence of fully saturated baseline as a function of bunch crossing. (TODO finish after finishing the new plot) } % Caption
 

\subsubsection{Results}

To study the cluster multiplicity and the cluster charge per APV, four categories of events have been defined, as in Tab.~\ref{tab:eventCategories}. For an APV in a given orbit influenced by the HIP event, the cluster information of the first event belongs to the first category, while that of the remaining events to the second category. The cluster information from APVs for which no HIP event has happened during the given orbit belongs to the third category in case of the first event or to the fourth category otherwise. Thus in categories 2 and 4, only fake clusters are expected as no colliding bunches in CMS were present at those bunch crossings, in contrary to categories 1 and 3 which are populated by both real and fake clusters.

The average cluster multiplicity per APV is shown in Fig.~\ref{fig:figures/avClusterMultiplicitySecond} both for orbits influenced by a HIP event, in dots~(categories 1 and 2), and non-HIP orbits, in triangles~(categories 3 and 4). The average cluster multiplicity for the first event is non-zero because of the presence of collisions and it falls then to almost zero for other events where only fake clusters are present. In the case of HIP-orbits, the average cluster multiplicity for the first event is higher than before because of additional clusters originating from the HIP interaction. The other events exhibit also a significantly larger average multiplicity of fake clusters compared to non-HIP orbits. The average fake cluster multiplicity is increasing in time up to a constant level and does not vanish during the 6 events. These fake clusters resulting from the HIP event may have a much larger charge than the standard fake clusters as observed in Fig.~\ref{fig:figures/avClusterChargeSecond}. 

To understand the origins of the fake clusters, the average cluster multiplicity, charge and width as well as the fraction of clusters larger than 10 strips with respect to all clusters are calculated in Tab.~\ref{tab:clusterCategories}. From the table it is clear that the fake clusters resulting from a HIP event are significantly wider and have a larger charge than the standard clusters, because they are reconstructed from baseline distortions caused by a non-uniform recovery among the 128 channels.

The fake clusters in events after the HIP interaction can be dangerous for tracking as they can be used in the track reconstruction instead of the real clusters. But this effect scales with the probability of the HIP event, which is relatively small.

%TODO
The fraction of the HIP events in this study is measured to be [TODO]..., as shown in Fig.~\ref{fig:figures/fracHIP2} . As previously, the fraction of HIP events is biased by the trigger conditions. Only baselines which are already fully saturated in the first event or which are still fully saturated in the second event~(after 75~ns) can be selected as HIP events.


%TODO averge cluster charge
    \insertFigure{figures/avClusterMultiplicitySecond} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {The averaged average cluster multiplicity as a function of the bunch crossing number for run 273162. In pink circles is the average cluster multiplicity for HIP and events after HIP while in blue dots non-HIP events. For the collision event the cluster multiplicity is high as expected and in the case of HIP event it is even inhanced by the HIP cluster. After the multiplicity falls and only the fake clusters are observed. In the case of events after HIP the fake cluster multiplicity is significantly higher than for the normal events and remains high for all recorded events. The error bars are computed as a standard deviation on the mean. } % Caption

%TODO average cluster charge
    \insertFigure{figures/avClusterChargeSecond} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {The averaged cluster charge as a function of the bunch crossing number for run 273162. In pink circles is the average cluster charge for the HIP and events after the HIP while in blue dots non-HIP events. For the collision event the cluster charge is high as expected and in the case of HIP event it is even inhanced by the HIP cluster. After the cluster charge falls because only the fake clusters are observed. In the case of events after HIP the fake cluster charge is growing with time, becomes significantly higher than for the normal events and remains high for all recorded events. The error bars are computed as a standard deviation on the mean. } % Caption



\begin{table}[h]
\begin{center}
\begin{tabular}{|l|l|l|}
\hline
Category & Name  & Features \\
\hline
1 & HIP & Collision event when a HIP occurred \\
\hline
2 & After HIP & Event in the same orbit of a selected HIP \\
& & Not a collision event \\
& & Dominated by fake clusters \\
\hline
3 & Collision non-HIP & Collision event without any HIP \\
\hline
4 & Non-collision, non-HIP  & No HIP selected in a same orbit \\
& & Not a collision event \\
& & Dominated by fake clusters \\
\hline
\end{tabular}
\caption[Table caption text]{The four categories of clusters used for the study of run 273162. }
\label{tab:eventCategories}
\end{center}
\end{table}


\begin{table}
\begin{center}
%\topcaption{ Average cluster charge, multiplicity, width and fraction of clusters larger than ten strips.\label{tab:clusterSum}}
\resizebox{\linewidth}{!}{
\begin{tabular}{|l|cccc|}
\hline
Events/ & Average cluster  & Average cluster & Average cluster & Fraction of clusters \\
Quantities  & charge~[ADC] & multiplicity & width~[strip] & larger than 10 strips \\
\hline
HIP & 1083 & 1.116 & 8 & 0.08 \\
\hline
After HIP & 330 & 0.087 & 8 & 0.17 \\
\hline
Collision non-HIP & 427 & 0.492 & 5 & 0.05 \\
\hline
Non-collision, non-HIP & 239 & 0.003 & 3 & 0.03 \\
\hline
\end{tabular}}
\caption[Table caption text]{The average cluster charge, multiplicity and width and the fraction of clusters larger than 10 strips for four categories defined in Tab.~\ref{tab:eventCategories} for run 273162. The quantities are computed from both on-track and off-track clusters.}
\label{tab:clusterCategories}
\end{center}
\end{table}


%TODO the fraction of HIP low
    \insertFigure{figures/fracHIP2} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {Fraction of HIP events, or probability, per layer, or more layers... lets see... [TODO] } % Caption

\subsubsection{Limitations of the study}
 
In addition to the bias in the measurement of the number of HIP events due to the trigger, the limitation is the impossibility to perform the APV dead-time measurement with the analyzed data. Indeed, the event after the first one in orbit do not contain collisions and thus the cluster recovery cannot be studied. 

\section{Conclusion}
TODO
%-in the first data hip as well because off the same selection and same order of magnitude



%REMARKS
%-in my case the fraction of HIP is also eaffected by pile-up?!
%-computation how fake clusters affects tracking
%-what is the inverter resistor value first it was 100 but now changes to 50~\cite{Gennai:2003as}
%-change all past to present perfec
%zero light level -laser
