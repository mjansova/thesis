%\chapter{Study of the highly ionizing particles in the silicon strip tracker}

\clearpage

\setcounter{secnumdepth}{4}
\chapterwithnum{Study of the highly ionizing particles in the silicon strip tracker}
\setcounter{secnumdepth}{4}

This chapter focuses on the tracking inefficiencies of the CMS silicon strip tracker observed during years 2015 and 2016 and  on the studies of ``highly ionizing particles''~(HIP) which were identified as a possible cause of the inefficiencies. First, the tracking inefficiencies are described as well as the HIP events. Secondly details about the silicon strip tracker readout electronics and data reconstruction are introduced in order to understand the effect of highly ionizing particles on the silicon strip tracker and data acqusition. Past studies in the laboratory conditions~(with laster and test beam) of the highly ionizing particles are then shortly discussed as a starting point for new studies based on CMS pp collision data. In the Sections~\ref{sec:firstStudy} and ~\ref{sec:secondStudy}, two studies with the CMS pp data are performed, one in a perspective of identifying highly ionizing particles as a source of the observed tracking inefficiencies. The second study uses data after the fix of the largest source of inefficiencies and aims to purely characterize a HIP event and its consequences in the CMS environment.

\section{The tracking inefficiencies at the beginning of Run~2 and a first promising suspect~\label{sec:hitIneff}}

\subsection{Observed inefficiencies in the track reconstruction}
%TODO track must be known

At the start of the Run~2 2015D era, the time between collisions was shortened from 50~ns to 25~ns. During this era, with more data collected, the CMS collaboration started to observe large discrepancies between predicted and measured number of tracks: data showed less tracks and also shorter tracks than simulation. Such situation was a result of a cluster inefficiency in the silicon strip tracker, the loss of clusters left by charged particles translated into a loss of tracks. This kind of inefficiencies was already observed at the end of Run~1, especially in a lead collisions, but with much smaller impact. 

The observed inefficiencies were shown to depend on the distance from the interaction point~(IP) and also scale with the instantaneous luminosity~\cite{website:hitEff}. The left plot of Fig.~\ref{fig:figures/effAsLayerAndLumi} shows the hit efficiency, computed as the ratio of the number of hits associated to the reconstructed tracks to the number of expected hits, for the different layers of the barrels, the disks, and the endcaps. The right plot of Fig.~\ref{fig:figures/effAsLayerAndLumi} presents the hit efficiency as a function of the instantaneous luminosity. In these plots, the reduced hit efficiency, seen in 2015/2016 runs, is shown in red empty circles. In the figures it can be seen that the smallest hit efficiency was observed for the first layer of the TOB, in which up to 8\% of the hits were lost during the highest luminosity runs. For comparison, the red full circles stand for hit efficiency of the runs taken at the end of 2016, once the source of the largest hit inefficiency was eliminated, as discussed in later sections.


    \insertTwoFigures{figures/effAsLayerAndLumi} % Filename = label
                 {figures/effAsLayer}
                 {figures/effAsLumi} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {(left) Hit efficiency for the different layers of the barrels, the disks and the endcaps. The empty circles represent the hit efficiency measurement for the old front-end electronics~(APV) settings while the full circles depict the hit efficiency measurement after the new APV settings were deployed at the beginning of August 2016. The corresponding instantaneous luminosity for both runs is indicated in the legend. (right) Hit efficiency as a function of the instantaneous luminosity. The measurement is shown only for the first layer of the TOB for both the old~(empty circles) and new~(full circles) APV settings~\cite{website:hitEff}. } % Caption


%-less tracks
%-25ns/high lumi runs - fewer associated hits
%-correlation with increased instantenous luminosity
%-correlated with HIP effect
%-efficiency improves at first bx of train

%findings:
%-lower cluster charge
%-lower S/N
%-lower hit efficiency
%-shorter tracks
%-lower track efficiency

%https://twiki.cern.ch/twiki/bin/viewauth/CMS/SiStripHitEffLoss
%https://indico.cern.ch/event/560224/contributions/2265347/attachments/1320462/1980048/WGM_HIP_Boudoul.pdf
%https://indico.cern.ch/event/560226/contributions/2277448/attachments/1324704/1988050/wgm_vfp_change_ebutz.pdf
%https://twiki.cern.ch/twiki/bin/view/CMS/StripsOfflinePlots2016


%The inefficiencies were later linked with the limitations and configuration of the read-out electronics. TODO do I need to use it?


\subsection{Investigating the highly ionizing particles}

Among the various possible explanations of the observed hit inefficiencies, the hypothesis of Highly Ionizing Particles~(HIP) was considered with a great interest. To understand the effect of the HIP on the hit efficiency, it is required to first discuss the energy loss mechanism for charged particles in silicon. The main energy loss mechanism for charged particle in tracker silicon sensors is via the electromagnetic interaction, mainly via ionization described by the Bethe-Bloch formula~\cite{Groom:2000sm}. Beyond it, the incoming particle can also deposit energy in sensors via elastic and inelastic nuclear interactions with the silicon nucleus. These two nuclear interactions result in a nuclear recoil in the elastic case and a nuclear recoil and fragmentation in case of the inelastic interaction. A sufficiently energetic recoiled nucleus can also induce displacement of the other nuclei in its proximity. All affected nuclei as well as the nuclear fragments undergo energy loss by ionization, resulting in large and very localized energy depositions in the silicon volume. 

By simulation of these interactions in the silicon, it has been shown that elastic interactions do not lead to high energy depositions, while inelastic interactions can induce energy deposits up to about 100~MeV in 500~$\mathrm{\mu m}$ thick tracker sensors, which represents an energy deposit approximately 1000 times larger than by ionization only~\cite{Huhtinen:2002yda}. The Most Probable Value~(MPV) of the energy deposition in these sensors, originating from the inelastic interaction has been found to be around 10~MeV, corresponding to 100 times larger deposits w.r.t. to the majority of particle/silicon interaction which does not involve the nuclear interaction~\cite{Adam:2005pz}. The readout electronics of the tracker modules is designed for energy deposits up to around ten times higher than expected, thus such large energy deposits are resulting in saturation of the electronics, dead-time in the charge collection and a hit inefficiency. 

In summary, a HIP event is an event in which typically the inelastic interaction of the incoming particle with the silicon is a source of highly ionizing particles. These particles ionize the volume of the silicon sensor by far more than the majority of particles coming from collisions and they can thus saturate the readout electronics. The saturated electronics becomes therefore inefficient and insensitive to further incoming particles, resulting in a dead-time in a cluster reconstruction and thus in a loss of hits, which could explain the observed hit inefficiency.

\newpage

\section{The strip tracker readout system}

As the saturation of the readout electronics by the HIP event was found to be a plausible explanation of the observed inefficiencies, the tracker readout chain is introduced in this section to understand the behavior of the electronics under such conditions.

%The inefficiencies were later linked with the limitations of the read-out electronics. 

\subsection{Overview}

    \insertFigure{figures/dataFlow} % Filename = label
                 {0.4}       % Width, in fraction of the whole page width
                 {Overview of the tracker readout chain~\cite{Bainbridge:2004jc}. The charge collected by the the silicon strip implants and subsequently induced on the aluminium strips is read by the on-detector APV chips. The output of two APV chips is multiplexed and converted into an optical signal which is sent via optical link to the off-detector Front-End Drivers for further signal processing. } % Caption

The charge carriers created via the ionization of the silicon volume by a traversing particle, drift toward the electrodes. The current induced on the aluminium strips is read by an front-end chip called APV25~\cite{French:2001xb}, situated at the Front-End Hybrid, attached to the tracker module and bond to the tracker sensor. The analog signal from these chips is sent via optical links to the back-end electronic cards called Front-End Drivers~(FED)~\cite{Baird:2002wg} located in the control room. In standard data-taking configuration, the data are digitized and processed in the FEDs. The graphical overview of this data flow is shown in Fig.~\ref{fig:figures/dataFlow}. All these parts of the tracker readout are introduced with more details in following subsections.

\subsection{The silicon strip modules}

The sensitive volume of the CMS tracker modules is composed of the silicon strip sensors. A schematic sketch of a silicon strip sensor is shown in Fig.~\ref{fig:figures/siliconSensor}. Each silicon sensor is formed by a n-type bulk, which has on one side an uniform n+ backplane while p+ strip implants are located on the other side. The implants are connected to a reverse bias voltage to completely deplete the bulk of the sensors. The thickness of both p+ implants and n+ backplane is small and negligible compared to the bulk, almost the whole volume of the sensor is thus depleted. The signal collected at the p+ strips induces a current on the aluminium strips separated from the silicon strips by a thin layer of the silicon dioxide and nitride~(AC coupling). Each aluminium strip is connected by a wire bond to the read-out electronics. The distance between the silicon strips is called the pitch.

Depending on the type, the tracker modules have 512 or 768 p+ strips, and each 128 strips are connected to one front-end APV25 chip. The largest fraction of the modules has one layer of sensors~(mono modules), while the remaining part holds two layers of sensors  mechanically attached back to back and with a relative tilt of strips of $5.7^{\circ}$~(stereo modules). With two tilted sensor layers, stereo modules are able to provide 3-D information in the global coordinates about the hit position, where the particle has hit the module. The mono modules give only 2-D hit measurement as the third dimension depends on the strip length which is around ten cm, what is orders of magnitude larger than the strip width and thickness. The modules also differ by the sensor thickness which is either 320~$\mu$m or 500~$\mu$m and the pitch between each strip, which can vary from 80 $\mu$m up to 205 $\mu$m depending on the tracker layer and partition.

    \insertFigure{figures/siliconSensor} % Filename = label
                 {0.4}       % Width, in fraction of the whole page width
                 {A schematic sketch of the silicon sensor with n-type silicon bulk, p+ strips and n+ backplane. An incoming particle and the movement of charge carriers left by it is also drawn~\cite{website:sensor}. } % Caption

When a charged particle is crossing the silicon sensor, electron-hole pairs are produced along the path of the particle. The energy loss in the material can be described by the Bethe-Bloch formula~\cite{Groom:2000sm} as a function of $\beta\gamma = p/Mc$, where $\beta$ is the ratio of the interacting particle velocity to the speed of light, $\gamma$ is the Lorentz factor, $c$ is the speed of light, and $p$ and $M$ are the momentum and mass of the interacting particle. The Bethe-Bloch function has a minimum at $\beta\gamma \approx 3$. The majority of the charged particles produced in the pp collisions in the CMS detector have in a good approximation minimal $\beta\gamma$ values and are thus called Minimum Ionizing Particles~(MIP).

A signal starts to be induced on the aluminium strips once electrons and holes begin to drift towards the electrodes. Holes drift to the strips and electrons to the backplane~(n+ implant). The current induced at the aluminium strips can be calculated using the Shockley Ramo theorem~\cite{doi:10.1063/1.1710367,Ramo:1939vr}. In the framework of this theorem, it can be shown~\cite{Bloch:2007zza} that charge carriers drifting toward one strip induce as well current on the neighboring strips. The charge integrated over time on neighboring strips is zero and the collected charge on the main strip is equal to the charge created by ionization in the silicon bulk.

The number of strips collecting the charge carriers created by ionization depends on the charge sharing and the electronics cross talk between the strips. The charge sharing is a result of a propagation of the particle and created charge carriers through the silicon sensor. It can be caused by diffusion, trajectory inclination or effects of the magnetic field on the charge carriers. On the contrary, the electronics cross talk is independent of the porpagation of charges in the bulk of the silicon sensor and arises from the strip coupling via inter-strip capacitance.  

In case of the trajectory inclination, the charge carriers from the different parts of the trajectory are drifting towards different strips. 

If no magnetic field is present, the created charge carriers, electrons and holes, would drift directly towards the electrodes. But in the case of the tracker barrels~(TOB, TIB), a perpendicular magnetic field is applied  and consequently  a charge the carrier $q$ is deflected from the direction of the electric field due to the Lorentz force $\vec{F}$ defined by the equation

\eq{LorentzEquation}
{
   \vec{F}=  q(\vec{E}+\vec{v} \times \vec{B}),
}

where $\vec{E}$ is the electric field, $\vec{v}$ is the velocity of charge carriers and $\vec{B}$ is the magnetic field. The angle between the electric field lines and the drift direction of the charge carriers in the magnetic field is called the Lorentz angle. This angle is independent of the track inclination and can be compensated by tilting the tracker modules w.r.t. the magnetic field.

Finally, the diffusion of the charge carriers during the drift to the electrodes can also modify the path of the charge carriers from the straight line. However the spread of the charge carriers due to diffusion is in  the order of few $\mathrm{\mu m}$ and therefore about two orders of magnitudes smaller than the pitch size and it can thus only result in a small amount of charge collected by neighboring strips just in case the particle has passed close to the middle of the pitch~\cite{Bloch:2007zza}.


The electronics cross talk arises from the sensor capacitive network. Strips are coupled to backplane via a backplane capacitance and to neighboring strips via an inter-strip capacitance. The capacitive network of the silicon strip sensor and its electronics is shown in Fig.~\ref{fig:figures/capacitanceNetwork}. Due to the inter-strip capacitance, the charge collected by one channel~(strip) is shared between the neighboring channels. The coupling of neighboring strips depends strongly on the signal sampling time~\cite{Bloch:2007zza}, which can be different for different tracker readout modes. This effect can be studied numerically via the description of the capacitive network by the SPICE simulations~\cite{Barberis:1993ph}.


    \insertFigure{figures/capacitanceNetwork} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {A schematic view of a generic capacitive network of a silicon strip sensor and its respective readout electronics. The strips are inter-connected via the inter-strip capacitance $C_{int}$. On top of this connection, second neighboring strips are directly coupled by the capacitance $C_{s}$. Each strip is connected to the backplane via the capacitance $C_{sub}$. The strips are connected to amplifiers located at the top part of the schema~\cite{Lutz:1987wd}.}


%Chare sharing can be measured from eta function (response function) -eta function R/(L+R), two separate peaks at 0 and 1 if no charge sharing. Shoft because of electronic coupling. Width of the peak determined by the noise. Almost linear charge sharing outside of the peak (plateau) - amount of charge collected by a strip is inversly proportional to the distance of the impact point from that strip (linear charge sharing) - for perpendicular tracks negligible.


\subsection{The APV25 readout chip \label{sec:APV}}


    \insertFigure{figures/APVreadout} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {The schema of the internals of the APV25 chip. The stages before 128:1 MUX are implemented separately for each of 128 channels~\cite{Friedl:2001kra}. } % Caption

As already mentioned, the current of 128 channels is read out by one APV25~\cite{French:2001xb} chip, later referred as APV, which is a front-end chip providing amplification, shaping and sampling into single value of the signal received from each channel. To achieve this, the APV chip is equipped by a preamplifier, an inverter, a CR-RC shaper, an analog pipeline and a deconvolution filter for each of its 128 channels, as shown in Fig.~\ref{fig:figures/APVreadout}. Although these different stages are separate for each channel, to reduce instabilities, all inverters of one chip are powered by a common supply rail via an external inverter resistor. This biasing scheme ensures a stable signal, but on the other hand it introduces another source of cross talk between channels of one APV.

The amplified signal is sent to the inverter which is coping with the signal polarity and then to the CR-RC shaper to convert the strip signal into a voltage pulse with peaking time of 50~ns. The output of the shaper is sampled with the frequency of 40~MHz and saved to the analog pipeline. The APV can work in the ``peak mode'', when only a single value of the pulse shape is used. This value corresponds to the maximum of the pulse shape for the given bunch crossing. In the ``deconvolution mode'' the weighted sum of the shaper sampled output from three consecutive bunch crossing is calculated instead. The computed continuous APV output in the peak~(black) and deconvolution~(gray) mode can be seen in Fig.~\ref{fig:figures/PeakDeco}. In the real situation the peak curve in black is sampled at its maximum to obtain peak mode output or by three steps of 25~ns to be able to obtain the deconvolution mode output. The illustration of the sampling points for peak~(circle) and deconvolution~(rectangles) modes is also presented in Fig.~\ref{fig:figures/PeakDeco}. Because in the deconvolution mode the pulse is shorter as shown in Fig.~\ref{fig:figures/PeakDeco}, the APV is usually operating in this mode to reduce the out-of-time pileup and improve the separation of signals from two consecutive bunch crossings. To have the possibility to optimize the pulse shape, the feedback resistors of both preamplifier and shaper as well as the bias current and the voltage are fully programmable and their settings can be thus easily changed. For the calibration and test of the chip, an internal calibration circuit is present. This circuit enables to inject a charge to each channel separately to the stage prior to the preamplifier one.


    \insertFigure{figures/PeakDeco} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {Calculated APV output in the peak~(black) and deconvolution~(gray) mode. Actually, the shaper output is sampled in the APV to obtain only maxima of the two curves. An example of the sampling points for the deconvolution mode is shown in green rectangles, the sampling point for the peak mode is represented by a blue circle~\cite{Friedl:2001kra}.} % Caption


The sampled output for all the 128 channels of one APV are extracted at the end of the analog pipeline upon the request of the trigger. The average signal level from the 128 channels can be adjusted within the range of the APV, in order to reduce the signals exceeding the APV or FED range. The signals from two APV chips are multiplexed by one APVMUX chip~\cite{Ball:2007zza} into a single line and converted by laser from an electrical to analog optical signal, which is sent via an optical fiber to the control room. At the control room, the optical signal is then received by a pin diode which is an entry point of the FED.

%-tickmarck sent every 70 clock cycles when no data are qued for output -  used for synchronization betwwen frontend and backend electronics.

\subsection{The Front End Driver \label{sec:FED}}
One FED~\cite{Baird:2002wg} is receiving data from 96 optical fibers, each sending the information originating from 2 APVs. The data in form of optical signals are converted to the electrical signals, which are then reordered and synchronized. For each APV input, the signals per channel are extracted and digitized into 10-bit range Analog Digital Counts~(ADC). The output signal for a given channel is referred as ``digi'', which can be seen in Fig.~\ref{fig:figures/event2layer4}.

In FED two kinds of noises can be subtracted. The first one is referred as pedestal and is computed as the mean strip activity for a given strip when no particle is present. It is evaluated from special ``pedestal runs'' taken several times per year. After pedestal subtraction, the Common Mode Noise~(CMN or baseline) is the remaining noise due to e.g. electronics or power supply origins, which is common to all channels of one APV and is calculated on an event by event basis as the median over the 128 strips. The data after pedestal subtraction and the CMNs from one module are also shown in Fig.~\ref{fig:figures/event2layer4}. 

After both subtractions of the pedestals and the CMN, the channels with ADC values lower than zero are truncated to zero. For all channels, the signal-to-noise ratio~(S/N) is checked separately. If S/N of the channel is larger than two or if the S/N ofi a group of neighboring channels exceeds certain threshold, then the ADC values of these channels are kept while the values of the other channels are set to zero. Moreover the ADC range is truncated to 8 bits in a way that no change is applied for channels with charges lower than 254 ADC, charges between 254 ADC and 1022 ADC included are set to 254 ADC, and charges exceeding 1022 ADC are stored as 255 ADC. Later only information about strips with non-zero ADC values are sent to the CMS Data Acquisition System~(DAQ).  This procedure of the pedestal and CMN subtraction, the evaluation of the channels based on the S/N and the suppression of the channels with zero ADC value is called ``Zero Suppression''~(ZS). In the standard operation mode, the zero suppression mode is used for data-taking. By the ZS procedure, the available data are reduced by a factor of around 60 which avoids an overload the CMS DAQ system.

For testing purposes the FED is able to operate in other modes than the ZS mode. There is an another mode referred as the ``Virgin Raw''~(VR) data taking mode, in which no subtraction or suppression is applied. This mode is thus suitable for commissioning, debugging and deeper studies of the APV output.

%NOISE maybe just some general comments - like sources, but really needed?

%In the ideal case, when a constant current is injected into the sensor, the output signal from the electronics should be constant. In reality it is not the case because of the random fluctuations called electronics noise. The silicon strip sensors have two sources of electronics noise, which are voltage or current sources. These two sources can be induced by either variations of the velocity (thermal noise) or by fluctuating number of charge carriers (shot noise)~\cite{website:noise}. Usually the largest noise comes from the amplification of the signal. 


%The noise can be correlated between channels, like in case of the CMN, but also due to the electronics capacitive coupling. Anti-correlation of noise between neighboring channels originating from the inter-strip capacitance has been observed~\cite{Lutz:1987wd}. As the total charge on all channels must be conserved, in case of upward fluctuation on one strip, the downward fluctuation must occur on neighboring strips leading to anti-correlation of noise between neighboring channels.

\subsection{The offline data treatment~\label{sec:localreco}}


The data collected by the FED are then treated offline. A clustering procedure is applied on the ZS digis. The default clustering algorithm is called the ``three threshold algorithm'', posing thresholds on the seed strip~(strip with the largest signal), on the neighboring strips and on the cluster charge in terms of signal-to-noise ratio. The seed must pass the requirement of S/N>3, adjacent strips can be added if their S/N is larger than two. On top of these requirements, the total cluster charge~(the sum of the charges of all channels) must be five times larger than the total cluster noise $\sigma_{cluster}$ which is defined as


\eq{noiseEquation}
{
    \sigma_{cluster} = \sqrt{\sum_{i} \sigma_{i}^{2}},
}

where $\sigma_{i}$ is the noise of channel $i$ within the cluster. In addition to its charge and noise, each cluster can be quantified by a cluster width, corresponding to the number of channels in the reconstructed cluster. The example of cluster obtained at the end of the clustering procedure is shown in Fig.~\ref{fig:figures/event2layer4}.

    \insertFigure{figures/event2layer4} % Filename = label
                 {0.47}       % Width, in fraction of the whole page width
                 {Example of data from one tracker module undergoing zero suppression and clustering. The raw digis are shown in pink. From the raw digis the pedestals are subtracted and the resulting digis are shown in blue. From pedestal subtracted digis the baselines shown in red are computed and subtracted. The final clusters are shown in green.} % Caption

%-gains %https://github.com/cms-sw/cmssw/blob/09c3fce6626f70fd04223e7dacebf0b485f73f54/RecoLocalTracker/SiStripClusterizer/src/ThreeThresholdAlgorithm.cc

During clustering, the strip charge is calibrated by two factors: the tick-mark gain~(G1) and the particle gain~(G2). First, the tick-mark gain is correcting the signal for the transmission losses, mainly for the losses happening during the transmission of the signal through the O(100)~m long optical fibers. To estimate this gain, a well-defined tick-mark signal is issued at the APV level. The G1 for the APV is then computed by re-scaling the output tick-marck to 640~ADC. By construction, the tick-mark gain aims to equalize the output among the APVs. The main purpose of injections of the tick-marck signals is the synchronization of the APVs to the central trigger.

Secondly, the particle gain is correcting for the differences at the sensor level and compensates for example for charge trapping. This gain is determined from the ionization of the silicon sensitive volume per unit of length of the particle traversing the sensor. The measured MPV of the ionization per unit of length is then used to equalize the response of different sensors to the MIP charge set to be 300~ADC/mm. 

These calibrations need to be determined frequently as they are affected of the aging of the detector~(e.g. fibers and lasers for G1,  sensors for G2) or some change of the operating conditions~(e.g. temperature). During this step the cluster charge is corrected by factor 1/(G1$\times$G2).

For the further reconstruction steps the clusters are converted to hits, whose position is obtained from charge-weighted positions of the channels in the cluster, corrected for the Lorentz drift in case of barrels, where the magnetic field is perpendicular to the module plane. In case of stereo modules, the matching of hits between the two tilted modules is done. The resolution on the hit position is also assessed at this step.

%On top of this an additional correction is applied due to compensate inefficiencies of the collection of charges deposited close to the back-plane. 

%On the tracker level, the track reconstruction is performed in 4 steps~\cite{website:slidesTracking, website:twikiTracking}. First, the \textit{track seeding} is built from two or three 3-D reconstructed hits with a constraint on primary vertex position. Then the algorithm proceeds with \textit{track building} which aims to connect all hits originating from one particle. During the track building the track is propagated to the neighboring layers of the tracker, testing the compatibility of the reconstructed hit with the track by a $\chi^{2}$ test. Once the full track candidate is complete, the \textit{track fitting} is performed to obtain the best parameters of the track and to recompute precise hit position using the track properties. The last step is a \textit{track quality selection} rejecting tracks not fulfilling quality requirements, which are based on the $\chi^{2}$ of the final fit, the number of layers with a hit associated to the track and the probability of the track  to originate from the primary vertex.

%The default track reconstruction~\cite{Chatrchyan:2014fea} is using the software referred as the Combinatorial Track Finder~(CTF), based on the combinatorial Kalman filter~\cite{Fruhwirth:1987fm}. The tracking uses an iterative approach: in the first iteration the easiest tracks to find are reconstructed (i.e. the ones with the highest $p_{T}$), then after these tracks are complete their hits are masked in order to avoid duplicities and reduce combinatorics for further iterations of tracks finding. In total there are 12 iterations and each iteration is focused on a specific type of tracks. 

The reconstructed hits are then used to reconstruct tracks as described in Section~\ref{sec:tracker}. The clusters which are associated with good tracks are referred as ``on-track'' clusters, the remaining clusters are called ``off-track'' clusters.

%-TODO tracking cosmics?
%-how is it with missing hits? -track is only lost if two consecutive hits are missing? Can differ but usually should be 1 missing hit per track maximum -  in note CMS-TRK-11-001

\newpage

\section{Laboratory studies of the impact of highly ionizing particles on the APV25 chip~\label{sec:HIPinPast}}

%energy spectra of heavy fragments produced in silicon are insensitive to energy of incident particle and do not go further than 10MeV, energy loss for such fragments are of order$MeV\mum^{-1}$~thus the fragments can go up to 100 $\mum$ (compare with sensor thickness) - very localized depositions. The light particles from nuclear interactions can travel longer and also contribute significantly to the total energy depositied~\cite{Huhtinen:2000nk}.

After an intorduction of the tracker readout in the previous section, we can now study the effect of the HIP events on the electronics and output data in more details. Before the start of the LHC operation, several studies of the HIP events were performed in laboratory, during the beam tests at PSI~\cite{Tomalin:2003aaa} and CERN X5~\cite{Bainbridge:2002bda}. The impact of large energy depositions on the electronics was also studied by charge injection in the calibration circuit of the APV or by laser tests~\cite{Adam:2005pz}. Only the HIP studies performed at the PSI beam test are described in a larger extent in this section, because of the best extrapolability of their results to the CMS environment.

\subsection{Experimental setup of the PSI beam test}

To test the behaviour of the CMS tracker modules in conditions similar to the CMS ones, studies at the M1 beam-line at PSI were performed. This beam-line provided a continuous beam of protons and pions. For the module studies, the beam was tuned to pion momentum of 300~MeV to best mimic the CMS environment. The tracking system under test at PSI consisted of 12 layers of tracker modules (3$\times$TIB, 3$\times$TEC, 6$\times$TOB), but for the study of HIP events only TOB modules were used. These TOB modules had 500~$\mathrm{\mu m}$ thick sensors with strip pitch of 183~$\mathrm{\mu}$m and were equipped by inverter resistors of either 50, 75 or 100 $\mathrm{\Omega}$. Special trigger bursts and APV settings were used to trigger the HIP events and events after HIP, allowing to provide 29 consecutive events recorded every 25~ns, resulting in data over a 750~ns period. All modules were operated in the peak mode and the output data were equivalent to the CMS VR data format. 


%-measured probability per pion per sensor plane ins lower than 10-3

%-sensors 320 or 500 mum

\subsection{Response of the readout electronics to the HIP events}

As discussed previously, the highly ionizing particle leaves very localized large energy depositions up to the equivalent of $\sim$1000 MIPs and thus saturates the readout electronics. The affected channels collect a charge beyond the range of the readout electronics which is of order of a few tens of MIPs. The rest of the channels belonging the same 128-channel APV is shifted towards the low ADC values up to the point when the ADC value is so small, that no light can be emitted by laser (zero-light level). This behavior is a result of the cross talk effect menitoned in Subsection~\ref{sec:APV}, which is caused by common biasing of the inverters, due to which large signal appearing at one inverter is suppressing the other channels of the APV~\cite{Bainbridge:2004jc}. 

Because of the shift of the CMN the HIP events can be easily identified thanks to a requirement on value of the baseline. In this study, an APV chip, which exhibited baseline value lower or equal to -20~ADC at some point during the trigger burst period, was tagged as containing a  HIP candidate. The response of the APV chip on the HIP event is shown in Fig.~\ref{fig:figures/thesisEvolution}. Each plot of Fig.~\ref{fig:figures/thesisEvolution} presents the data from 6 consecutive TOB modules~(on the y-axis) after pedestal subtraction at a different time. The x-axis depicts all channels of one module and the individual y-axes show the ADC values for all these channels. There are four APVs in each module. A normally operating module is e.g. the top module in the bottom-left plot~($T_{event}$ = 525~ns), where all APVs have their baseline around a nominal value. In this module a MIP signal can be seen in the second APV. In Fig.~\ref{fig:figures/thesisEvolution} a HIP signal can also be observed. The top-left plot~($T_{event}$ = 300~ns) shows the first evidence of the HIP event. In the second module from bottom, in the second APV, a large signal peak and a small shift of other channels towards low values of the APV range can be observed. After 50~ns~($T_{event}$ = 350~ns) the channels of the affected APV, which are not collecting the HIP signal, are suppressed and the signal peak is thus fully revealed. The suppression of numerous channels as well as the large signal peak can be still observed at $T_{event}$ = 525~ns. At $T_{event}$ = 575~ns, the channels start to recover to their initial position. It is interesting to note that at $T_{event}$ = 525~ns~( for x$\sim$33~mm) and $T_{event}$ = 575~ns~(for x$\sim$33~and~50~mm) a MIP passes through all the six layers of the modules. The signal is observed in the APVs of all layers except of the one affected by the HIP event. The time period, during which the APV is insensitive to a MIP signal is referred as the dead-time.

    \insertFigure{figures/thesisEvolution} % Filename = label
                 {0.7}       % Width, in fraction of the whole page width
                 {Example of the time evolution of the APV behavior as a response to a HIP event. The situation for the six modules is depicted at four different times:  $T_{event}$ = 300~ns (top-left), $T_{event}$ = 350~ns (top-right), $T_{event}$ = 525~ns (bottom-left) and $T_{event}$ = 575~ns (bottom-right). The ADC values of pedestal subtracted data~(y-axis) of the six layers of the TOB modules~(y-axis direction) are plotted for all channels of one module~(x-axis). The HIP event appears at $T_{event}$ = 300~ns in the second module from bottom and can be followed in the same module for the remaining three timestamps~\cite{Bainbridge:2004jc}.} % Caption

The CMN distribution of all baselines can be seen in the bottom plot of Fig.~\ref{fig:figures/CMNandRMSrawPast}. The CMN distribution is peaking around 0~ADC during the standard conditions, while a smaller peak around -100~ADC comes from suppressed baselines which are result of the HIP events. In this analysis the selected HIP event satisfies the selection requesting CMN$\leq$-20 and a HIP cluster seed charge larger than 125~ADC. Therefore in Fig.~\ref{fig:figures/thesisEvolution} this happened for the event at $T_{event}$ = 350~ns, but as shown in the example, the signal from the real HIP interaction occurred and was partially observed already 50~ns before this ``selected HIP'' event $T_{event}$ = 350~ns.

As seen in the example, the HIP event is suppressing all channels which are not collecting signal. Large enough HIP signals then result in a full suppression of the channels beyond the lower limit of the possible range, when the electrical signal is too small. The APV with fully suppressed channels exhibit a very small $\sigma_{raw}$, which is in this case computed as a \SD of the data before pedestal subtraction~(raw data), when excluding 5\% of the lowest and 25\% of the highest channels in the APV. The \SD $\sigma_{raw}$ of raw data is shown in the top part of Fig.~\ref{fig:figures/CMNandRMSrawPast}, where the population in the large peak corresponds to the normal operation $\sigma_{raw}$ values around $\sim$1.5~ADC, which are reproducing the spread of pedestals. The smaller peak population with an $\sigma_{raw}$ lower than 0.5~ADC is coming from fully suppressed baselines not anymore sensitive to the pedestal spread. The tail of the distribution is populated by data with distorted baselines usually originating from the HIP event, which results in a non-uniform suppression and recovery of the baseline.

    \insertFigure{figures/CMNandRMSrawPast} % Filename = label
                 {0.7}       % Width, in fraction of the whole page width
                 {(top) The \SD of raw data~($\sigma_{raw}$). The large peak around 1.5~ADC corresponds to standard baselines, while the peak $\sim$~0.5 is caused by fully suppressed baselines. (bottom) The CMN distribution, in which the nominal baselines are located around zero and the fully suppressed baselines are peaking around -100~ADC. These results were obtained with PSI beam test data~\cite{Bainbridge:2004jc}.} % Caption

Based on these observations two event categories were defined: the ``fully suppressed'' and the ``partially suppressed'' baseline events. Events with ``fully suppressed'' baselines satisfy $\sigma_{raw}< 1~\mathrm{ADC}$, due to no light emission. ``Partially suppressed'' baselines are required to to have $\sigma_{raw}\geq$1~ADC and CMN$\leq$-20~ADC.

\subsection{Dead-time induced by the HIP events~\label{sec:deadtimePast}}

In other laboratory studies, during which charge has been induced in tracker sensors by laser, the recovery of baseline and signal in terms of S/N has been studied~\cite{Adam:2005pz}. It was shown in Fig.~\ref{fig:figures/baselineAndSignalRecovery} that the S/N ratio recovers differently and by different time constants than the baseline. However, both recoveries of the baseline and the S/N are in order of hundreds of nanoseconds. To estimate the dead-time and hit efficiency induced by an HIP event, it is necessary to know when enough of the signal appears to be reconstructed in the cluster~( resp. hit).

    \insertFigure{figures/baselineAndSignalRecovery} % Filename = label
                 {0.7}       % Width, in fraction of the whole page width
                 {The recovery of the baseline~(circles) and S/N~(triangles) (expressed as a ratio of the measured S/N to the reference S/N) as a function of time. The evolution is shown for an inverter resistor value of $50~\mathrm{\Omega}$ and an energy deposit of 25~MeV~\cite{Adam:2005pz}.} % Caption

The dead-time of the APV is calculated as a hit efficiency ratio. The hit efficiency~$\epsilon_{hit}$ is computed separately for APVs influenced by the HIP event~($\epsilon_{hit}^{HIP}$) and for efficient APVs which are not influenced by the HIP event~($\epsilon_{hit}^{good}$). The hit efficiency is defined as $\epsilon_{hit} = N_{hit}/N_{tracks}$, where $N_{hit}$ is the number of clusters reconstructed in the APV around the track intercept point, and $N_{tracks}$ is the number of reconstructed tracks traversing the APV. The dead-time is then time interval during which the APV is not fully efficient~($\epsilon_{hit}^{HIP}$ < $\epsilon_{hit}^{good}$). The averaged dead-times for the APVs with the fully suppressed baselines are shown in Table~\ref{tab:tableDeadtimes} for both inverter resistor values of 50~$\Omega$ and 100~$\Omega$. The APVs with partially suppressed baselines exhibit much smaller dead-time compared to the previous case, typically in order of a few tens of ns. In Table~\ref{tab:tableDeadtimes}, it can be noticed that the reduced resistor value significantly decreases the dead-time and that the dead-time depends on the sensor geometry. Although, diminishing the resistor value has its disadvantage which is the enhancement of the baseline distortions, leading to the reconstruction of ``fake'' clusters as only flat CMN is subtracted~\cite{Bainbridge:2004jc}. In this analysis the fake clusters were observed to have large charge and also large cluster width of typically tens of channels. 



\begin{table}[h]
\begin{center}
\begin{tabular}{|l|l|l|}
\hline
Sensor type and $R_{inv}$~[$\Omega$] & $\Gamma_{mean}$~[ns]  & $\Gamma_{max}$~[ns] \\
\hline
\hline
TIB 100 & 99.5 $\pm$ 12.0 & 200 $\pm$ 25 \\
TIB 50 & 69.6 $\pm$ 9.4 & 250 $\pm$ 25 \\
TOB 100 & 112.5 $\pm$ 12.6 & 275 $\pm$ 25 \\
TOB 50 & 100.5 $\pm$ 3.6 & 275 $\pm$ 25 \\
\hline
$\Gamma_{mean} (50/100)_{TIB}$&  0.70 $\pm$ 0.13  & \\
$\Gamma_{mean} (50/100)_{TOB}$&  0.82 $\pm$ 0.09 & \\
\hline
\end{tabular}
\caption[Table caption text]{The mean~($\Gamma_{mean}$) and maximum~($\Gamma_{max}$) dead-time of the APV chip induced by the HIP events for fully suppressed~($\sigma_{raw}<1$~ADC) baseline events. The dead-times were evaluated for two different module geometries~(TIB or TOB) as well as for two inverter resistor values~(100 or 50~$\Omega$). These results were obtained with PSI beam test data~\cite{Bainbridge:2004jc}. }
\label{tab:tableDeadtimes}
\end{center}
\end{table}



\subsection{Probability of a HIP event in the tracker module~\label{sec:ProbPast}}

At the PSI beam test, the measurement of the HIP probability was also provided. The HIP probability is defined as 

\eq{HIPprob}
{
P_{HIP}(CMN_{HIP}\leq CMN_{threshold}) = \frac{N_{HIP}(CMN_{HIP}\leq CMN_{threshold})}{N_{tracks}},
}

where $N_{HIP}(CMN_{HIP}\leq CMN_{threshold})$ is the number of selected HIP events with a baseline value~($CMN_{HIP}$) lower than the threshold~$CMN_{threshold}$ and $N_{tracks}$ is the number of tracks traversing the sensor.

The HIP probability measurements were provided with a pion beam of $300~\mathrm{MeV}$ energy, which is the most probable energy value of pions in the CMS tracker. The measured probability for the different modules, using $CMN_{threshold}=-20$~ADC, was found out to be of the order of $10^{-3}$ for the TOB and $10^{-4}$ for the TIB. It was also concluded that the HIP probability does not scale with the number of incoming particles per time period if rescaled to the number of incoming particles, but rather with the sensor thickness. With larger thickenss of the sensor the probability of the nuclear interaction is increasing.  A similar measurement was provided using a proton beam of  $300~\mathrm{MeV/c}$ momentum, which in this case is not compatible with the CMS conditions.

\newpage

\section{Studies of the HIP events with the CMS pp collision data}

As described in the previous section, several HIP studies were performed in the laboratory, but the HIP events have never been studied with the CMS collision data. Though the PSI beam test conditions were supposed to be as close as possible to the CMS ones, the particle and energy spectra differ in these two cases, it is thus important to evaluate the HIP effect in the real CMS environment.

The HIP studies with the CMS data are discussed in Subsections~\ref{sec:firstStudy} and~\ref{sec:secondStudy} after a first discussion on the strategy of these studies presented in Section~\ref{sec:strategy}. In Subsection~\ref{sec:firstStudy} the HIP effect is studied from the perspective as a possible explanation of the observed hit inefficiency. The Subsection~\ref{sec:secondStudy} present a study of new data recorded after the fix of the largest source of hit inefficiency and is focused on clean analysis of the HIP properties and consequences of the HIP on the read-out output.

\subsection{Strategy of the HIP studies~\label{sec:strategy}}

As explained in the section~\ref{sec:FED} the Zero Suppression mode is used in the standard data-taking. During the ZS procedure, all negative channels after pedestal subtraction are truncated to zero, this mode is thus not suitable to study the HIP events, which are known for causing a drop of the CMN as described in Section~\ref{sec:HIPinPast}. The solution is to request data-taking in the Virgin Raw mode, what comes with a cost of an increased event size. In the VR data, no subtraction or suppression is applied but the ZS can always be performed offline, providing then the possibility to compute the CMN and proceed with clustering and further data treatment. In the following analyses, the CMN is computed from all 128 raw digis after pedestal subtraction as a median over these 128 strips. The \SD~($\sigma_{raw}$) is calculated from the raw digis of 80\% of the 128 channels having the lowest ADC value, to avoid the clusters in this computation. The ZS and clustering are performed as in the standard data-taking (i.e. truncation to zero, computation of the baseline after truncation, truncation of digis to 8 bits) to mimic the standard data-taking output.

The goals pursued in the further studies are to select a HIP event and study the influence of such event on the electronics and the clustering. As seen in previous studies in Section~\ref{sec:HIPinPast}, the signal recovery time is of the order of hunderds of ns. Thus to be able to study the evolution of the CMN and the cluster properties, consecutive events in a window of a few hundreds of ns are needed. However the probability to record closely spaced events in time is very low without special trigger configuration. The possibilities for a new trigger configuration are very limited due to the increased size of events during the VR data-taking by factor of O(60) compared to the standard ZS data taking. Moreover in order not to overload the CMS data acquisition system, the following trigger criteria are imposed on the number of triggers in a given number of bunch crossings~(bx)~\cite{website:VRtrigger}.

\begin{itemize}
\item{no more than 1 trigger in 3 bx,}
\item{no more than 2 triggers in 24 bx,}
\item{no more than 3 triggers in 100 bx,}
\item{no more than 4 triggers in 240 bx.}
\end{itemize}

%Another protection of the acquisition system, used for the runs analyzed in following sections, was the requirement that triggered events have to be spread over many data streams to ensure that consecutive events are stored in different files. Because of this limitation, the sorting and ordering of the events had to be performed beforehand.

For simplicity, in the following sections of this chapter are shown only plots for the first layer of the TOB, which exhibited the largest drop in the hit efficiency. The probability of the HIP event for a given APV is defined in the similar way as in the PSI study presented in subsection~\ref{sec:ProbPast} as


\eq{HIPprob2}
{
p_{HIP} = f_{HIP} \frac{1}{N_{tracks~(APV)}},
}

with


\eq{HIPfrac}
{
f_{HIP} = \frac{N_{HIP~(APV)}}{N_{all~(APV)}},
}


where $N_{HIP~(APV)}$ is the the number of selected HIP events per APV, $N_{all~(APV)}$ is the total number of events and $N_{tracks~(APV)}$ is the number of tracks per APV. The $p_{HIP}$ is computed in average for all layers of the strip tracker in order to complement the study with a more global picture.

Alternatively the HIP probability can be defined as

\eq{HIPprob3}
{
p_{HIP}(PU) = f_{HIP} \frac{1}{PU},
}

where PU is the fill pileup. 


%To be able to run the study in reasonable time and with reasonable amount of resources, the reduction of the data was done based on 

\subsection{A first study of the HIP events in the CMS detector~\label{sec:firstStudy}}

\subsubsection{Motivation to the study HIP effect in the CMS detector}

As introduced in Section~\ref{sec:hitIneff} the CMS detector faced important hit inefficiencies in 2015 and 2016. At that time, the HIP effect was identified to be most probably the source of these tracking inefficiencies. A lot of efforts were therefore put into the studies of the HIP effect from many perspectives. One of the option was to analyze the Virgin Raw data, from which a pure output of the APV can be obtained. In the following study, the VR data were used to characterize the HIP effect and evaluate its impact on the electronics and clustering. The presented study provides first results on the HIP effect with the CMS data.

\subsubsection{Experimental setup} 

This study using the VR data taken on the $12^{th}$ of April 2016 in the run 273162 of the LHC fill 4915, where only the silicon strip tracker was included. Due to the constraints from the LHC and CMS a short run of around 30 minutes with an instantaneous luminosity of 1.5$\times 10^{33} \mathrm{cm^{-2} sec^{-1}}$ was taken. During this run, the APVs were operating in the deconvolution mode. The LHC delivered beams with 601 bunches each, among which 589 pairs of bunches collided at CMS. The average pileup for this fill was 26 interactions per bunch crossing. The beams were mainly composed of trains of 72 bunches, in which bunches were spaced every 25~ns.

Closely spaced events in time were enriched in data by using a special trigger configuration, which forced the first bunch crossing in a fixed train to be triggered. After this trigger, two other bunch crossings in the same train were triggered randomly. Then the trigger waited for the same train in next orbit. 

%The final number of triggered events as a function of the bunch crossing is shown in Fig.~\ref{fig:figures/triggerStudyFirst}. The shape of the trigger distribution is given by the trigger rules after the forced trigger on the first bx in the train.

%-trigger rules: %https://indico.cern.ch/event/512685/contributions/2167961/attachments/1273330/1887985/virgin_raw_test_2016_ebutz.pdf

    %\insertFigure{figures/triggerStudyFirst} % Filename = label
    %             {0.6}       % Width, in fraction of the whole page width
    %             {Number of triggered events as a function of bunch crossing.} % Caption


 \subsubsection{Methodology}
 
%HIP in module

In Section~\ref{sec:HIPinPast}, it has been observed that HIP event can be identified via a low value of the baseline. Applying this approach to the CMS data allows to select the event shown in the left plot of Fig.~\ref{fig:figures/peakinmoduleT}. In this example the expected effect of the HIP event on the chip can be seen: a negative baseline, a large signal on few channels and a low \SD of the raw digis. But in many cases the large signal is not observed as shown in the right plot of Fig.~\ref{fig:figures/peakinmoduleT}, in contradiction to what has been observed in the study of Section~\ref{sec:HIPinPast}. This difference can be explained by the different operation mode of the APV: a deconvolution mode was used for studies at CMS while for the HIP studies at PSI it was a peak mode. During studies of the APV chip behavior when large charges were injected to the calibration circuit~\cite{Bainbridge:2002bda}, it has been shown that when APVs are operated in deconvolution mode, the large signal peak as seen in the right plot of Fig.~\ref{fig:figures/peakinmoduleT} can be observed only for few ns and then the channels in which large signal was observed are also driven beyond the low limit of the measurable ADC values. 

%TODO figure module with APV with saturated baseline and peak
    \insertTwoFigures{figures/peakinmoduleT}
                 {figures/peakinmodule} % Filename = label
                 {figures/nopeakinmodule} % Filename = label
                 {0.47}       % Width, in fraction of the whole page width
                 {Example of distribution of raw digis~(pink), pedestal subtracted digis~(blue), baselines~(red) and clusters~(green) as a function of the strip number in one module. (left) The third APV in the module shows a behavior induced by a HIP event: a low charge variation for the suppressed raw digis and a large observed signal for few channels. (right)  The third APV in the module shows a behavior induced by a HIP event: low charge variation for the suppressed raw digis, but in this case no peak is observed. } % Caption

A reliable selection of the APVs influenced by the HIP events can be designed via the presence of the fully suppressed baselines in a similar way as in Section~\ref{sec:deadtimePast}. From the analysis of the correlation of the baseline and $\sigma_{raw}$ values in Fig.~\ref{fig:figures/baselinevsRMSrawFirst}, it is obvious that the standard events with a nominal value of the baseline around 128~ADC have a $\sigma_{raw}$ value of order of a few ADC units.  The second largest population has a small value $\sigma_{raw}$ and a fully suppressed baseline, which can be connected with large energy deposits in the sensor read by the given APV chip. To determine the value of $\sigma_{raw}$ which selects fully suppressed baselines, the distribution in Fig.~\ref{fig:figures/RMSraw} of $\sigma_{raw}$ is analyzed. Based on the knowledge of the baseline, $\sigma_{raw}$ and their correlation, the selection of the HIP events has been chosen to be 

\eq{selection}
{
baseline<-5~\mathrm{ADC}~\mathrm{and}~\sigma_{raw}<2.5.
}


%TODO figure vs RMS
    \insertFigure{figures/baselinevsRMSrawFirst} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {The 2-D distribution of the $\sigma_{raw}$ of raw digis~(y-axis) versus the baseline~(y-axis) for run 273162. The baselines selected as HIP events are indicated by a red box. } % Caption


%The large yellow bulk is the population of the baselines with a nominal value and a $\sigma_{raw}$ of few units of ADC. The smaller yellow population corresponds to fully suppressed baselines, which exhibit a low value of baseline and a low value of $\sigma_{raw}$. 


%TODO figure vs RMS
    \insertFigure{figures/RMSraw} % Filename = label
                 {0.47}       % Width, in fraction of the whole page width
                 {The $\sigma_{raw}$ distribution for run 273162. }
% The peak around 1~ADC corresponds to fully suppressed baselines, while the bulk of the distribution represents standard operation baselines.  } % Caption

In the Fig.~\ref{fig:figures/baselinevsRMSrawFirst}, there are many events with a negative value of baseline, but a large value of $\sigma_{raw}$. These events can originate from a baseline drop, a baseline recovery or from large energy deposits, but not large enough to fully suppress the baseline. In order not to mix the different populations, the partially saturated baseline events are not selected as HIP events. 

It has also been observed that the full saturation can last for several bunch crossings as it is shown in Section~\ref{sec:limitationsSelection} and consequently for a given APV, several consecutive events could be selected as a HIP. In this case, only the first event of these possible events is defined as the selected HIP. In addition, as the saturation of the baseline is a consequence of the HIP interaction, the HIP event does not have to be selected at the time when the real HIP interaction has occurred in the sensor. 

%Other possibilities how to select HIP event will be discussed in section~\ref{sec:limitationsSelection}.

The analysis of the APVs influenced by a HIP event has been performed statistically. For that purpose, when a HIP event is selected, the bunch crossing of this event is redefined to bx=0, and the bunch crossings of two remaining events in the same train are set relatively to the HIP event, e.g. if another event is triggered five bunch crossings after the selected HIP, its bunch crossing is set to 5. The average information per each bunch crossing is then used. The APV-averaged baseline distribution as a function of bunch crossing, shown in the left plot of Fig.~\ref{fig:figures/baselineFirstT}, allows to study what happened before and after the selected HIP. When following the baseline evolution in time, the baseline shows a stable value around 128~ADC long before the HIP occurs~(bx$\ll$0). Shortly before the selected HIP, the baseline starts to drop as a consequence of the large energy deposition in the sensor. At bx=0, by definition, the baseline is saturated. The baseline recovers to normality in about 15~bx and slightly overshoots for the remaining duration of the train. The baseline overshoot can be understood as a continuation of the response of the APV chip to the large signals. The gap between bx=0 and other the other bunch crossings is caused by the first trigger rule, which is allowing only one trigger in three bunch crossings. 

A similar distribution for $\sigma_{raw}$  as a function of the bunch crossing number is shown in the right plot of Fig.~\ref{fig:figures/baselineFirstT}. Long before the HIP event, $\sigma_{raw}$ is stable with a value around 8~ADC. Right before the selected HIP, $\sigma_{raw}$ increases due to a non-uniform drop of the baseline. After the HIP evet it recovers in around 10~bx. Up to this recovery point, the baseline can be fully or partly saturated what explains the low $\sigma_{raw}$ value. This population is however mixed with distorted baselines which on the other hand have large $\sigma_{raw}$ and therefore part of the distribution of bx>0 cannot be straightforwardly interpreted.

    \insertTwoFigures{figures/baselineFirstT}
                 {figures/baselineFirst} % Filename = label
                 {figures/rmsFirst} % Filename = label
                 {0.47}       % Width, in fraction of the whole page width
                 {(left) The averaged baseline evolution as a function of the bunch crossing number for run 273162. The bunch crossing of the selected HIP event is translated to the position bx=0. Events before~(after) the selected HIP have bx<0~(bx>0). (right) The evolution of the averaged $\sigma_{raw}$ of the raw digis as a function of the bunch crossing number for run 273162. The bunch crossing of the selected HIP event is translated to the position bx=0. } % Caption

\subsubsection{Results}

As shown in Fig.~\ref{fig:figures/baselineAndSignalRecovery}, the signal recovery, i.e. the hit efficiency recovery, and the dead-time induced by the HIP event cannot be estimated from the baseline information and it is thus necessary to study clusters. The distributions per APV of the average cluster multiplicity and the maximal cluster charge~(i.e. the charge of the cluster with the largest cluster charge)  are shown as a function of the bunch crossing in Fig.~\ref{fig:figures/avMultiplicityFirstT}. In these distributions, as previously, an averaging over the APVs is performed as well as the alignment of the selected HIP event with bx=0. The average cluster multiplicity presented in the left plot of Fig.~\ref{fig:figures/avMultiplicityFirstT} is stable for events long before the occurrence of the HIP. Around bx=-5, the multiplicity grows as additional clusters originating from the HIP interaction~(recoil or fragments) may start to appear. As a consequence of the HIP deposit, the chip becomes inefficient for the signal collection, already at bx=0 when  the cluster multiplicity drops significantly. The cluster multiplicity is recovered in around 10 bunch crossings. The average cluster multiplicity distribution for bx>10 is flat with a constant higher than for bx<-10, in contradiction with expectations. The maximal cluster charge per APV shown in the right plot of Fig.~\ref{fig:figures/avMultiplicityFirstT} exhibits a stable behavior for bx<-20, followed by an increase in charge. The cluster charge is the highest for the selected HIP as few channels can collect large charges induced by the HIP energy deposits. After bx=0, the cluster charge drops and recovers almost immediately after the selected HIP, but to a slightly lower level than before the HIP event, even though the same level as for bx$\ll$0 is expected. 

    \insertTwoFigures{figures/avMultiplicityFirstT}
                 {figures/avMultiplicityFirst} % Filename = label
                 {figures/maxChargeFirst} % Filename = label
                 {0.47}       % Width, in fraction of the whole page width
                 {(left) The averaged cluster multiplicity (left) nad maximal cluster charge (right) evolution as a function of the bunch crossing number for run 273162. The bunch crossing of the selected HIP event is translated to the position bx=0. } % Caption

The mismatch between the cluster properties for bx$\ll$0 and bx$\gg$0, as shown in Fig.~\ref{fig:figures/avMultiplicityFirstT}, can be, at least partially, understood when analyzing the cluster charge distribution of clusters of the first event in the train and the two other events in the train in Fig.~\ref{fig:figures/chargeFirstAndOtherInTrain}. For the first event in the train, the cluster charge distribution exhibits a double peak structure of similar peak heights with maxima around 50~ADC and 200~ADC, while for the other events in the train, the height of the peak around 50~ADC is clearly dominant. The enhanced population of clusters around 50~ADC for the other events in the train, is coming from out-of-time pileup contributions, which are not present in the first bunch crossing. In the train there are 3 events triggered, one of them is selected as a HIP event, so only the first or second event can be set to bx<0 and on the other hand only the second or third event can be set as bx>0. In consequence, the regions with bx<0 in Fig.~\ref{fig:figures/avMultiplicityFirstT} are dominated by a population with a lower out-of-time pileup and also a lower average cluster multiplicity and higher maximal cluster charge than the regions of the distributions with bx>0. To avoid the mixing of different populations of events, the first event in the train has been removed from the distributions. The average cluster multiplicity without the first bunch crossing in the train is shown in the left plot of Fig.~\ref{fig:figures/avMultiplicityCleanedFirstT} and the maximal charge without the first bunch crossing in the train in the right plot of Fig.~\ref{fig:figures/avMultiplicityCleanedFirstT}. In both distributions, the removal of the first bunch crossing leads to a significant equalization between the levels for bx$\ll$0 and bx$\gg$0. The spikes in the distributions of Fig.~\ref{fig:figures/chargeFirstAndOtherInTrain} are coming from the the strip charge saturation, which appears when charge on one or multiple strip exceed 254 ADC.

%TODO cluster charge for the first event in train
   \insertFigure{figures/chargeFirstAndOtherInTrain} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {The normalized distribution of the cluster charge from the first~(pink) and the other~(blue) bunch crossing in the train for run 273162.} 
%In both distributions, the two peaks around 50~ADC and 200~ADC correspond to the MPV of off-track and on-track clusters, respectively. } % Caption
%TODO cluster charge distribution for other eventsin the train
    \insertTwoFigures{figures/avMultiplicityCleanedFirstT}
                 {figures/avMultiplicityCleanedFirst} % Filename = label
                 {figures/maxChargeCleanedFirst} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {The averaged cluster multiplicity (left) and maximal cluster charge (right) as a function of the bunch crossing number for run 273162. The bunch crossing of the selected HIP event is translated to the position bx=0. The events from the first bunch crossing in the train are not included in this distribution. } % Caption
%TODO max cluster charge

The average dead-time for the modules of the first layer of the TOB can be estimated from the left plot of Fig.~\ref{fig:figures/avMultiplicityCleanedFirstT}. The dead-time, in this case defined as the time interval between the selected HIP event and the full recovery of the average cluster multiplicity, appears to be around 250~ns~(10~bx). This dead-time is approximate as no tracking on these data was performed and thus the hit efficiency cannot be accessed. The recovery of the cluster multiplicity does not imply the full recovery of the charge collection. For this purpose the maximal cluster charge distribution as a function of bunch crossing is studied in the right plot of Fig.~\ref{fig:figures/avMultiplicityCleanedFirstT}. It is expected that the cluster charge drops after the HIP event and then it recovers in the following bunch crossings. But the cluster charge seems to be recovered almost immediately and no obvious trend is observed. This effect is most probably caused by the mixing of real and fake clusters, i.e. clusters respectively associated and not associated with the tracks. This mixing could be reduced by using on-track clusters only.

The fraction of HIP events averaged per APV in the first layer of the TOB, defined by Eq.~\ref{eq:HIPfrac}, was estimated to be 4$\times 10^{-3}$. This fraction is dependent on the run instantaneous luminosity and therefore does not represent the probability of a HIP event as defined in Eq.~\ref{eq:HIPprob2}. To estimate the HIP probability, the average number of reconstructed tracks per event per APV must be known. But even with the number of tracks it is not straightforward to compute the probability of the HIP event due to the limitations of the selection and data. The average fraction of HIP events is biased by the used trigger which forbids to record the second and third bunch crossings in the train, due to the first trigger rule. The HIP interactions, occurring in the first bunch crossing and fully suppressing the baseline only in the second and/or third bunch crossing of the train, are therefore never selected. In contrary in the events which are not at the beginning of the train, the HIP events coming from more previous bunch crossings can be selected as the baseline can saturate for more bunch crossings.
 

\subsubsection{Limitations of the study~\label{sec:limitationsSelection}}

Several limitations of the presented study have already been discussed in the text above. In summary, to the mentioned limitations belongs firstly the different fraction of out-of-time pileup in different events, what has been solved by removing the events from the first bunch crossing in the train from the clusters charge and width distributions. Secondly no tracking in data is performed, and both real and fake clusters are thus used in this analysis. If tracking would be itroruced, the majority of fake clusters would be removed, but the statistics would be largely reduced because of the track reconstruction criteria and no data from the pixel tracker. Thirdly the fraction of real and fake clusters can change as a result of the HIP event. Fourthly there is also an empty window in the triggered events caused by the first trigger rule.

%TODO did I miss something from the limitations?

A large limitation of this study comes from the ambiguity in the selection of the HIP events. It can be understood by looking at Fig.~\ref{fig:figures/RMSrawVSbx} which shows the $\sigma_{raw}$ per APV as a function of the bunch crossing number, with bx=0 being the selected HIP event. In the bottom-right part of the plot, there is a large population of APVs with $\sigma_{raw}$<2.5 for bx>0, corresponding to very large energy depositions keeping the baseline fully suppressed for several bunch crossings. Due to this uncertainty, it is impossible to determine the exact time of the HIP interaction in the sensor and therefore all distributions shown above with the selected HIP aligned to bx=0 are spread over several bunch crossings. Moreover because of this selection uncertainty, the probability of a HIP interaction cannot be computed. 

%Also because of the full baseline saturation druning more bx the fraction of HIP events, when using selection on fully suppressed beaselines, is lower during the first few events in the train than for the rest of train.

A possible improvement of the HIP selection was investigated by trying to define selection criteria on the clusters. A first tentative was to select large charge deposits by tagging the saturated clusters with an ADC value of at least one channel larger than 254 ADC. Fig.~\ref{fig:figures/fractionOfSaturatedClusters} shows the fraction of saturated clusters with respect to all clusters per APV as a function of bunch crossing, where bx=0 corresponds to the selected HIP by the criterion in Eq.~\ref{eq:selection}. The fraction of saturated clusters is significantly high only for bx=0, which is already a selected HIP event. Moreover as discussed in the left plot of Fig.~\ref{fig:figures/avMultiplicityCleanedFirstT}, the average cluster multiplicity per APV is very low for bx=0, so a requirement on the saturated cluster would only result in a large reduction of statistics. Another approach was to study the maximal cluster width per APV as a function of the bunch crossing number, shown in Fig.~\ref{fig:figures/largestClusterWidth}, but no obvious trend is observed in the distribution. 

%TODO RMS_raw vs BX
    \insertFigure{figures/RMSrawVSbx} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {The 2-D distribution of the $\sigma_{raw}$~(y-axis) as a function of the bunch crossing number~(x-axis) for run 273162. The bunch crossing of the selected HIP event is translated to the position bx=0. The limit of $\sigma_{RMS}$<2.5 is indicated by a red line. } % Caption
%TODO fractionOfSaturatedClusters
    \insertFigure{figures/fractionOfSaturatedClusters} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {The averaged fraction of saturated clusters with respect to all clusters as a function of the bunch crossing  number for run 273162. The bunch crossing of the selected HIP event is translated to the position bx=0. } % Caption
%TODO largest cluster width
    \insertFigure{figures/largestClusterWidth} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {The 2-D distribution of the average cluster width versus the bunch crossing number for run 273162. On the x-axis, the bx=0 corresponds to the bunch crossing of the selected HIP event.} % Caption

%-OOT HIP

\subsection{Change of the APV configuration settings}

In the end of 2015 and during the first half of 2016, the HIP interaction in silicon sensors under the CMS conditions was studied from many perspectives. The probability of the HIP event was found to be too low to explain the magnitude of observed inefficiencies and the CMS collaboration has thus tried to find other causes of the hit inefficiency. In August 2016, the major source was found in the settings of the APVs.

For the data taking, the APV's Preamplifier Feedback Voltage Bias~(VFP) was set according to the APV manual to around 30~V to obtain an ideal CR-RC pulse shape. This parameter controls the drain speed of the preamplifier, a lower parameter resulting in a faster drain speed. Because of the increase of the APV occupancy, due to the shortening the bunch spacing and the increasing of the instantaneous luminosity, the drain speed was not fast enough anymore, leading to the saturation of the preamplifier by semi-large charge deposits~(10-100~MIPs). The APV chip saturated by this effect became inefficient up to its recovery at the end of the train or the run. These findings led to a new setting of the VFP parameter to 0~V. Consequently the significant recovery of the hit efficiency as shown in Fig.~\ref{fig:figures/effAsLayerAndLumi} has been observed.

\newpage

\subsection{Study of the HIP events after the change of the APV settings~\label{sec:secondStudy}}

\subsubsection{Motivation of the HIP study with the modified APV settings}

After identifying and fixing the main source of APV inefficiencies, a new VR data run was scheduled. This run has provided an opportunity to study a clean HIP effect, not affected by the incorrect APV settings. The goal of the study with this data is to check if HIP events can still be observed, if they manifest in a similar way and what are the consequences of such events.

%presenteation of Erik at WGM

\subsubsection{Experimental setup}

A new VR data run 281604 of a duration of 48 minutes and 45 seconds, was taken on the 25$^{th}$ of September 2016. The subdetectors included in this run were both the silicon pixel and strip tracker, the ECAL, the HCAL and all muon chambers. This run was part of the fill 5330, during which only four isolated bunches per beam were injected into the LHC. The peak pileup of the fill was 48 interactions per bunch crossing. The instantaneous luminosity of the run was around 17$\times 10^{30} \mathrm{cm^{-2} s^{-1}}$. During the run, APVs were taking data in the deconvolution mode. 

In this run the trigger fired on the fixed bx=2306 in each orbit, further referred as the ``first event''. After the first trigger, the trigger fired every 75~ns during 450~ns. This means that per one orbit, 7 events spaced by 3 bunch crossings were thus triggered, but only the first one contained bunch collision. The trigger setup was very special as all trigger rules were violated except the first one.


The character of the run and  the data-taking setup resulted in many differences compared to the study presented in Section~\ref{sec:firstStudy}, later referred as the ``first study''. As bunches collided only during the first triggered event in a given orbit, the particle causing the HIP interaction had to originate from this bunch crossing, so in this sense, the time of the HIP occurrence is fixed. In addition, because of the fill structure with isolated bunches, there is no out-of-time pileup for the first event.

\subsubsection{Methodology}

In order to design the selection of HIP events dedicated to this run, the correlation of baseline and $\sigma_{raw}$ per APV has been analyzed. The distribution presented in Fig.~\ref{fig:figures/baselineVsRMSSecond} is very similar to the one of the Fig.~\ref{fig:figures/baselinevsRMSrawFirst} for the first study. This implies that the manifestation of the HIP events has not changed with the change of the APV settings, consequently the same HIP selection, defined in Eq.~\ref{eq:selection}, can be used. As the time associated to the creation of the particle causing the HIP event is fixed in this study by bx=2306, no redefinition of the bunch crossing position is needed and hence the properties of the selected HIP event and the other 6 events in the same orbit can be shown as function of their real bunch crossing number, respectively time.

%TODO plot baseline vs rms
%TODO figure vs RMS
    \insertFigure{figures/baselineVsRMSSecond} % Filename = label
                 {0.8}       % Width, in fraction of the whole page width
                 {The 2-D distribution of the $\sigma_{raw}$ versus the baseline for run 281604. On the x-axis there are baseline values and on the y-axis $\sigma_{raw}$ of the raw digis in the APV. } % Caption


The average baseline evolution as a function of the bunch crossing number is shown in Fig.~\ref{fig:figures/baselineSecond}. The recovery of the baseline occurs in less than 12 bunch crossings, which is a slightly faster recovery than in the first study. Here also the baseline overshoots for the remaining events in one orbit, even to a higher level than in the first study. Note that the baseline decreases between the first and second event, because not all baselines are fully suppressed yet during the first event. The study of the first occurrence of the fully suppressed baseline as a function of the bunch crossing has shown that in approximately half of the cases the baseline is already saturated in the first event, the remaining half corresponds to the second event.

%TODO baseline evolution
    \insertFigure{figures/baselineSecond} % Filename = label
                 {0.47}       % Width, in fraction of the whole page width
                 {The averaged baseline evolution as a function of the bunch crossing number for run 281604. } % Caption
 

\subsubsection{Results}

To study the cluster multiplicity and the cluster charge per APV, four categories of events are defined, as shown in Table~\ref{tab:eventCategories}. For an APV in a given orbit influenced by a HIP event, the cluster information of the firsts event belongs to the first category, while that of the remaining events to the second category. The cluster information from APVs for which no HIP event has happened during the given orbit belongs to the third category in case of the first event or to the fourth category otherwise. Thus in categories 2 and 4, only fake clusters are expected as no colliding bunches in the CMS were present at these bunch crossings, in contrary to categories 1 and 3 which are populated by both real and fake clusters.


\begin{table}[h]
\begin{center}
\begin{tabular}{|l|l|l|}
\hline
Category & Name  & Features \\
\hline
1 & HIP & Collision event when a HIP occurred \\
\hline
2 & After HIP & Event in the same orbit of a selected HIP \\
& & Not a collision event \\
& & ``Dominated'' by fake clusters \\
\hline
3 & Collision non-HIP & Collision event without any HIP \\
\hline
4 & Non-collision, non-HIP  & No HIP selected in a same orbit \\
& & Not a collision event \\
& & ``Dominated'' by fake clusters \\
\hline
\end{tabular}
\caption[Table caption text]{The four categories of clusters used for the study of run 281604. }
\label{tab:eventCategories}
\end{center}
\end{table}

The average cluster multiplicity per APV is shown in the left plot of Fig.~\ref{fig:figures/avClusterMultiplicitySecondT} both for orbits influenced by a HIP event, in triangles~(categories 1 and 2), and non-HIP orbits, in rectangles~(categories 3 and 4). The average cluster multiplicity for the first event is non-zero because of the presence of collisions and it falls then to almost zero for other events where only fake clusters are present. In the case of HIP-orbits, the average cluster multiplicity for the first event is higher than in standard case because of additional clusters originating from the HIP event. The other events exhibit also a significantly larger average multiplicity of the fake clusters compared to non-HIP orbits. The average fake cluster multiplicity is increasing in time up to a constant level and does not diminish during the 6 events, which translates to 150~ns. 

The average cluster charge shown in the left plot of Fig.~\ref{fig:figures/avClusterMultiplicitySecondT} reveals that the charge is larger for a HIP event than a standard event in the case of the collision event. This effect appears because large charge clusters can be present during the HIP event. Then in the remaining bunch crossings, standard fake clusters have a charge around 250~ADC, which is not the case for the fakes induced by the HIP event. In the latest case, the average cluster charge of fakes first drops up to $\sim$~150~ADC, and then later with time, grows even above the level of the real clusters. 


    \insertTwoFigures{figures/avClusterMultiplicitySecondT}
                 {figures/avClusterMultiplicitySecond} % Filename = label
                 {figures/avClusterChargeSecond} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {(left) The averaged cluster multiplicity as a function of the bunch crossing number for run 281604. In pink triangles is the average cluster multiplicity of the HIP event and events later while in blue squares of the non-HIP events. (right) The averaged cluster charge as a function of the bunch crossing number for run 281604. In pink triangles is the average cluster charge for the HIP and events after the HIP while in blue squares non-HIP events. } % Caption


%here the new  cluster distributions
%@MJ@ TODO some blbabla here

Distributions of the cluster charge, multiplicity and width for the four categories defined in Table~\ref{tab:eventCategories} are shown in Figs.~\ref{fig:figures/clChDist}--\ref{fig:figures/clWiDist}. The left plot of Fig.~\ref{fig:figures/clChDist} shows the cluster charge distribution. It can be noticed that the HIP events often leads to the saturation of one or more channels (spikes) and that  a large part of population has a cluster charge of 1400~ADC. These clusters are HIP clusters or they originate from baseline distortions induced by the HIP and therefore they bring a possibility to identify the HIP event as an event with an large charge cluster. But as the probability of the HIP interaction is low, studying not normalized distributions reveals, that in average more clusters with such large charge are produced in non-HIP collision events than in HIP events. Furthermore the positions of peaks at low cluster charges is different in the two distributions. This can be caused by different fraction of fake clusters, but also inefficient reconstruction of real clusters because of occurence of the HIP event. The right plot of Fig.~\ref{fig:figures/clChDist} shows the cluster charge distributions for non-collision events. It can be noticed that as mention before in average fake clusetrs after the HIP event have larger charge compared to the standard fake clusters. Also it can be observed, that large fraction of the standard fake clusters have one saturated channel. In Fig.~\ref{fig:figures/clMultDist} the cluster multiplicity for collision HIP and non-HIP events (left),  non-collision HIP and non-HIP events (right) is shown. As discussed before, in average the HIP event leads to the larger cluster multiplicity because of the HIP cluster or baseline distortions compared to the non-HIP collision events. The same applies for the fake clusters after the HIP event w.r.t. the normal fakes. The left plot of Fig.~\ref{fig:figures/clWiDist} reveals that the cluster width is in average higher and its distribution is broader for HIP events comared to the non-HIP collison events, caused by the different origin of clusters but also inefficiencies in the clustering. Again similar conclusion applies for the two distributions in righ plot of Fig.~\ref{fig:figures/clWiDist}.  

    \insertTwoFigures{figures/clChDist}
                 {figures/ChDistCollFirstBXPerModmerged} % Filename = label
                 {figures/ChDistFakeFromSecondBXPerModmerged} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 { The cluster charge distribution in run 281604 for collision HIP and non-HIP events (left), and after HIP and non-collision non-HIP events (right).   } % Caption

    \insertTwoFigures{figures/clMultDist}
                 {figures/MultDistCollFirstBXPerModmerged} % Filename = label
                 {figures/MultDistFakeFromSecondBXPerModmerged} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 { The cluster multiplicity distribution in run 281604 for collision HIP and non-HIP events (left), and after HIP and non-collision non-HIP events (right). } % Caption

    \insertTwoFigures{figures/clWiDist}
                 {figures/WiDistCollFirstBXPerModmerged} % Filename = label
                 {figures/WiDistFakeFromSecondBXPerModmerged} % Filename = label
                 {0.45}       % Width, in fraction of the whole page width
                 {  The cluster width distribution in run 281604 for collision HIP and non-HIP events (left), and after HIP and non-collision non-HIP events (right).} % Caption


\begin{table}
\begin{center}
%\topcaption{ Average cluster charge, multiplicity, width and fraction of clusters larger than ten strips.\label{tab:clusterSum}}
\resizebox{\linewidth}{!}{
\begin{tabular}{|l|cccc|}
\hline
Events/ & Average cluster  & Average cluster & Average cluster & Fraction of clusters \\
Quantities  & charge~[ADC] & multiplicity & width~[strip] & larger than 10 strips \\
\hline
HIP & 1094 & 1.254 & 8 & 0.08 \\
\hline
After HIP & 254 & 0.099 & 9 & 0.18 \\
\hline
Collision non-HIP & 426 & 0.712 & 5 & 0.05 \\
\hline
Non-collision, non-HIP & 219 & 0.002 & 4 & 0.03 \\
\hline
\end{tabular}}
\caption[Table caption text]{The average cluster charge, multiplicity and width and the fraction of clusters larger than 10 strips for four categories defined in Table~\ref{tab:eventCategories} for run 281604. These quantities are computed from both on-track and off-track clusters.}
\label{tab:clusterCategories}
\end{center}
\end{table}

To understand the properties of the fake clusters and numerically support the conclusions of the previous paragraph, the average cluster multiplicity, charge and width as well as the fraction of clusters larger than 10 strips with respect to all clusters are calculated in Table~\ref{tab:clusterCategories}. From this table it is clear that the fake clusters resulting from a HIP event are in average significantly wider and have a larger charge than the standard clusters, because they are reconstructed from baseline distortions caused by a non-uniform recovery among the 128 channels. The average multiplicity of fake clusters appearing after the HIP interaction is 29 times higher than the average multiplicity of the standard fake clusters. This can cause a problem for a tracking algorithm, which may use the fake clusters to reconstruct a track. The lower limit on the probability to have at least one fake cluster which is used to reconstruct a track, in a given time window, can be estimated by the following formula:


\eq{fakeEstimation}
{
   p_{fake} = f_{HIP}/PU_{1} \times T  \times N_{fake}/PU_{1} \times PU^2_{2} \times  \frac{\sigma_{position}}{N_{strips} \times p}  ,
}

where $f_{HIP}$ is defined in Eq.~\ref{eq:HIPfrac}, $N_{tracks~(APV)}$ is the multiplicity of tracks per APV, the time window $T$ is the number of bunch crossings in one orbit for which the fake clusters are observed, $p$ is the pitch size, $N_{strips}$ is number of strips per APV and the position resolution $\sigma_{position}$ is the estimate of the space window around the reconstructed track in which the fake cluster is close enough to be used for the track reconstruction. The $N_{fake}$ is the average fake multiplicity over the time window $T$. The PU is pileup chosen to be the fill peak pileup. The factor $(PU_{1}/PU_{2}^2)$ can transfer the results of studied run 281604 with $PU_{1}$ to different run conditions with different pileup $PU_{2}$.  

A cluster is used for the track reconstruction if it passes a certain charge threshold, which depends on the thickness of the sensor and the track inclination. Considering a normal track, the cluster charge cut for the sensors of the first layer of the TOB, which have thickness of 500~$\mu$m, is around 140~ADC in the case of the tightest cut. As shown inthe left plot of Fig.~\ref{fig:figures/avClusterMultiplicitySecondT}, in average all fake clusters pass this requirement. The values for the first layer of TOB needed for the probability estimation in Eq.~\ref{eq:fakeEstimation} are $f_{HIP} = 0.0024$, $T = 18$, $N_{fake} =0.099$. The position evolution is estimated as $\sigma_{position} = 2 \sqrt{2} 40 \mathrm{\mu m}$ taking into account cluster and alignment position resolutions which are for first layer of TOB of around 40~$\mathrm{\mu m}$ each. Inserting these values into Eq.~\ref{eq:fakeEstimation} gives the lower limit on the probability for the first layer of TOB to have at least one fake cluster originating from HIP event,  which is used to reconstruct a track. This probability has been calculated to to be $0.002\%$, which very low, but is just a lower limit as there are only 7 consecutive events and the behavior of fake clusters after these events is unknown. Moreover this probability scales with the pileup. %TODO APE, CPE and computation of fake per track, NStrips, pitch

Dropping the last term  in Eq.~\ref{eq:fakeEstimation} which describes the position window, the average multiplicity of fake clusters can be computed. To evaluate its impact, this multiplicity can be compared to the other off-track cluster multiplicites. One of them is the multiplicity of normal fake clusters originating mainly from the noise, which is determined in Table~\ref{tab:clusterCategories}. The second off-track contribution is due to OOT PU. The fraction of OOT pileup clusters in an event has been computed from the cluster multiplicity of first and other event in train of run 273162 and it has been evaluated to be to be around 50\% of all clusters of the other event in the train. Knowing this fraction, the OOT PU cluster multiplicity can be determined for run 281604. The average cluster multiplicities of these three catoegories for the first layer of TOB are shown in Table~\ref{tab:multFake}. It can be noticed, that the cluster multiplicity of normal fake clusters and fake clusters resulting from HIP event are of the same order of magnitude. However the multiplicity of clusters originating from OOT PU is around two orders of magnitude larger than the cluster multiplicity of the other two categories.  


\begin{table}[h]
\begin{center}
\begin{tabular}{|l|c|}
\hline
Off-track cluster category & average cluster multiplicity \\
\hline
Normal fakes & 0.002  \\
Fakes after HIP & 0.004  \\
OOT PU & 0.722 \\
\hline
\end{tabular}
\caption[Table caption text]{The average cluster multiplicity for three categories of off-track clusters for the first layer of TOB and run 281604. }
\label{tab:multFake}
\end{center}
\end{table}


%@MJ@ TODO some blbabla here
% pfake HIP TOBL1 = effcleaned*18*MultPOSTcleaned*resolution*100 % : pFAKE in % 0.00209707
% mult fake  TOBl1 = MultFAKEcleaned: mult normal fake 0.0022454
% mult fake HIP  TOBl1 = effcleaned*18*MultPOSTcleaned: mult HIP fake 0.00434178
% mult OOT  TOBl1 = (MultCOLLcleaned*ootf)/(1-ootf); ootf =  (0.56101-0.278453)/0.56101 (from first data) ; mult OOT 0.722259 it is the same order as coll non HIP -> these are only real clusters!

%TODO tmr - baseline recovery non uniform, show first the plot rms mult and rms  width _ correlation of fakes with rms  and then show the baseline vs rms
%about the last plot, comment shape and show examples of the baselines at different point and draw conclusion that there is a mix of population
%then aroun 128 we are around a nominal and then the rms grows again
%as the baseline higher we expect larger rms by definition (actually, eg 10% variation from the 128 is not same as from the 300, but the rms is not sensitive to relative but aboslute variations) -> the the dips plus noise can be underestimated there

The origin of the fake clusters after the HIP event can be studied in the non-collision events after the HIP. In the distributions of Fig.~\ref{fig:figures/RMSvsMULThipT}, the average cluster multiplicity and width as a function of the $\sigma_{raw}$ are shown . In the standard case, the nominal value of the $\sigma_{raw}$ is around 8~ADC. When $\sigma_{raw}$ is of 8~ADC the fake multiplicity is the lowest as shown in the left plot of Fig.~\ref{fig:figures/RMSvsMULThipT}. Compared to this point the fake cluster multiplicity is significantly increased for a $\sigma_{raw}$  around 2-5~ADC and for a $\sigma_{raw}$ larger than 10~ADC, suggesting that the distorted baselines, those with large $\sigma_{raw}$, lead to the increased mutiplicity of fake clusters. In the right plot of Fig.~\ref{fig:figures/RMSvsMULThipT} it can be noticed that the average cluster width is increasing with the $\sigma_{raw}$, but no obvious maximum around the RMS of 2-5~ADC is present. To understand the occurrence of the fake clusters, the fake cluster multiplicity can also shown as a function of baseline as done in the left plot of Fig.~\ref{fig:figures/BLvsMULThipT}. In this distribution it can be seen that after the baseline saturation the fake cluster multiplicity remains low for a while and then during the recovery the fake cluster multiplicity starts to increase up to baseline of about 0~ADC when the multiplicity falls to its minimum, which is around the baseline normality (baseline=128~ADC). After that, the baseline overshoots and the average cluster multiplicity starts to increase significantly. Here it is important to remind, that the clusters are reconstructed as in the ZS datataking, withe truncation to zero. Therefore a highly distorted baseline does not have to lead to reconstructed cluster(s) if the charges of the cluster channels do not exceed 0~ADC.  As seen in the left plot of Fig.~\ref{fig:figures/RMSvsMULThipT}, the majority of the fake clusters appear for a $\sigma_{raw}$ larger than 10, but a substantial population is also observed for the RMS of 2-5~ADC. The distribution of the $\sigma_{raw}$ as a function of the baseline in the right plot of Fig.~\ref{fig:figures/BLvsMULThipT} shows that both baselines with value of around 0~ADC and larger than 200~ADC have increased $\sigma_{raw}$ with respect to the normality. The $\sigma_{raw}$ of 2-5~ADC corresponds to the baselines between approximately -70~ADC and -20~ADC. Based on these observations, several examples of APVs with different values of $\sigma_{raw}$ and baseline are later shown in order to study behavior of the baseline which can lead to reconstruction of fake clusters.

In the five plots in Fig.~\ref{fig:figures/event3layer4downT},  Fig.~\ref{fig:figures/event31layer4down} and Fig.~\ref{fig:figures/overshootBaseline2} the evolution of raw digis, pedestal subtracted digis, baselines and clusters is shown. A first example of behavior, which can lead to the fake clusters is the distorted baseline due to the partial recovery of the saturated baseline as shown in sixth APV of the left plot of Fig.~\ref{fig:figures/event3layer4downT}. In this example, the $\sigma_{raw}$ is 4.4~ADC and the baseline value is -57~ADC for this APV. In this case the baseline distortion did not lead to the cluster reconstruction, because all pedestal subtracted digis are below zero. But once part of the pedestal subtracted digis are larger than zero, these digis can be easily reconstructed into a cluster as displayed in the right plot of  Fig.~\ref{fig:figures/event3layer4downT}. In the second APV of this module the baseline with value of -11~ADC and the $\sigma_{raw}$ of 21~ADC is distorted with two reconstructed clusters, one is the HIP cluster and second originates from the baseline distortion. The reconstructed cluster between channels 195 and 256 is also significantly larger than expected for the MIP. A last example of events with a large $\sigma_{raw}$ of 21~ADC and a low value of baseline of -66~ADC can be seen in the sixth APV of Fig.~\ref{fig:figures/event31layer4down}. In this event, a baseline distortion appears, but of a different kind, where the baseline exhibits a large dip for few strips. As shown in these examples, the baseline distortions for low baseline values can have different shapes and also different values of $\sigma_{raw}$ and thus the distribution with baseline<128~ADC of the right plot of Fig.~\ref{fig:figures/BLvsMULThipT} has non-trivial structure which cannot be straighforwardly explained. 

Another source of the fake clusters are baselines with larger than nominal values. Two examples of APVs with high baseline and $\sigma_{raw}$ values are shown in Fig.~\ref{fig:figures/overshootBaseline2}. The baselines of these APVs are not only sloping but it can be noticed that they are also distorted by dips. These dips are not understood but they create significant distortions which can lead to the reconstruction of wide fake clusters.

%Another source of the fake clusters are baselines with larger than nominal values. These baselines have naturally higher $\sigma_{raw}$ than the nominal baselines as the relative fluctuations are not expected to change. The noise, which is used to compute S/N, is an absolute value and thus it might be underestimated for the high ADC value baselines. Therefore the chance of fluctuation to be reconstructed as a cluster is incereased for this kind of baselines. Two examples of APVs with high baseline and $\sigma_{raw}$ values are shown in Fig.~\ref{fig:figures/overshootBaseline2}, where it can be noticed that these baselines are also distorted by dips and these distortions lead to the reconstruction of wide clusters.

%TODO averge cluster charge
    \insertTwoFigures{figures/RMSvsMULThipT}
                 {figures/RMSvsMULThip} % Filename = label
                 {figures/RMSvsWIhip} % Filename = label
                 {0.47}       % Width, in fraction of the whole page width
                 {(left) The averaged cluster multiplicity as a function of the $\sigma_{raw}$ of the non-collision events after the HIP for run 281604. (right) The averaged cluster width as a function of the $\sigma_{raw}$   of the non-collision events after the HIP for run 281604. } % Caption

    \insertTwoFigures{figures/BLvsMULThipT}
                 {figures/BLvsMULThip} % Filename = label
                 {figures/BLvsRMShip} % Filename = label
                 {0.47}       % Width, in fraction of the whole page width
                 {(left) The averaged cluster multiplicity as a function of the baseline  of the non-collision events after the HIP for run 281604. (right) The $\sigma_{raw}$ as a function of the baseline of the non-collision events after the HIP for run 281604. } % Caption


    \insertTwoFigures{figures/event3layer4downT}
                 {figures/event3layer4down} % Filename = label
                 {figures/event25layer4down} % Filename = label
                 {0.47}       % Width, in fraction of the whole page width
                 {(left) Example of data from one tracker module undergoing zero suppression and clustering. The raw digis are shown in pink. From the raw digis, the pedestals are subtracted and the resulting digis are shown in blue. The baselines shown in red are computed and subtracted from pedestal subtracted digis . The final clusters are shown in green. For the sixth APV the $\sigma_{raw}$ is 4.4~ADC and the baseline value is -57~ADC. (right) Example of data from one tracker module undergoing zero suppression and clustering. The raw digis are shown in pink. From the raw digis, the pedestals are subtracted and the resulting digis are shown in blue. The baselines shown in red are computed and subtracted from pedestal subtracted digis. The final clusters are shown in green. The the second APV has a baseline with value of -11~ADC and the $\sigma_{raw}$ of 21~ADC} % Caption

    \insertFigure{figures/event31layer4down} % Filename = label
                 {0.47}       % Width, in fraction of the whole page width
                 {Example of data from one tracker module undergoing zero suppression and clustering. The raw digis are shown in pink. From the raw digis, the pedestals are subtracted and the resulting digis are shown in blue. The baselines shown in red are computed and subtracted from pedestal subtracted digis. The final clusters are shown in green. The sixth APV has a $\sigma_{raw}$ of 21~ADC and a baseline value of -66~ADC.} % Caption


    \insertTwoFigures{figures/overshootBaseline2}
                 {figures/overshootBaseline} % Filename = label
                 {figures/event1layer4large} % Filename = label
                 {0.47}       % Width, in fraction of the whole page width
                 {(left) Example of data from one tracker module undergoing zero suppression and clustering. The raw digis are shown in pink. From the raw digis, the pedestals are subtracted and the resulting digis are shown in blue. The baselines shown in red are computed and subtracted from pedestal subtracted digis. The final clusters are shown in green. The fourth APV has a $\sigma_{raw}$ of 14~ADC and a baseline value of 446~ADC . (right) Example of data from one tracker module undergoing zero suppression and clustering. The raw digis are shown in pink. From the raw digis, the pedestals are subtracted and the resulting digis are shown in blue. The baselines shown in red are computed and subtracted from pedestal subtracted digis. The fourth APV has a $\sigma_{raw}$ of 21~ADC and a baseline value of 257~ADC.} % Caption


The probability of a HIP event given by Eq.~\ref{eq:HIPprob2}, is in this study estimated in average separately for each layer and wheel or ring of the silicon strip tracker.  The $f_{HIP}$ is calculated according to Eq.~\ref{eq:HIPfrac} and the the number of tracks traversing given tracker APV is computed from the simulated events. The final result can be seen in Fig.~\ref{fig:figures/probPerTrack} for the TID/TEC wheels in the left and rings in the right plot. The probability of a HIP event per track is of order of $10^{-3}-10^{-2}$, which is around an order of magnitude larger than the results provided by the HIP study at the PSI described in section~\ref{sec:ProbPast}. In case of this study, the simulated number of tracks travsersing the tracker modules does not take into account neutral particles, becuse they do not ionize the sensor and thus do not leave hits. Then the probability of the HIP event is thus increased by not taking into account all particles. Also the two analyses differ by the HIP selection and trigger conditions.

In the left plot of Fig.~\ref{fig:figures/probPerTrack} it can be observed that the probability of the HIP per track is different for different layers. Despite the large error bars caused by large spread of $f_{HIP}$ within one layer/wheel/ring, several trends in the probability can be observed. The probability increases with the module thickness as the path of the particle in thicker modules is longer. The change of probability because of the larger thickness can be typically seen when comparing TIB sensors which are 320~$\mathrm{mu m}$ thick and TOB sensors which have thickness of 500~$\mu m$. The HIP probability increases also with the module pitch, larger the pitch is, less channels read the HIP charge and thus it is easier to reach the zero-light level. In plots of Fig.~\ref{fig:figures/probPerTrack}, no clear evolution for TID and TEC wheels (left) is observed. This is caused by mixtured of mudules with different pitches and thicknesses in one wheel. On the other hand the rings are composed by the same modules and it can be noticed that the probability per ring (right) has similar evolution with ring distance from the beamline as probability for TOB. The particle flux decreases approximately only as a function of distance from the beamline, and therefore in case of same module the decrease in the HIP probaility as a function of distance from the beamline can be expected. Despite the modules are almost similar in case of TOB (change in pitch between layer 4 and 5 from 183 to 122~$\mathrm{\mu m}$ ), the HIP probability is increasing as a function of distance from beamline not decreasing. As the charged particles are bent in the magnetic field, only highly energetic charged particles reach the outer layers of tracker, what is not the case for the neutral particles. Because of this effect, the particle energy spectra as well as the ratio of charged to neutral particles change with the distance from the beamline. Specifically, the fraction of neutral to charged particles increases with the distance from beamline and as the tracking is reconstructing only charged particles, rescaling by number of tracks biases the HIP probabilty differently as a fuction of distance from the beamline. Due to this issue, the probability evolution can be opposite than expected. Furthermore, the inelastic cross section of the nuclear interaction chnages with the kind of particle and particle energy and therefore it can be also responsible for change of probability of the HIP between different layers.  


The estimation of the HIP probability, which is not sensitive to the tracking is defined in Eq.~\ref{eq:HIPprob2}. This probability is rescaled by the pileup and thus should be invariant with change of the fill structure. This probabilty can be re-computed for different filling schemes via dividing the probability by the PU of fill of run 281604 and rescaling it by PU of the fill of interest. The $f_{HIP}$ rescaled by the peak fill pileup of $48$ is shown in Fig.~\ref{fig:figures/probPerTrackPU} again for layers/wheels (left) and layers/rings (right) of TIB, TOB, TID and TEC. The probability has been evaluted to be of the order of~$10^{-6}-10^{-5}$. For the TOB, as expeted, the probability is decreasing with the distance from the beamline. This is also true for the TEC rings (right),  but on top of it there is a change between ring four and five caused by an increase in the sensor thickness from $320~\mathrm{\mu m}$ to $500~\mathrm{\mu m}$. For TID and TEC wheels (left) there is again no clear evolution because of mixture of different modules. As expetced, the probability evolution in dependence on module geometry remains similar, the increase of the probability due to the pitch size can be seen when comparing first two and second two layers of the TIB. The increase of probability with the sensor thickness can be observed when comparing the probabilities for the TIB and TOB, but also the probabilities for layer four and five of TEC. This probability rescaled by PU changes from layer to layer because of the differences in module geometry and particle composition and energy spectra, but the relative change of probability between given layers for the different fills should remain the same and therefore the mentioned rescaling by the PU should be sufficient to evaluate this probability for different filling schemes.


Moreover as previously, both computed probabilities of the HIP events can be biased by the trigger conditions. Only baselines which are already fully suppressed in the first event or which are still fully suppressed in the second event~(after 75~ns) can be selected as HIP events, what is potentially decreasing the probability.

%between tib12 and TIB23 the change between pitch
%alos the ratio between TIB tob - thickness -> I can give quantitative example
%so the main features are explained
%mixtrure of modules at TEC -> so the evolution does not work
%large error bars
%make particle explanation second order
%I am wrong with the window for which the hip can be selected
%be aware pitch-> prob -> not that teh prob of interaction itsef changes with pitch, but the chnace to saturate
%be cautious wit coparison with tob - for given nr of charge particles passing trough the tracker, this is the prob of observing a HIP _. then I can say it is not same quantity and it cannot be directly compared-> they only used pions (so even the cross section is differt)
%no tracking used -> give argument of tracking influenced by HIP

    \insertTwoFigures{figures/probPerTrack}
                 {figures/probLayerFinal} % Filename = label
                 {figures/probRingsFinal} % Filename = label
                 {0.47}       % Width, in fraction of the whole page width
                 {An average probability of the HIP event per track for layers (left, right) of TIB, TOB, wheels (left) and rings (right) of TID, TEC partitions of silicon strip tracker, computed from data run 281604.} 

%@MJ@ TODO some blbabla here

    \insertTwoFigures{figures/probPerPU}
                 {figures/probFinalLayerPU} % Filename = label
                 {figures/probFinalPURings} % Filename = label
                 {0.47}       % Width, in fraction of the whole page width
                 {An average probability of the HIP event per PU for layers (left, right) of TIB, TOB, wheels (left) and rings (right) of TID, TEC partitions of silicon strip tracker, computed from data run 281604.} 

\subsubsection{Limitations of the study}
 
In addition to the bias due to the trigger, the measurement of the number of HIP events, another limitation comes from the impossibility to perform the APV dead-time measurement with the analyzed data. Indeed, the events after the first one in the orbit do not contain collisions and thus the cluster recovery cannot be studied. Moreover the complete evolution of the average cluster charge and multiplicity cannot be studied as only 7 events in one orbit are triggered. 

\section{Conclusion}
%-in the first data hip as well because off the same selection and same order of magnitude

The large increase of hit inefficiency in the silicon strip tracker during the 2015/2016, eras Run2015D-Run2016F, has triggered deep investigations of the highly ionizing particles as a possible cause of these inefficiencies. In this chapter the VR data are used to perform a qualitative study of the HIP events as well as a quantitative estimate of the rate of these events. The initial aim of this study was to understand if the HIP event can be the main cause of the observed hit inefficiencies. Soon it was realized, that the HIP event occurrence is not sufficient to explain the inefficiencies and later the solution was found in the settings of the APV parameters. Later, new VR data-taking was scheduled, which provided an opportunity to perform the first study of the HIP events at the CMS environment, not influenced by the APV settings. Due to the data-taking conditions it is however not possible to estimate the dead-time in this data, but on the other hand the trigger conditions allowed to study the baseline distortions and the fake cluster properties in detail. With this data the probability of a HIP event defined by Eq.~\ref{eq:HIPprob2} is computed to be of order of~$10^{-3}-10^{-2}$, which is around an order of magnitude larger than the HIP probability measurement performed at the PSI beam test. The increased probability is found to be a result of different experimantal conditions of the two studies. Because of the dependecy of this probability on the tracking, second probabilty independent of tracking was designed in Eq.~\ref{eq:HIPprob3}. This probability scales with the fill pileup and is computed to be of order of~$10^{-6}-10^{-5}$. The evolution of these probabilities for different layers/wheels/rings was discussed and it was concluded that these probabilities evolve as expected. However the error bars are too large to give any definitive conclusion.

\newpage

%REMARKS
%-in my case the fraction of HIP is also eaffected by pileup?!
%-computation how fake clusters affects tracking
%-what is the inverter resistor value first it was 100 but now changes to 50~\cite{Gennai:2003as}
%-change all past to present perfec
%zero light level -laser
